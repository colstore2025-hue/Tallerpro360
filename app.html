<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nexus-X Starlink SAS | Elite TallerPRO360</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@100;300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #020617; --secondary: #0f172a; --accent: #3b82f6; 
            --gold: #f59e0b; --success: #10b981; --danger: #ef4444; --glass: rgba(255, 255, 255, 0.03);
        }
        
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: #020617; color: #f1f5f9; padding-bottom: env(safe-area-inset-bottom); overflow-x: hidden; }
        .font-nexus { font-family: 'Orbitron', sans-serif; }
        
        /* High-End UI Components */
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 32px; }
        .neo-input { background: rgba(15, 23, 42, 0.8); border: 2px solid #1e293b; border-radius: 18px; padding: 18px; color: white; transition: 0.3s; }
        .neo-input:focus { border-color: var(--accent); box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); outline: none; }
        
        .btn-nexus { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 20px; 
            font-weight: 800; text-transform: uppercase; transition: 0.3s; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 10px 25px -5px rgba(29, 78, 216, 0.4);
        }
        .btn-nexus:active { transform: scale(0.96); opacity: 0.9; }
        
        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .float-anim { animation: float 4s ease-in-out infinite; }
        .pulse-gold { animation: pulse-gold-anim 2s infinite; }
        @keyframes pulse-gold-anim { 0% { box-shadow: 0 0 0 0px rgba(245, 158, 11, 0.4); } 100% { box-shadow: 0 0 0 20px rgba(245, 158, 11, 0); } }

        /* Navigation Bar Custom */
        .nav-nexus { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; 
            height: 75px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; 
            display: flex; justify-content: space-around; align-items: center; z-index: 5000;
        }
        .nav-item { color: #64748b; font-size: 10px; font-weight: 800; text-align: center; transition: 0.3s; flex: 1; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active i { transform: translateY(-5px); color: var(--accent); text-shadow: 0 0 15px var(--accent); }

        /* Specialized Screens */
        #auth-screen, #block-screen { position: fixed; inset: 0; z-index: 9999; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; }
        .tag-trial { background: var(--gold); color: #000; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 900; }
        
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

<div id="loader-nexus" class="fixed inset-0 z-[10000] bg-slate-950 flex flex-col items-center justify-center">
    <div class="relative w-48 h-48 mb-8 float-anim">
        <div class="absolute inset-0 border-4 border-accent/20 rounded-full animate-ping"></div>
        <div class="absolute inset-4 border-2 border-gold/50 border-t-gold rounded-full animate-spin"></div>
        <i class="fas fa-satellite text-gold text-6xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
    </div>
    <h2 class="font-nexus text-2xl text-white tracking-[0.4em] italic">NEXUS-X</h2>
    <p class="text-accent text-[10px] uppercase mt-2 font-bold tracking-[0.5em]">Global Starlink Link...</p>
</div>

<div id="block-screen" class="hidden">
    <div class="glass-card p-8 w-full max-w-md text-center border-t-4 border-t-danger">
        <i class="fas fa-microchip text-danger text-6xl mb-6"></i>
        <h1 class="font-nexus text-3xl mb-4">NODO INACTIVO</h1>
        <p class="text-slate-400 mb-8 font-bold leading-relaxed">Tu licencia de 14 d√≠as ha expirado. Sincronizaci√≥n Starlink suspendida.</p>
        
        <div class="bg-slate-900/50 p-6 rounded-3xl mb-8 text-left border border-white/5">
            <p class="text-gold text-[10px] font-black uppercase mb-4 tracking-widest">Canales de Activaci√≥n</p>
            <div class="space-y-3">
                <p class="text-sm font-bold"><i class="fas fa-university mr-3 text-accent"></i>NuBank: 69000706</p>
                <p class="text-sm font-bold"><i class="fas fa-mobile-alt mr-3 text-success"></i>Nequi: 311 570 9730</p>
                <p class="text-[10px] text-slate-500 mt-2 italic">Titular: William Jeffry Urquijo</p>
            </div>
        </div>

        <button onclick="contactCEO()" class="btn-nexus w-full p-6 bg-success">
            <i class="fab fa-whatsapp text-2xl"></i> SOLICITAR ACTIVACI√ìN
        </button>
    </div>
</div>

<div id="auth-screen" class="hidden">
    <div class="w-full max-w-md">
        <div class="text-center mb-10">
            <div class="w-20 h-20 bg-accent/10 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-accent/20">
                <i class="fas fa-shield-halved text-accent text-3xl"></i>
            </div>
            <h2 class="font-nexus text-3xl tracking-tighter">NEXUS-X <span class="text-gold italic">USA</span></h2>
            <p class="text-slate-500 font-bold text-[10px] tracking-[0.3em] uppercase mt-2">Logistics Technology Network</p>
        </div>

        <div id="form-login" class="space-y-4">
            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-500 ml-4">Terminal ID (Email)</label>
                <input id="auth-email" type="email" placeholder="admin@taller.com" class="neo-input w-full">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-500 ml-4">Access Key</label>
                <input id="auth-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="neo-input w-full">
            </div>
            <button class="btn-nexus w-full p-6 mt-4 shadow-2xl" onclick="handleAuth('login')">
                SINCRONIZAR NODO
            </button>
            <p class="text-center text-[11px] mt-8 font-bold text-slate-500" onclick="toggleAuth()">
                ¬øSIN ACCESO? <span class="text-accent underline">SOLICITAR DEMO ELITE</span>
            </p>
        </div>

        <div id="form-reg" class="hidden space-y-4">
            <input id="reg-taller" type="text" placeholder="Nombre Comercial Taller" class="neo-input w-full">
            <input id="reg-email" type="email" placeholder="Email Administrativo" class="neo-input w-full">
            <input id="reg-pass" type="password" placeholder="Crear Llave Maestra" class="neo-input w-full">
            <div class="bg-blue-500/10 p-5 rounded-2xl text-[10px] font-bold text-blue-400 border border-blue-500/20">
                <i class="fas fa-info-circle mr-2"></i> Activaci√≥n inmediata: Acceso Full Elite por 14 d√≠as.
            </div>
            <button class="btn-nexus w-full p-6 bg-success" onclick="handleAuth('register')">DESPLEGAR NODO</button>
            <p class="text-center text-[11px] mt-8 font-bold text-slate-500" onclick="toggleAuth()">
                SISTEMA ACTIVO <span class="text-white underline">LOG IN</span>
            </p>
        </div>
    </div>
</div>

<header class="p-6 sticky top-0 z-[1000] bg-[#020617]/80 backdrop-blur-md border-b border-white/5">
    <div class="flex justify-between items-center max-w-5xl mx-auto">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-slate-800 to-slate-950 rounded-2xl flex items-center justify-center border border-white/10 shadow-xl">
                <i class="fas fa-satellite-dish text-gold animate-pulse"></i>
            </div>
            <div>
                <h1 class="font-nexus text-sm tracking-widest text-white">TallerPRO360 <span class="text-accent">Elite</span></h1>
                <p id="display-taller" class="text-[9px] font-black text-slate-500 uppercase tracking-tighter">Linking Starlink...</p>
            </div>
        </div>
        <div id="trial-badge" class="hidden">
            <span class="tag-trial" id="days-left">TRIAL: -- D√çAS</span>
        </div>
        <button onclick="signOutNow()" class="w-10 h-10 rounded-xl bg-red-500/10 text-red-500 flex items-center justify-center border border-red-500/20">
            <i class="fas fa-power-off"></i>
        </button>
    </div>
</header>

<main class="p-5 max-w-5xl mx-auto space-y-8">
    
    <section id="sec-ordenes" class="space-y-6">
        <div class="grid grid-cols-2 gap-4">
            <div class="glass-card p-6 flex flex-col items-center">
                <span class="text-[9px] text-gold font-black uppercase tracking-widest mb-2">Veh√≠culos en Nodo</span>
                <span class="text-5xl font-nexus text-white" id="count-patio">0</span>
            </div>
            <div class="glass-card p-6 flex flex-col items-center border-b-4 border-b-success">
                <span class="text-[9px] text-slate-500 font-black uppercase tracking-widest mb-2">KPI Ingresos</span>
                <span class="text-4xl font-nexus text-success">$0</span>
            </div>
        </div>

        <button id="btn-voz" class="btn-nexus w-full p-8 bg-slate-900 border-2 border-accent/30 pulse-gold">
            <i class="fas fa-microphone-alt text-3xl text-accent"></i>
            <div class="text-left">
                <p class="text-xs font-black">DICTADO IA NEXUS</p>
                <p class="text-[9px] text-slate-400">Transcripci√≥n t√©cnica avanzada</p>
            </div>
        </button>

        <div class="glass-card p-8 space-y-6">
            <div class="flex items-center gap-3 border-b border-white/5 pb-4">
                <i class="fas fa-file-signature text-gold"></i>
                <h3 class="font-nexus text-xs uppercase">Recepci√≥n de Unidad</h3>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 ml-2 uppercase">Placa Serial</label>
                    <input id="o-placa" placeholder="XYZ-000" class="neo-input w-full text-center font-nexus text-xl uppercase text-accent">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 ml-2 uppercase">A√±o Modelo</label>
                    <input id="o-modelo" type="number" placeholder="2026" class="neo-input w-full">
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[9px] font-black text-slate-500 ml-2 uppercase">Referencia de Ingenier√≠a (Marca)</label>
                <input id="o-marca" placeholder="Ej: Kenworth T800 / Toyota Prado" class="neo-input w-full">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 ml-2 uppercase">Propietario</label>
                    <input id="o-cliente" placeholder="Nombre Completo" class="neo-input w-full">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 ml-2 uppercase">WhatsApp Link</label>
                    <input id="o-tel" type="tel" placeholder="310..." class="neo-input w-full">
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[9px] font-black text-slate-500 ml-2 uppercase">Diagn√≥stico Estructural y Mec√°nico</label>
                <textarea id="o-trabajo" rows="4" placeholder="Hallazgos del t√©cnico..." class="neo-input w-full"></textarea>
            </div>

            <button class="btn-nexus w-full p-6 text-lg bg-accent" onclick="saveOrder()">
                <i class="fas fa-broadcast-tower"></i> SINCRONIZAR A RED GLOBAL
            </button>
        </div>

        <div id="lista-ordenes" class="space-y-4 pb-10">
            </div>
    </section>

    <section id="sec-passport" class="hidden space-y-6">
        <div class="glass-card p-10 text-center relative overflow-hidden">
            <div class="absolute -right-10 -top-10 text-slate-800 text-9xl opacity-20"><i class="fas fa-globe"></i></div>
            <i class="fas fa-dna text-gold text-5xl mb-6"></i>
            <h2 class="font-nexus text-2xl">GLOBAL PASSPORT</h2>
            <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mt-2">Rastreo de historial en toda la red Colombia-USA</p>
        </div>
        
        <div class="relative">
            <input id="search-placa" placeholder="BUSCAR PLACA" class="neo-input w-full text-center font-nexus text-4xl p-10 uppercase border-accent/40 border-4">
            <div class="absolute top-2 right-4 text-accent animate-pulse"><i class="fas fa-wifi text-xs"></i></div>
        </div>
        
        <button class="btn-nexus w-full p-8 bg-slate-900 border border-accent/50" onclick="searchHistory()">
            <i class="fas fa-satellite"></i> INTERROGAR BASE DE DATOS
        </button>
        
        <div id="history-result" class="space-y-4 pt-6"></div>
    </section>

    <section id="sec-admin" class="hidden space-y-6">
        <div class="glass-card border-2 border-gold/30 p-8">
            <div class="flex items-center gap-5 mb-10">
                <div class="w-20 h-20 bg-gold/10 rounded-full flex items-center justify-center border-2 border-gold/50 shadow-[0_0_30px_rgba(245,158,11,0.2)]">
                    <i class="fas fa-crown text-gold text-3xl"></i>
                </div>
                <div>
                    <h2 class="font-nexus text-2xl">GLOBAL COMMAND</h2>
                    <p class="text-[10px] text-gold font-black tracking-widest uppercase">William Master Access</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="bg-slate-900/80 p-6 rounded-3xl border border-white/5">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Nodos Conectados</p>
                    <p id="ceo-nodos" class="text-3xl font-nexus text-white">0</p>
                </div>
                <div class="bg-slate-900/80 p-6 rounded-3xl border border-white/5">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Alertas Sistema</p>
                    <p id="ceo-leads" class="text-3xl font-nexus text-accent">0</p>
                </div>
            </div>

            <h3 class="text-xs font-black uppercase mb-6 text-slate-400 flex items-center gap-2">
                <span class="w-2 h-2 bg-success rounded-full animate-ping"></span>
                Monitor de Nodos Activos
            </h3>
            <div id="ceo-user-list" class="space-y-4"></div>
        </div>
    </section>
</main>

<nav class="nav-nexus">
    <div class="nav-item active" onclick="showTab('ordenes')">
        <i class="fas fa-screwdriver-wrench text-2xl mb-1"></i><br>PATIO
    </div>
    <div class="nav-item" onclick="showTab('passport')">
        <i class="fas fa-passport text-2xl mb-1"></i><br>PASSPORT
    </div>
    <div class="nav-item" onclick="showTab('finanzas')">
        <i class="fas fa-rocket text-2xl mb-1"></i><br>UPGRADE
    </div>
    <div id="tab-admin" class="nav-item hidden" onclick="showTab('admin')">
        <i class="fas fa-crown text-2xl mb-1 text-gold"></i><br>CEO
    </div>
</nav>

<script type="module">
    // CORE LOGIC - NEXUS ENGINE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, serverTimestamp, addDoc, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let realtimeSyncActive = false;

    // --- SISTEMA DE SEGURIDAD ELITE NEXUS-X ---
window.handleAuth = async (mode) => {
    vibrate(60);
    const emailInput = mode === 'login' ? document.getElementById('auth-email').value : document.getElementById('reg-email').value;
    const passInput = mode === 'login' ? document.getElementById('auth-pass').value : document.getElementById('reg-pass').value;

    if (!emailInput || passInput.length < 6) {
        return alert("ACCESO DENEGADO: Verifique email y que la clave tenga +6 caracteres.");
    }

    const email = emailInput.toLowerCase().trim();
    const btn = event.currentTarget;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESANDO...';

    try {
        if (mode === 'register') {
            const nombreTaller = document.getElementById('reg-taller').value;
            if(!nombreTaller) throw new Error("Nombre del taller es obligatorio.");
            
            const res = await createUserWithEmailAndPassword(auth, email, passInput);
            
            // Creaci√≥n inmediata del perfil para evitar limbos
            const fechaVence = new Date();
            fechaVence.setDate(fechaVence.getDate() + 14);

            await setDoc(doc(db, "usuarios", res.user.uid), {
                nombreTaller: nombreTaller,
                email: email,
                rol: email === 'col.store2025@gmail.com' ? "CEO_RED" : "TALLER",
                status: "TRIAL_ACTIVE",
                vence: fechaVence.getTime(),
                fecha_creacion: serverTimestamp(),
                master: email === 'col.store2025@gmail.com'
            });
            console.log("Nodo registrado y perfil creado con √©xito.");
        } else {
            await signInWithEmailAndPassword(auth, email, passInput);
        }
    } catch (e) { 
        alert("NEXUS ERROR: " + e.message); 
    } finally {
        btn.disabled = false;
        btn.innerHTML = mode === 'login' ? 'SINCRONIZAR NODO' : 'DESPLEGAR NODO';
    }
};

// --- OBSERVADOR DE ESTADO (EL CEREBRO DEL SISTEMA) ---
onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('loader-nexus');
    const authScreen = document.getElementById('auth-screen');
    const blockScreen = document.getElementById('block-screen');
    const disp = document.getElementById('display-taller');
    const tabAdmin = document.getElementById('tab-admin');

    if (user) {
        const email = user.email.toLowerCase().trim();
        console.log("üì° Enlace establecido con:", email);
        
        // 1. BYPASS MAESTRO CEO (Acceso Total Incondicional)
        if (email === 'col.store2025@gmail.com') {
            disp.innerText = "NEXUS-X GLOBAL COMMAND";
            if(tabAdmin) tabAdmin.classList.remove('hidden');
            if(authScreen) authScreen.classList.add('hidden');
            if(blockScreen) blockScreen.classList.add('hidden');
            
            initRealtimeSync();
            cargarDatosCEO();
            if(loader) loader.style.display = 'none';
            return; 
        }

        // 2. VERIFICACI√ìN DE TALLERES (Nodos Est√°ndar)
        try {
            const uDoc = await getDoc(doc(db, "usuarios", user.uid));
            
            if (uDoc.exists()) {
                const data = uDoc.data();
                const hoy = new Date().getTime();
                
                // L√≥gica de Bloqueo por Pago
                if (hoy > data.vence && data.status !== 'PAID_ACTIVE') {
                    if(blockScreen) blockScreen.classList.remove('hidden');
                    if(authScreen) authScreen.classList.add('hidden');
                } else {
                    // Acceso Permitido
                    const dias = Math.ceil((data.vence - hoy) / 86400000);
                    const badge = document.getElementById('trial-badge');
                    if(badge) badge.classList.remove('hidden');
                    document.getElementById('days-left').innerText = `TRIAL: ${dias > 0 ? dias : 0} D√çAS`;
                    
                    disp.innerText = data.nombreTaller || "Nodo Activo";
                    authScreen.classList.add('hidden');
                    blockScreen.classList.add('hidden');
                    initRealtimeSync();
                }
            } else {
                // AUTO-REPAIR: Si el usuario existe en Auth pero no en Firestore
                console.warn("Perfil no encontrado. Reparando nodo...");
                const fechaVence = new Date();
                fechaVence.setDate(fechaVence.getDate() + 14);
                
                await setDoc(doc(db, "usuarios", user.uid), {
                    nombreTaller: "Nuevo Nodo Nexus",
                    email: email,
                    rol: "TALLER",
                    status: "TRIAL_ACTIVE",
                    vence: fechaVence.getTime(),
                    fecha_creacion: serverTimestamp()
                });
                location.reload(); // Recargar para aplicar cambios
            }
        } catch (error) {
            console.error("Fallo de enlace Starlink:", error);
            // Si hay error de red, permitimos ver la interfaz pero con advertencia
            disp.innerText = "MODO OFFLINE";
        }
    } else {
        // No hay sesi√≥n
        if(authScreen) authScreen.classList.remove('hidden');
        if(tabAdmin) tabAdmin.classList.add('hidden');
        if(blockScreen) blockScreen.classList.add('hidden');
    }

    if(loader) {
        setTimeout(() => { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none', 500); }, 1000);
    }
});


    // --- OPERACIONES DE TALLER ---
    window.saveOrder = async () => {
        vibrate(60);
        const btn = event.currentTarget;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> SINCRONIZANDO...';

        try {
            const orden = {
                placa: document.getElementById('o-placa').value.toUpperCase().trim(),
                marca: document.getElementById('o-marca').value,
                modelo: document.getElementById('o-modelo').value,
                cliente: document.getElementById('o-cliente').value,
                tel: document.getElementById('o-tel').value,
                trabajo: document.getElementById('o-trabajo').value,
                tallerId: auth.currentUser.uid,
                tallerNombre: document.getElementById('display-taller').innerText,
                timestamp: serverTimestamp()
            };

            if(!orden.placa) throw new Error("Placa requerida");

            await addDoc(collection(db, "ordenes"), orden);
            
            const waMsg = `*NEXUS-X LOGISTICS*%0A*REPORTE T√âCNICO*%0A%0AUnidad: ${orden.placa}%0ACliente: ${orden.cliente}%0A%0ADiagn√≥stico:%20${orden.trabajo}%0A%0A_Generado por TallerPRO360 Elite_`;
            window.open(`https://wa.me/57${orden.tel}?text=${waMsg}`, '_blank');
            
            ['o-placa','o-marca','o-modelo','o-cliente','o-tel','o-trabajo'].forEach(id => document.getElementById(id).value = "");
            alert("‚úÖ Sincronizaci√≥n Exitosa");
        } catch(e) { alert("Error: " + e.message); }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-broadcast-tower"></i> SINCRONIZAR A RED GLOBAL';
    };

    function initRealtimeSync() {
        realtimeSyncActive = true;
        const q = query(collection(db, "ordenes"), where("tallerId", "==", auth.currentUser.uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('lista-ordenes');
            list.innerHTML = "";
            document.getElementById('count-patio').innerText = snap.size;
            
            snap.forEach(doc => {
                const o = doc.data();
                const fecha = o.timestamp ? new Date(o.timestamp.toDate()).toLocaleDateString() : 'Sync...';
                list.innerHTML += `
                    <div class="glass-card p-6 flex justify-between items-center border-l-4 border-l-accent animate-fadeIn">
                        <div>
                            <h4 class="font-nexus text-xl text-white">${o.placa}</h4>
                            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">${o.cliente} | ${o.marca}</p>
                            <p class="text-[9px] text-accent mt-1"><i class="far fa-clock mr-1"></i>${fecha}</p>
                        </div>
                        <button class="w-12 h-12 rounded-2xl bg-slate-800 flex items-center justify-center text-gold border border-white/5 shadow-lg">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            });
        });
    }

    // --- GLOBAL PASSPORT SEARCH ---
    window.searchHistory = async () => {
        vibrate(40);
        const placa = document.getElementById('search-placa').value.toUpperCase().trim();
        if(!placa) return;
        
        const resDiv = document.getElementById('history-result');
        resDiv.innerHTML = '<div class="text-center p-10"><i class="fas fa-sync fa-spin text-accent text-3xl"></i><p class="mt-4 font-nexus text-[10px]">Rastreando en Red Starlink...</p></div>';

        const q = query(collection(db, "ordenes"), where("placa", "==", placa), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        
        resDiv.innerHTML = "";
        if(snap.empty) {
            resDiv.innerHTML = '<div class="glass-card p-10 text-center border-danger/30"><p class="text-danger font-bold uppercase text-xs">Sin registros previos en la red Nexus-X</p></div>';
            return;
        }

        snap.forEach(doc => {
            const o = doc.data();
            resDiv.innerHTML += `
                <div class="glass-card p-6 border border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <span class="bg-accent/20 text-accent text-[9px] font-black px-3 py-1 rounded-full uppercase italic">${o.tallerNombre}</span>
                        <span class="text-[10px] text-slate-500">${new Date(o.timestamp.toDate()).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm font-medium leading-relaxed text-slate-300">"${o.trabajo}"</p>
                </div>
            `;
        });
    }

    // --- CEO COMMAND CENTER ---
    async function cargarDatosCEO() {
        const q = query(collection(db, "usuarios"), orderBy("fecha_creacion", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('ceo-user-list');
            list.innerHTML = "";
            document.getElementById('ceo-nodos').innerText = snap.size;
            
            snap.forEach(d => {
                const u = d.data();
                const hoy = new Date().getTime();
                const exp = hoy > u.vence && u.status !== 'PAID_ACTIVE';
                
                list.innerHTML += `
                    <div class="bg-slate-900/50 p-5 rounded-3xl flex justify-between items-center border border-white/5">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center">
                                <i class="fas fa-warehouse ${exp ? 'text-danger' : 'text-success'} text-xs"></i>
                            </div>
                            <div>
                                <p class="text-[11px] font-black text-white">${u.nombreTaller}</p>
                                <p class="text-[9px] text-slate-500">${u.email}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 rounded-lg text-[8px] font-black ${exp ? 'bg-danger/20 text-danger' : 'bg-success/20 text-success'}">
                                ${exp ? 'BLOQUEADO' : 'ACTIVO'}
                            </span>
                        </div>
                    </div>
                `;
            });
        });
    }

    // --- UTILS ---
    window.showTab = (tab) => {
        vibrate(30);
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`sec-${tab}`).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };

    window.toggleAuth = () => {
        document.getElementById('form-login').classList.toggle('hidden');
        document.getElementById('form-reg').classList.toggle('hidden');
    };

    window.signOutNow = () => { if(confirm("¬øDesconectar nodo de la red?")) signOut(auth).then(() => location.reload()); };
    window.contactCEO = () => window.open(`https://wa.me/573115709730?text=Solicito%20activaci√≥n%20de%20mi%20Nodo%20Nexus-X`, '_blank');
    window.vibrate = (ms) => { if(navigator.vibrate) navigator.vibrate(ms); };

    // Voice Engine
    const btnVoz = document.getElementById('btn-voz');
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(Speech) {
        const rec = new Speech(); rec.lang = 'es-CO';
        btnVoz.onclick = () => { vibrate(40); rec.start(); btnVoz.classList.add('border-red-500','animate-pulse'); };
        rec.onresult = (e) => { 
            document.getElementById('o-trabajo').value += e.results[0][0].transcript + ". ";
            btnVoz.classList.remove('border-red-500','animate-pulse');
        };
        rec.onerror = () => btnVoz.classList.remove('border-red-500','animate-pulse');
    }
</script>
</body>
</html>
