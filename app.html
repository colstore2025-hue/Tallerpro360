<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nexus-X Starlink SAS - TallerPRO360 Elite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      --primary: #020617; --secondary: #0f172a; --accent: #3b82f6; 
      --gold: #f59e0b; --success: #10b981; --danger: #ef4444;
    }
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: var(--primary); padding-bottom: 90px; }
    .font-nexus { font-family: 'Orbitron', sans-serif; }
    
    /* Neumorfismo y Glassmorphism */
    .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
    .card-dark { background: radial-gradient(circle at top right, #1e293b, #020617); color: white; }
    
    header { background: var(--primary); border-bottom: 3px solid var(--gold); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    
    .nav-tabs { position: fixed; bottom: 0; width: 100%; display: flex; background: white; border-top: 1px solid #e2e8f0; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); }
    .tab { flex: 1; padding: 15px 0; text-align: center; font-size: 10px; font-weight: 900; color: #64748b; transition: 0.3s; cursor: pointer; }
    .tab.active { color: var(--accent); border-top: 3px solid var(--accent); background: #f8faff; }
    
    .btn-nexus { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-radius: 18px; font-weight: 800; text-transform: uppercase; transition: 0.3s; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-nexus:active { transform: scale(0.95); }

    /* Pantallas Especiales */
    #auth-screen, #block-screen { position: fixed; inset: 0; z-index: 9999; background: var(--primary); display: flex; align-items: center; justify-content: center; }
    .auth-card { background: white; width: 90%; max-width: 400px; padding: 35px; border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
    
    input, select, textarea { width: 100%; padding: 16px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 15px; font-weight: 600; font-size: 16px; }
    input:focus { border-color: var(--accent); outline: none; }
    
    .pulse { animation: pulse-animation 2s infinite; }
    @keyframes pulse-animation { 0% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.4); } 100% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } }

    .tag-trial { background: var(--gold); color: black; padding: 2px 8px; border-radius: 6px; font-size: 9px; font-weight: 900; }
  </style>
</head>
<body>

<div id="loader-nexus" class="fixed inset-0 z-[10000] bg-slate-950 flex flex-col items-center justify-center">
    <div class="relative w-40 h-40 mb-8">
        <div class="absolute inset-0 border-4 border-accent/20 rounded-full animate-ping"></div>
        <div class="absolute inset-2 border-4 border-gold border-t-transparent rounded-full animate-spin"></div>
        <i class="fas fa-satellite text-gold text-5xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
    </div>
    <h2 class="font-nexus text-white tracking-[0.3em] italic">NEXUS-X ENGINE</h2>
    <p class="text-white/40 text-[10px] uppercase mt-2 font-bold tracking-widest">Estableciendo Link Starlink...</p>
</div>

<div id="block-screen" class="hidden flex-col p-8 text-center text-white">
    <i class="fas fa-lock text-gold text-6xl mb-6"></i>
    <h1 class="font-nexus text-3xl mb-4">LICENCIA EXPIRADA</h1>
    <p class="text-slate-400 mb-8 font-bold">Tu periodo de 14 d√≠as ha finalizado. Para reactivar tu nodo Nexus-X y TallerPRO360, realiza el pago de la membres√≠a:</p>
    
    <div class="card-dark p-6 rounded-3xl border border-gold/30 mb-8 w-full text-left">
        <p class="text-gold text-xs font-black uppercase mb-2">Datos de Pago</p>
        <p class="text-sm font-bold"><i class="fas fa-university mr-2"></i>NuBank Ahorros: 69000706</p>
        <p class="text-sm font-bold"><i class="fas fa-id-card mr-2"></i>Titular: William Jeffry Urquijo</p>
        <p class="text-sm font-bold mb-4"><i class="fas fa-fingerprint mr-2"></i>CC: 79646721</p>
        <hr class="opacity-10 mb-4">
        <p class="text-sm font-bold"><i class="fas fa-mobile-alt mr-2"></i>Nequi: 311 570 9730</p>
    </div>

    <button onclick="contactCEO()" class="btn-nexus w-full p-5 bg-gold text-black hover:bg-white transition">
        <i class="fab fa-whatsapp text-xl"></i> ENVIAR SOPORTE DE PAGO
    </button>
</div>

<div id="auth-screen" class="hidden">
    <div class="auth-card">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
                <i class="fas fa-shield-alt text-primary text-2xl"></i>
            </div>
            <h2 class="font-nexus text-2xl tracking-tighter">NEXUS-X <span class="text-accent italic">USA</span></h2>
            <p class="text-slate-400 font-bold text-[10px] tracking-widest uppercase">Logistics & Tech Network</p>
        </div>

        <div id="form-login">
            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Email Corporativo</label>
            <input id="auth-email" type="email" placeholder="admin@taller.com">
            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Clave de Encriptaci√≥n</label>
            <input id="auth-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button class="btn-nexus w-full p-5 shadow-lg shadow-accent/30 mt-4" onclick="handleAuth('login')">
                INGRESAR AL SISTEMA
            </button>
            <p class="text-center text-[11px] mt-8 font-bold text-slate-400" onclick="toggleAuth()">¬øNUEVO NODO? <span class="text-accent underline">SOLICITAR DEMO 14 D√çAS</span></p>
        </div>

        <div id="form-reg" class="hidden">
            <input id="reg-taller" type="text" placeholder="Nombre del Taller">
            <input id="reg-email" type="email" placeholder="Email Admin">
            <input id="reg-pass" type="password" placeholder="Crear Contrase√±a">
            <div class="bg-blue-50 p-4 rounded-xl mb-4 text-[10px] font-bold text-blue-700 italic">
                <i class="fas fa-info-circle mr-1"></i> Recibir√°s 14 d√≠as gratis de licencia Elite tras activar tu nodo.
            </div>
            <button class="btn-nexus w-full p-5 bg-success" onclick="handleAuth('register')">ACTIVAR NODO DEMO</button>
            <p class="text-center text-[11px] mt-8 font-bold text-slate-400" onclick="toggleAuth()">YA TENGO CUENTA <span class="text-primary underline">LOG IN</span></p>
        </div>
    </div>
</div>

<header class="p-4 text-white">
    <div class="flex justify-between items-center max-w-4xl mx-auto">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center border border-white/10">
                <i class="fas fa-satellite-dish text-gold"></i>
            </div>
            <div>
                <h1 class="font-nexus text-sm tracking-widest">TallerPRO360 <span class="text-gold italic">Elite</span></h1>
                <p id="display-taller" class="text-[8px] font-black text-white/40 uppercase tracking-tighter">Conectando...</p>
            </div>
        </div>
        <div id="trial-badge" class="hidden">
            <span class="tag-trial" id="days-left">TRIAL: 14 D√çAS</span>
        </div>
        <button onclick="signOutNow()" class="opacity-50 text-xs"><i class="fas fa-power-off"></i></button>
    </div>
</header>

<main class="p-4 max-w-4xl mx-auto">
    <section id="sec-ordenes">
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="card-dark p-6 rounded-3xl flex flex-col items-center">
                <span class="text-[10px] text-gold font-bold uppercase tracking-widest mb-2">Veh√≠culos en Red</span>
                <span class="text-4xl font-nexus" id="count-patio">0</span>
            </div>
            <div class="glass p-6 rounded-3xl flex flex-col items-center">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-2">Ingresos Hoy</span>
                <span class="text-4xl font-nexus text-success">$0</span>
            </div>
        </div>

        <button id="btn-voz" class="btn-nexus w-full p-6 mb-6 bg-slate-900 border-2 border-gold/50 pulse">
            <i class="fas fa-microphone-alt text-2xl text-gold"></i> DICTADO IA NEXUS-X
        </button>

        <div class="glass p-6 rounded-[40px] shadow-sm mb-6">
            <h3 class="font-nexus text-sm mb-6 border-l-4 border-gold pl-3">RECEPCI√ìN DE VEH√çCULO</h3>
            <input id="o-id" type="hidden">
            
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] font-black">PLACA</label><input id="o-placa" placeholder="ABC-123" class="text-center font-nexus text-xl text-accent"></div>
                <div><label class="text-[10px] font-black">A√ëO</label><input id="o-modelo" type="number" placeholder="2026"></div>
            </div>

            <label class="text-[10px] font-black">REFERENCIA / MARCA</label>
            <input id="o-marca" placeholder="Ej: Kenworth T800">

            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] font-black">CLIENTE</label><input id="o-cliente" placeholder="Nombre"></div>
                <div><label class="text-[10px] font-black">WHATSAPP</label><input id="o-tel" type="tel" placeholder="310..."></div>
            </div>

            <label class="text-[10px] font-black">DIAGN√ìSTICO T√âCNICO (VOZ O TECLADO)</label>
            <textarea id="o-trabajo" rows="4" placeholder="Describa los hallazgos..."></textarea>

            <button class="btn-nexus w-full p-6 text-lg bg-success" onclick="saveOrder()">
                <i class="fas fa-cloud-upload-alt"></i> SINCRONIZAR A STARLINK
            </button>
        </div>

        <div id="lista-ordenes" class="space-y-4"></div>
    </section>

    <section id="sec-passport" class="hidden">
        <div class="card-dark p-10 rounded-[40px] text-center mb-8">
            <i class="fas fa-fingerprint text-gold text-5xl mb-4"></i>
            <h2 class="font-nexus text-2xl">GLOBAL PASSPORT</h2>
            <p class="text-xs text-white/40 uppercase font-bold tracking-widest">Historial unificado de veh√≠culos Nexus-X</p>
        </div>
        <input id="search-placa" placeholder="INGRESE PLACA" class="text-center font-nexus text-3xl p-8 border-4 border-slate-900 mb-4 uppercase">
        <button class="btn-nexus w-full p-6 bg-accent" onclick="searchHistory()">
            <i class="fas fa-search"></i> RASTREAR EN LA RED
        </button>
        <div id="history-result" class="mt-8 space-y-4"></div>
    </section>

    <section id="sec-admin" class="hidden">
        <div class="card-dark border-2 border-gold p-8 rounded-[40px] mb-6">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-16 h-16 bg-gold rounded-3xl flex items-center justify-center">
                    <i class="fas fa-crown text-primary text-2xl"></i>
                </div>
                <div>
                    <h2 class="font-nexus text-xl">COMMAND CENTER</h2>
                    <p class="text-[10px] text-gold font-bold">WILLIAM MASTER ACCESS</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-2xl">
                    <p class="text-[8px] text-white/40 uppercase font-black">Nodos Activos</p>
                    <p id="ceo-nodos" class="text-2xl font-nexus text-gold">0</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl">
                    <p class="text-[8px] text-white/40 uppercase font-black">Leads Pendientes</p>
                    <p id="ceo-leads" class="text-2xl font-nexus text-accent">0</p>
                </div>
            </div>

            <h3 class="text-xs font-black uppercase mb-4 text-white/60"><i class="fas fa-users mr-2"></i>Gesti√≥n de Clientes Red</h3>
            <div id="ceo-user-list" class="space-y-3"></div>
        </div>
    </section>
</main>

<nav class="nav-tabs">
    <div class="tab active" onclick="showTab('ordenes')"><i class="fas fa-tools text-xl mb-1"></i><br>PATIO</div>
    <div class="tab" onclick="showTab('passport')"><i class="fas fa-id-card text-xl mb-1"></i><br>PASSPORT</div>
    <div class="tab" onclick="showTab('finanzas')"><i class="fas fa-chart-line text-xl mb-1"></i><br>METRICS</div>
    <div id="tab-admin" class="tab hidden" onclick="showTab('admin')"><i class="fas fa-crown text-xl mb-1 text-gold"></i><br>CEO</div>
</nav>

<script type="module">
    // FIREBASE CORE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, serverTimestamp, addDoc, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- SISTEMA DE AUTENTICACI√ìN Y TRIAL ---
    window.handleAuth = async (mode) => {
        vibrate();
        const email = (mode === 'login' ? document.getElementById('auth-email').value : document.getElementById('reg-email').value).toLowerCase().trim();
        const pass = mode === 'login' ? document.getElementById('auth-pass').value : document.getElementById('reg-pass').value;

        try {
            if (mode === 'register') {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                const fechaHoy = new Date();
                const fechaVence = new Date();
                fechaVence.setDate(fechaHoy.getDate() + 14); // 14 d√≠as de Trial

                await setDoc(doc(db, "usuarios", res.user.uid), {
                    nombreTaller: document.getElementById('reg-taller').value,
                    email: email,
                    rol: email === 'col.store2025@gmail.com' ? "CEO_RED" : "TALLER",
                    status: "TRIAL_ACTIVE",
                    fecha_registro: serverTimestamp(),
                    vence: fechaVence.getTime(),
                    master: email === 'col.store2025@gmail.com'
                });
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
        } catch (e) { alert("ERROR NEXUS: " + e.message); }
    };

   onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('loader-nexus');
    const authScreen = document.getElementById('auth-screen');
    const blockScreen = document.getElementById('block-screen');
    const disp = document.getElementById('display-taller');
    const tabAdmin = document.getElementById('tab-admin');

    if (user) {
      const email = user.email.toLowerCase().trim();
      console.log("üì° Nodo detectado:", email);

      // --- BYPASS MAESTRO CEO (WILLIAM) ---
      if (email === 'col.store2025@gmail.com') {
        console.log("üëë Acceso Master CEO Confirmado");
        
        // Interfaz de Mando
        if(disp) disp.innerText = "NEXUS-X GLOBAL COMMAND";
        if(tabAdmin) tabAdmin.classList.remove('hidden');
        if(authScreen) authScreen.classList.add('hidden');
        if(blockScreen) blockScreen.classList.add('hidden');
        
        // Carga de Datos de Red
        try {
          initRealtimeSync();
          cargarDatosCEO();
        } catch(e) { console.error("Error en carga CEO:", e); }
        
        if(loader) loader.style.display = 'none';
        return; // Salida inmediata, el CEO no obedece reglas de trial
      }

      // --- L√ìGICA PARA TALLERES (Nodos Est√°ndar) ---
      try {
        const uDoc = await getDoc(doc(db, "usuarios", user.uid));
        
        if (uDoc.exists()) {
          const data = uDoc.data();
          const hoy = new Date().getTime();
          
          // Verificaci√≥n de Trial / Pago
          if (hoy > data.vence && data.status !== 'PAID_ACTIVE') {
            if(blockScreen) blockScreen.classList.remove('hidden');
            if(authScreen) authScreen.classList.add('hidden');
          } else {
            const diasRestantes = Math.ceil((data.vence - hoy) / (1000 * 60 * 60 * 24));
            const badge = document.getElementById('trial-badge');
            if(badge) badge.classList.remove('hidden');
            document.getElementById('days-left').innerText = `TRIAL: ${diasRestantes > 0 ? diasRestantes : 0} D√çAS`;
            
            if(disp) disp.innerText = data.nombreTaller || "Nodo Activo";
            if(authScreen) authScreen.classList.add('hidden');
            initRealtimeSync();
          }
        } else {
          console.warn("Perfil no encontrado en Firestore, reintentando...");
          // Si el usuario existe en Auth pero no en DB, lo forzamos a crearse o salir
          if(disp) disp.innerText = "Configurando Nodo...";
        }
      } catch (error) {
        console.error("Error de conexi√≥n Nexus-X:", error);
      }
    } else {
      // No hay sesi√≥n: Mostrar Login
      if(authScreen) authScreen.classList.remove('hidden');
      if(blockScreen) blockScreen.classList.add('hidden');
      if(tabAdmin) tabAdmin.classList.add('hidden');
    }

    if(loader) setTimeout(() => loader.style.display = 'none', 1000);
  });

    // --- L√ìGICA DE NEGOCIO ---
    window.saveOrder = async () => {
        vibrate();
        const orden = {
            placa: document.getElementById('o-placa').value.toUpperCase(),
            marca: document.getElementById('o-marca').value,
            modelo: document.getElementById('o-modelo').value,
            cliente: document.getElementById('o-cliente').value,
            tel: document.getElementById('o-tel').value,
            trabajo: document.getElementById('o-trabajo').value,
            tallerId: auth.currentUser.uid,
            tallerNombre: document.getElementById('display-taller').innerText,
            timestamp: serverTimestamp(),
            fechaStr: new Date().toLocaleDateString()
        };

        await addDoc(collection(db, "ordenes"), orden);
        
        // WhatsApp Link Directo
        const link = `https://wa.me/57${orden.tel}?text=NEXUS-X%20REPORT%0A%0AVeh√≠culo%20${orden.placa}%20recibido%20en%20${orden.tallerNombre}.%20Diagn√≥stico:%20${orden.trabajo}`;
        window.open(link, '_blank');
        resetForm();
    };

    function initRealtimeSync() {
        const q = query(collection(db, "ordenes"), where("tallerId", "==", auth.currentUser.uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('lista-ordenes');
            list.innerHTML = "";
            let count = 0;
            snap.forEach(d => {
                count++;
                const o = d.data();
                list.innerHTML += `
                    <div class="glass p-5 rounded-3xl border-l-[8px] border-gold flex justify-between items-center">
                        <div>
                            <b class="text-xl font-nexus text-slate-800">${o.placa}</b><br>
                            <small class="font-bold text-slate-400 uppercase">${o.cliente}</small>
                        </div>
                        <button class="bg-slate-900 text-gold p-3 rounded-xl"><i class="fas fa-eye"></i></button>
                    </div>`;
            });
            document.getElementById('count-patio').innerText = count;
        });
    }

    // --- PANEL CEO WILLIAM ---
    async function cargarDatosCEO() {
        const usersSnap = await getDocs(collection(db, "usuarios"));
        const list = document.getElementById('ceo-user-list');
        list.innerHTML = "";
        
        let nodosActivos = 0;
        usersSnap.forEach(d => {
            nodosActivos++;
            const u = d.data();
            const vencido = new Date().getTime() > u.vence;
            list.innerHTML += `
                <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center">
                    <div>
                        <p class="text-[11px] font-bold text-white">${u.nombreTaller}</p>
                        <p class="text-[9px] text-white/40">${u.email}</p>
                    </div>
                    <span class="text-[9px] font-black ${vencido ? 'text-danger' : 'text-success'}">
                        ${vencido ? 'EXPIRADO' : 'ACTIVO'}
                    </span>
                </div>`;
        });
        document.getElementById('ceo-nodos').innerText = nodosActivos;
    }

    // --- UTILIDADES ---
    window.showTab = (tab) => {
        vibrate();
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`sec-${tab}`).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };

    window.toggleAuth = () => {
        document.getElementById('form-login').classList.toggle('hidden');
        document.getElementById('form-reg').classList.toggle('hidden');
    };

    window.signOutNow = () => signOut(auth).then(() => location.reload());

    window.contactCEO = () => {
        const msg = `Hola William, realic√© el pago para reactivar mi Nodo Nexus-X. Mi correo es: ${auth.currentUser.email}`;
        window.open(`https://wa.me/573115709730?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.vibrate = () => { if(navigator.vibrate) navigator.vibrate(30); };

    // VOICE ENGINE
    const btnVoz = document.getElementById('btn-voz');
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(Speech){
        const rec = new Speech(); rec.lang = 'es-CO';
        btnVoz.onclick = () => { vibrate(); rec.start(); btnVoz.classList.add('bg-red-500'); };
        rec.onresult = (e) => { 
            document.getElementById('o-trabajo').value += e.results[0][0].transcript;
            btnVoz.classList.remove('bg-red-500');
        };
    }
</script>
</body>
</html>
