<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 | ERP Operativo PRO</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background: linear-gradient(135deg,#0f172a,#111827);
  color:#f1f5f9;
  font-family:'Inter',sans-serif;
}

.glass{
  background: rgba(15,23,42,.75);
  backdrop-filter: blur(20px);
  border-radius: 1.5rem;
  border: 1px solid rgba(255,255,255,.05);
  padding: 1.5rem;
}

.title-gradient{
  background: linear-gradient(90deg,#22c55e,#38bdf8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight:900;
}

.metric-card{
  text-align:center;
  padding:1rem;
  border-radius:1rem;
  background:rgba(255,255,255,.03);
}

.badge-status{
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}

.badge-ingreso{ background:rgba(59,130,246,.2); color:#38bdf8;}
.badge-diagnostico{ background:rgba(168,85,247,.2); color:#a855f7;}
.badge-proceso{ background:rgba(34,197,94,.2); color:#22c55e;}
.badge-listo{ background:rgba(234,179,8,.2); color:#facc15;}
.badge-entregado{ background:rgba(250,204,21,.2); color:#fde047;}
.badge-facturado{ background:rgba(244,63,94,.2); color:#f43f5e;}

input, select{
  background:#0f172a !important;
  border:1px solid rgba(255,255,255,.2) !important;
  color:#fff !important;
}

.form-control:focus{
  border-color:#22c55e !important;
  box-shadow:0 0 0 .25rem rgba(34,197,94,.3) !important;
}
</style>
</head>

<body class="p-4">

<div class="container">

<div class="text-center mb-5">
<h1 class="title-gradient">ERP Operativo PRO</h1>
<p class="text-secondary">Centro de control del taller</p>
<button id="logoutBtn" class="btn btn-sm btn-outline-light mt-2">Cerrar sesión</button>
</div>

<!-- MÉTRICAS -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="metric-card glass">
      <h6>Órdenes Activas</h6>
      <h2 id="metricOrdenes">0</h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="metric-card glass">
      <h6>Ingresos</h6>
      <h2>$<span id="metricIngresos">0</span></h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="metric-card glass">
      <h6>Pendiente</h6>
      <h2>$<span id="metricPendiente">0</span></h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="metric-card glass">
      <h6>Ticket Promedio</h6>
      <h2>$<span id="metricPromedio">0</span></h2>
    </div>
  </div>
</div>

<!-- BUSCADOR -->
<div class="glass mb-4">
<input type="text" id="buscador" class="form-control" placeholder="Buscar por placa, consecutivo o estado...">
</div>

<!-- CREAR ORDEN -->
<div class="glass mb-4">
<h5>Nueva Orden</h5>
<form id="formOrden">
<input type="text" id="placa" class="form-control mb-2" placeholder="Placa" required>
<input type="text" id="vehiculo" class="form-control mb-2" placeholder="Vehículo" required>
<input type="number" id="total" class="form-control mb-2" placeholder="Total estimado" required>
<button type="submit" class="btn btn-success w-100">Crear Orden</button>
</form>
</div>

<!-- LISTADO -->
<div class="glass">
<h5>Órdenes</h5>
<ul class="list-group bg-transparent" id="ordenesUl"></ul>
</div>

</div>

<script type="module">

import { db } from "./firebase-config.js";
import {
  collection,
  query,
  onSnapshot,
  doc,
  updateDoc,
  addDoc,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const empresaId = localStorage.getItem("empresaId");
const sucursalId = localStorage.getItem("sucursalId");

if(!empresaId || !sucursalId){
  window.location.href="login.html";
}

const estados = ["ingreso","diagnostico","proceso","listo","entregado","facturado"];

const ordenesUl = document.getElementById("ordenesUl");
const buscador = document.getElementById("buscador");

let ordenesCache = [];

/* CREAR ORDEN */

document.getElementById("formOrden").addEventListener("submit", async e=>{
  e.preventDefault();

  const placa = placaInput.value.trim();
  const vehiculo = vehiculoInput.value.trim();
  const total = parseFloat(totalInput.value);

  await addDoc(
    collection(db,"empresas",empresaId,"sucursales",sucursalId,"ordenes"),
    {
      consecutivo: Date.now(),
      placa,
      vehiculo,
      estado:"ingreso",
      total,
      pagado:0,
      saldo:total,
      fechaIngreso:new Date()
    }
  );

  hablar("Orden creada");
  e.target.reset();
});

/* ESCUCHAR ORDENES */

function escucharOrdenes(){

  const q = query(
    collection(db,"empresas",empresaId,"sucursales",sucursalId,"ordenes"),
    orderBy("fechaIngreso","desc")
  );

  onSnapshot(q,(snapshot)=>{

    ordenesCache = [];

    let totalIngresos=0;
    let totalPendiente=0;

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      data.id = docSnap.id;
      ordenesCache.push(data);
      totalIngresos += data.pagado || 0;
      totalPendiente += data.saldo || 0;
    });

    renderOrdenes(ordenesCache);

    document.getElementById("metricOrdenes").textContent = ordenesCache.length;
    document.getElementById("metricIngresos").textContent = totalIngresos.toLocaleString();
    document.getElementById("metricPendiente").textContent = totalPendiente.toLocaleString();
    document.getElementById("metricPromedio").textContent =
      ordenesCache.length ? (totalIngresos/ordenesCache.length).toFixed(0) : 0;

  });
}

/* RENDER */

function renderOrdenes(lista){

  ordenesUl.innerHTML="";

  lista.forEach(data=>{

    let badgeClass = "badge-"+data.estado;

    const li = document.createElement("li");
    li.className="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center";

    li.innerHTML=`
      <div>
        <strong>#${data.consecutivo}</strong> · ${data.placa} - ${data.vehiculo}
        <br>
        Total: $${data.total} | Pagado: $${data.pagado} | Saldo: $${data.saldo}
      </div>
      <div>
        <span class="badge-status ${badgeClass}">${data.estado}</span>
        <button class="btn btn-sm btn-outline-light ms-2">Estado</button>
        <button class="btn btn-sm btn-success ms-2">Pago</button>
      </div>
    `;

    /* CAMBIAR ESTADO */
    li.querySelector(".btn-outline-light").addEventListener("click", async ()=>{

      let index = estados.indexOf(data.estado);
      let nuevoEstado = estados[(index+1) % estados.length];

      await updateDoc(
        doc(db,"empresas",empresaId,"sucursales",sucursalId,"ordenes",data.id),
        { estado:nuevoEstado }
      );

      hablar("Estado actualizado");

    });

    /* REGISTRAR PAGO */
    li.querySelector(".btn-success").addEventListener("click", async ()=>{

      const monto = prompt("Ingrese valor recibido:");
      if(!monto) return;

      const nuevoPagado = (data.pagado||0) + parseFloat(monto);
      const nuevoSaldo = data.total - nuevoPagado;

      await updateDoc(
        doc(db,"empresas",empresaId,"sucursales",sucursalId,"ordenes",data.id),
        {
          pagado:nuevoPagado,
          saldo:nuevoSaldo
        }
      );

      hablar("Pago registrado");

    });

    ordenesUl.appendChild(li);

  });

}

/* BUSCADOR */

buscador.addEventListener("input", e=>{
  const texto = e.target.value.toLowerCase();
  const filtradas = ordenesCache.filter(o=>
    o.placa.toLowerCase().includes(texto) ||
    String(o.consecutivo).includes(texto) ||
    o.estado.toLowerCase().includes(texto)
  );
  renderOrdenes(filtradas);
});

/* VOZ */

function hablar(texto){
  const voz = new SpeechSynthesisUtterance(texto);
  voz.lang="es-ES";
  speechSynthesis.speak(voz);
}

escucharOrdenes();

</script>
</body>
</html>