<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 | ERP Operativo PRO</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  background: linear-gradient(135deg,#0f172a,#111827);
  color:#f1f5f9;
  font-family:'Inter',sans-serif;
}
.glass{
  background: rgba(15,23,42,.85);
  backdrop-filter: blur(18px);
  border-radius: 1.5rem;
  border:1px solid rgba(255,255,255,.1);
  padding: 1.5rem;
  margin-bottom:1.2rem;
}
.badge-status{
  padding:6px 14px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}
input, select, textarea{
  background:#0f172a !important;
  border:1px solid rgba(255,255,255,.25) !important;
  color:#fff !important;
}
input::placeholder, textarea::placeholder{
  color:#cbd5e1 !important;
}
.btn-pro{
  background:#22c55e;
  border:none;
  color:#111;
  font-weight:600;
}
.btn-pro:hover{
  background:#16a34a;
  color:#fff;
}
</style>
</head>
<body class="p-3">

<div class="container">

  <h1 class="text-center mb-4">ERP Operativo PRO - TallerPRO360</h1>

  <!-- MÉTRICAS -->
  <div class="row mb-4" id="dashboard-metrics"></div>

  <!-- FORMULARIO ORDEN -->
  <div class="glass">
    <h5 class="mb-3">Registrar Nueva Orden</h5>
    <form id="formOrden">

      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="text-white">Nombre del cliente</label>
          <input type="text" id="clienteNombre" class="form-control" placeholder="Ej: Juan Pérez" required>
        </div>

        <div class="col-md-6 mb-2">
          <label class="text-white">Teléfono</label>
          <input type="text" id="clienteTelefono" class="form-control" placeholder="Ej: 3101234567" required>
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Placa del vehículo</label>
          <input type="text" id="placa" class="form-control" placeholder="Ej: ABC123" required>
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Modelo</label>
          <input type="text" id="vehiculoModelo" class="form-control" placeholder="Ej: Toyota Corolla" required>
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Color</label>
          <input type="text" id="vehiculoColor" class="form-control" placeholder="Ej: Rojo">
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Año</label>
          <input type="number" id="vehiculoAno" class="form-control" placeholder="Ej: 2021">
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Técnico asignado</label>
          <input type="text" id="tecnicoAsignado" class="form-control" placeholder="Ej: Carlos / Maria">
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Repuestos (separados por coma)</label>
          <input type="text" id="repuestos" class="form-control" placeholder="Ej: Filtro, Aceite">
        </div>

        <div class="col-md-6 mb-2">
          <label class="text-white">Total estimado</label>
          <input type="number" id="total" class="form-control" placeholder="Ej: 250000" required>
        </div>

      </div>

      <button class="btn btn-pro w-100 mt-3">Registrar Orden</button>

    </form>
  </div>

  <!-- BUSCADOR -->
  <div class="glass">
    <input type="text" id="buscador" class="form-control" placeholder="Buscar por cliente, placa, técnico o estado">
  </div>

  <!-- LISTA ORDENES -->
  <div class="glass">
    <h5>Órdenes Operativas</h5>
    <ul class="list-group bg-transparent" id="ordenesUl"></ul>
  </div>

</div>

<script type="module">

import { 
  getFirestore, collection, addDoc, getDocs, 
  doc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const db = getFirestore();
const auth = getAuth();

const empresaId = localStorage.getItem("empresaId");

let ordenes = [];

// =========================
// CARGAR ÓRDENES REALES
// =========================
async function cargarOrdenes() {
  ordenes = [];

  const snapshot = await getDocs(
    collection(db, "empresas", empresaId, "ordenes")
  );

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    ordenes.push({
      id: docSnap.id,
      ...data
    });
  });

  renderOrdenes(ordenes);
  renderMetrics();
}

// =========================
// MÉTRICAS
// =========================
function renderMetrics(){
  const activas = ordenes.filter(o=>o.estado !== "entregado" && o.estado !== "facturado").length;
  const ingresos = ordenes.reduce((acc,o)=>acc+(o.pagado || 0),0);
  const pendientes = ordenes.reduce((acc,o)=>acc+((o.totalOrden || 0)-(o.pagado || 0)),0);
  const promedio = ordenes.length ? Math.floor(ingresos/ordenes.length) : 0;

  document.getElementById("dashboard-metrics").innerHTML = `
    <div class="col-md-3"><div class="metric-card glass"><h6>Órdenes Activas</h6><h2>${activas}</h2></div></div>
    <div class="col-md-3"><div class="metric-card glass"><h6>Ingresos</h6><h2>$${ingresos.toLocaleString()}</h2></div></div>
    <div class="col-md-3"><div class="metric-card glass"><h6>Pendientes</h6><h2>$${pendientes.toLocaleString()}</h2></div></div>
    <div class="col-md-3"><div class="metric-card glass"><h6>Ticket Promedio</h6><h2>$${promedio.toLocaleString()}</h2></div></div>
  `;
}

// =========================
// CREAR ORDEN REAL
// =========================
document.getElementById("formOrden").addEventListener("submit", async e=>{
  e.preventDefault();

  const clienteNombre = document.getElementById("clienteNombre").value.trim();
  const clienteTelefono = document.getElementById("clienteTelefono").value.trim();
  const placa = document.getElementById("placa").value.trim();
  const modelo = document.getElementById("vehiculoModelo").value.trim();
  const total = parseFloat(document.getElementById("total").value);

  const nuevaOrden = {
    clienteNombre,
    clienteTelefono,
    placa,
    vehiculo: modelo,
    totalOrden: total,
    pagado: 0,
    estado: "en_proceso",
    usuarioId: auth.currentUser.uid,
    creadoEn: serverTimestamp()
  };

  await addDoc(
    collection(db, "empresas", empresaId, "ordenes"),
    nuevaOrden
  );

  e.target.reset();
  await cargarOrdenes();
});

// =========================
// RENDER ÓRDENES
// =========================
function renderOrdenes(list){
  const ul = document.getElementById("ordenesUl");
  ul.innerHTML="";

  list.forEach(o=>{
    const li = document.createElement("li");
    li.className="list-group-item bg-transparent text-white mb-2 p-3";

    li.innerHTML = `
      <strong>${o.placa}</strong> - ${o.vehiculo}<br>
      Cliente: ${o.clienteNombre}<br>
      Estado: ${o.estado}<br>
      Total: $${(o.totalOrden || 0).toLocaleString()}
    `;

    ul.appendChild(li);
  });
}

// =========================
// INIT
// =========================
cargarOrdenes();

</script>

</body>
</html>
