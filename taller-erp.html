<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 | ERP Operativo PRO</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  background: linear-gradient(135deg,#0f172a,#111827);
  color:#f1f5f9;
  font-family:'Inter',sans-serif;
}
.glass{
  background: rgba(15,23,42,.85);
  backdrop-filter: blur(18px);
  border-radius: 1.5rem;
  border:1px solid rgba(255,255,255,.1);
  padding: 1.5rem;
  margin-bottom:1.2rem;
}
.badge-status{
  padding:6px 14px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}
input, select, textarea{
  background:#0f172a !important;
  border:1px solid rgba(255,255,255,.25) !important;
  color:#fff !important;
}
input::placeholder, textarea::placeholder{
  color:#cbd5e1 !important;
}
.btn-pro{
  background:#22c55e;
  border:none;
  color:#111;
  font-weight:600;
}
.btn-pro:hover{
  background:#16a34a;
  color:#fff;
}
</style>
</head>
<body class="p-3">

<div class="container">

  <h1 class="text-center mb-4">ERP Operativo PRO - TallerPRO360</h1>

  <!-- MÉTRICAS -->
  <div class="row mb-4" id="dashboard-metrics"></div>

  <!-- FORMULARIO ORDEN -->
  <div class="glass">
    <h5 class="mb-3">Registrar Nueva Orden</h5>
    <form id="formOrden">

      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="text-white">Nombre del cliente</label>
          <input type="text" id="clienteNombre" class="form-control" placeholder="Ej: Juan Pérez" required>
        </div>

        <div class="col-md-6 mb-2">
          <label class="text-white">Teléfono</label>
          <input type="text" id="clienteTelefono" class="form-control" placeholder="Ej: 3101234567" required>
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Placa del vehículo</label>
          <input type="text" id="placa" class="form-control" placeholder="Ej: ABC123" required>
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Modelo</label>
          <input type="text" id="vehiculoModelo" class="form-control" placeholder="Ej: Toyota Corolla" required>
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Color</label>
          <input type="text" id="vehiculoColor" class="form-control" placeholder="Ej: Rojo">
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Año</label>
          <input type="number" id="vehiculoAno" class="form-control" placeholder="Ej: 2021">
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Técnico asignado</label>
          <input type="text" id="tecnicoAsignado" class="form-control" placeholder="Ej: Carlos / Maria">
        </div>

        <div class="col-md-4 mb-2">
          <label class="text-white">Repuestos (separados por coma)</label>
          <input type="text" id="repuestos" class="form-control" placeholder="Ej: Filtro, Aceite">
        </div>

        <div class="col-md-6 mb-2">
          <label class="text-white">Total estimado</label>
          <input type="number" id="total" class="form-control" placeholder="Ej: 250000" required>
        </div>

      </div>

      <button class="btn btn-pro w-100 mt-3">Registrar Orden</button>

    </form>
  </div>

  <!-- BUSCADOR -->
  <div class="glass">
    <input type="text" id="buscador" class="form-control" placeholder="Buscar por cliente, placa, técnico o estado">
  </div>

  <!-- LISTA ORDENES -->
  <div class="glass">
    <h5>Órdenes Operativas</h5>
    <ul class="list-group bg-transparent" id="ordenesUl"></ul>
  </div>

</div>

<script>
// ================= MOCK DATA + ESTRUCTURA =================
const estados = ["ingreso","diagnostico","proceso","listo","entregado","facturado"];
let ordenes = [
  {
    id:1, consecutivo:101,
    cliente:{nombre:"Juan Pérez",telefono:"3110000001"},
    vehiculo:{placa:"ABC123",modelo:"Chevrolet Spark",color:"Blanco",ano:2019},
    tecnico:["Carlos"],
    repuestos: ["Filtro aceite"],
    estado:"ingreso",
    total:500000, pagado:200000, saldo:300000,
    historialEstados:[{estado:"ingreso",fecha:new Date(),notas:"Ingreso inicial"}],
    historialPagos:[{monto:200000,fecha:new Date()}],
    historialRepuestos:[{repuesto:"Filtro aceite",fecha:new Date()}]
  }
];

let consecutivoCounter = 102;

// ================= MÉTRICAS =================
function renderMetrics(){
  const activas = ordenes.filter(o=>o.estado!=="entregado" && o.estado!=="facturado").length;
  const ingresos = ordenes.reduce((acc,o)=>acc+o.pagado,0);
  const pendientes = ordenes.reduce((acc,o)=>acc+o.saldo,0);
  const promedio = ordenes.length ? Math.floor(ingresos/ordenes.length) : 0;

  document.getElementById("dashboard-metrics").innerHTML = `
    <div class="col-md-3"><div class="metric-card glass"><h6>Órdenes Activas</h6><h2>${activas}</h2></div></div>
    <div class="col-md-3"><div class="metric-card glass"><h6>Ingresos</h6><h2>$${ingresos.toLocaleString()}</h2></div></div>
    <div class="col-md-3"><div class="metric-card glass"><h6>Pendientes</h6><h2>$${pendientes.toLocaleString()}</h2></div></div>
    <div class="col-md-3"><div class="metric-card glass"><h6>Ticket Promedio</h6><h2>$${promedio.toLocaleString()}</h2></div></div>
  `;
}

// ================= CREAR ORDEN =================
document.getElementById("formOrden").addEventListener("submit",e=>{
  e.preventDefault();

  const clienteNombre = document.getElementById("clienteNombre").value.trim();
  const clienteTelefono = document.getElementById("clienteTelefono").value.trim();
  const placa = document.getElementById("placa").value.trim();
  const modelo = document.getElementById("vehiculoModelo").value.trim();
  const color = document.getElementById("vehiculoColor").value.trim();
  const ano = parseInt(document.getElementById("vehiculoAno").value);
  const tecnico = document.getElementById("tecnicoAsignado").value.trim().split(",").map(t=>t.trim());
  const repuestos = document.getElementById("repuestos").value.trim().split(",").map(r=>r.trim());
  const total = parseFloat(document.getElementById("total").value);

  const nueva = {
    id: ordenes.length+1,
    consecutivo: consecutivoCounter++,
    cliente:{nombre:clienteNombre,telefono:clienteTelefono},
    vehiculo:{placa,modelo,color,ano},
    tecnico, repuestos,
    estado:"ingreso",
    total, pagado:0, saldo:total,
    historialEstados:[{estado:"ingreso",fecha:new Date(),notas:"Orden creada"}],
    historialPagos:[],
    historialRepuestos: repuestos.map(r=>({repuesto:r,fecha:new Date()}))
  };

  ordenes.unshift(nueva);
  renderOrdenes(ordenes);
  renderMetrics();
  e.target.reset();
  hablar("Orden registrada correctamente");
});

// ================= RENDER ÓRDENES =================
function renderOrdenes(list){
  const ul = document.getElementById("ordenesUl");
  ul.innerHTML="";

  list.forEach(o=>{
    const badgeClass = "badge-"+o.estado;
    const li = document.createElement("li");
    li.className="list-group-item bg-transparent text-white mb-2 p-3";

    li.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>#${o.consecutivo}</strong> · ${o.cliente.nombre} (${o.cliente.telefono})<br>
          ${o.vehiculo.placa} - ${o.vehiculo.modelo} (${o.vehiculo.color}, ${o.vehiculo.ano})
        </div>
        <div><span class="badge-status ${badgeClass}">${o.estado.toUpperCase()}</span></div>
      </div>

      <div class="mt-2">
        <strong>Técnico(s):</strong> ${o.tecnico.join(", ")}<br>
        <strong>Repuestos:</strong> ${o.repuestos.join(", ")}<br>
        <strong>Total:</strong> $${o.total.toLocaleString()} | <strong>Pagado:</strong> $${o.pagado.toLocaleString()} | <strong>Saldo:</strong> $${o.saldo.toLocaleString()}
      </div>

      <div class="mt-3">
        <button class="btn btn-sm btn-outline-light me-2 btn-cambiar-estado">Cambiar Estado</button>
        <button class="btn btn-sm btn-success me-2 btn-registrar-pago">Registrar Pago</button>
        <button class="btn btn-sm btn-warning me-2 btn-agregar-repuesto">Agregar Repuesto</button>
      </div>

      <details class="mt-3 text-light bg-dark/20 p-2 rounded">
        <summary>Ver Historial</summary>
        <ul class="historial-list"></ul>
      </details>
    `;

    // HISTORIAL
    const histUl = li.querySelector(".historial-list");
    o.historialEstados.forEach(h=>{
      const hli = document.createElement("li");
      hli.textContent = `${h.estado.toUpperCase()} - ${new Date(h.fecha).toLocaleString()}: ${h.notas}`;
      histUl.appendChild(hli);
    });

    o.historialPagos.forEach(p=>{
      const hli = document.createElement("li");
      hli.textContent = `PAGO - ${new Date(p.fecha).toLocaleString()}: $${p.monto.toLocaleString()}`;
      histUl.appendChild(hli);
    });

    o.historialRepuestos.forEach(r=>{
      const hli = document.createElement("li");
      hli.textContent = `REPUESTO - ${r.repuesto} agregado ${new Date(r.fecha).toLocaleString()}`;
      histUl.appendChild(hli);
    });

    // BOTONES ACCIONES
    li.querySelector(".btn-cambiar-estado").addEventListener("click",()=>{
      let idx = estados.indexOf(o.estado);
      o.estado = estados[(idx+1)%estados.length];
      o.historialEstados.push({estado:o.estado,fecha:new Date(),notas:"Estado actualizado"});
      renderOrdenes(ordenes);
      renderMetrics();
      hablar("Estado actualizado");
    });

    li.querySelector(".btn-registrar-pago").addEventListener("click",()=>{  
      const m = parseFloat(prompt(`Saldo actual: $${o.saldo}\nIngrese valor recibido:`));
      if(!m || m <=0) return;
      o.pagado += m; o.saldo = o.total - o.pagado;
      o.historialPagos.push({monto:m,fecha:new Date()});
      renderOrdenes(ordenes);
      renderMetrics();
      hablar("Pago registrado");
    });

    li.querySelector(".btn-agregar-repuesto").addEventListener("click",()=>{
      const rep = prompt("Ingrese nombre del repuesto:");
      if(!rep) return;
      o.repuestos.push(rep);
      o.historialRepuestos.push({repuesto:rep,fecha:new Date()});
      renderOrdenes(ordenes);
      renderMetrics();
      hablar("Repuesto agregado");
    });

    ul.appendChild(li);
  });
}

// ================= BUSCADOR AVANZADO =================
document.getElementById("buscador").addEventListener("input", (e)=>{
  const txt = e.target.value.toLowerCase();
  const filtradas = ordenes.filter(o=>
    o.cliente.nombre.toLowerCase().includes(txt) ||
    o.vehiculo.placa.toLowerCase().includes(txt) ||
    o.estado.toLowerCase().includes(txt) ||
    o.tecnico.join(" ").toLowerCase().includes(txt)
  );
  renderOrdenes(filtradas);
});

// ================= VOZ =================
function hablar(texto){
  const voz = new SpeechSynthesisUtterance(texto);
  voz.lang="es-ES";
  speechSynthesis.speak(voz);
}

// ================= INIT MOCK =================
renderMetrics();
renderOrdenes(ordenes);
</script>

</body>
</html>
