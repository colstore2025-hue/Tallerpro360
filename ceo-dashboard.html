<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEO Dashboard | TallerPRO360</title>
<link rel="icon" href="logo-tallerpro360.png">

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#0f172a; font-family:'Inter',sans-serif; color:#f1f5f9; }
.font-nexus { font-family:'Orbitron',sans-serif; }
.glass { background:rgba(15,23,42,.7); backdrop-filter:blur(20px); border-radius:1.5rem; border:1px solid rgba(255,255,255,.05); }
.status-activo { color:#10b981; background:rgba(16,185,129,.1); border:1px solid rgba(16,185,129,.3); padding:2px 8px; border-radius:8px; font-size:10px; font-weight:700; }
.status-suspendido { color:#ef4444; background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.3); padding:2px 8px; border-radius:8px; font-size:10px; font-weight:700; }
#mapa { height:380px; border-radius:1rem; }
</style>
</head>

<body class="p-6">

<header class="flex justify-between items-center mb-8">
  <h1 class="text-3xl font-nexus font-black text-amber-500">
    TallerPRO360 <span class="text-white">CEO</span>
  </h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded font-bold">
    <i class="fas fa-power-off"></i> Salir
  </button>
</header>

<section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Talleres</p>
    <h2 id="kpiTalleres" class="text-4xl font-nexus text-amber-500">0</h2>
  </div>
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Activos</p>
    <h2 id="kpiActivos" class="text-4xl font-nexus text-green-500">0</h2>
  </div>
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Por vencer (â‰¤5 dÃ­as)</p>
    <h2 id="kpiVence" class="text-4xl font-nexus text-red-500">0</h2>
  </div>
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Planes activos</p>
    <h2 id="kpiPlanes" class="text-4xl font-nexus text-blue-500">0</h2>
  </div>
</section>

<section class="glass p-6 mb-8">
<table class="w-full text-sm">
<thead class="text-gray-400">
<tr>
<th>Taller</th>
<th>Ciudad</th>
<th>Plan</th>
<th>Estado</th>
<th>Vence</th>
<th class="text-right">AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</section>

<section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
  <div class="glass p-6">
    <canvas id="chartCiudades"></canvas>
  </div>
  <div class="glass p-6">
    <div id="mapa"></div>
  </div>
</section>

<footer class="text-center text-xs text-gray-500">
Â© 2026 TallerPRO360 Â· CEO Control Panel
</footer>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  doc, 
  getDoc, 
  collection, 
  onSnapshot, 
  updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let map, markers = [], chart;

// ===============================
// ðŸ” VALIDAR SESIÃ“N + ROL GLOBAL
// ===============================
onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const ref = doc(db, "usuarios", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      throw new Error("Usuario no encontrado en Firestore");
    }

    const data = snap.data();

    // âœ… NUEVO MODELO SaaS
    if (data.rolGlobal !== "superadmin") {
      window.location.href = "index.html";
      return;
    }

    console.log("Superadmin validado correctamente");

    // ðŸ”¥ VerificaciÃ³n opcional de plan global
    try {
      const response = await fetch("/api/verificar-plan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: user.uid })
      });

      if (!response.ok) {
        console.warn("Plan no vÃ¡lido o error backend");
        window.location.href = "planes.html";
        return;
      }

    } catch (error) {
      console.error("Error verificando plan:", error);
      window.location.href = "planes.html";
      return;
    }

    iniciar();

  } catch (error) {
    console.error("Error validando sesiÃ³n:", error);
    window.location.href = "index.html";
  }

});

// ===============================
function iniciar(){
  initMap();
  cargarTalleres();
}

// ===============================
function initMap(){
  map = L.map("mapa").setView([4.57,-74.29],6);

  L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom: 18 }
  ).addTo(map);
}

// ===============================
function cargarTalleres(){

  onSnapshot(collection(db,"talleres"), snap=>{

    let total=0, activos=0, vence=0, planes=0, ciudades={};

    const tbody=document.getElementById("tabla");
    tbody.innerHTML="";

    markers.forEach(m=>map.removeLayer(m));
    markers=[];

    snap.forEach(d=>{

      const t=d.data();
      total++;

      if(t.estado==="activo") activos++;
      if(t.plan) planes++;

      let fechaVence=null;

      if(t.fechaVencimiento?.toDate)
        fechaVence=t.fechaVencimiento.toDate();
      else if(t.fechaVence?.toDate)
        fechaVence=t.fechaVence.toDate();

      if(fechaVence){
        const diff=(fechaVence-new Date())/(1000*60*60*24);
        if(diff<=5) vence++;
      }

      if(t.ciudad){
        ciudades[t.ciudad]=(ciudades[t.ciudad]||0)+1;
      }

      tbody.innerHTML+=`
      <tr class="border-b border-slate-700">
        <td>${t.nombreTaller||"N/A"}</td>
        <td>${t.ciudad||"N/A"}</td>
        <td>${t.plan||"-"}</td>
        <td><span class="status-${t.estado||'activo'}">${t.estado||'activo'}</span></td>
        <td>${fechaVence?fechaVence.toLocaleDateString():"-"}</td>
        <td class="text-right">
          <button onclick="toggle('${d.id}','${t.estado||'activo'}')" 
            class="text-xs font-bold px-3 py-1 rounded bg-slate-800">
            ${t.estado==="activo"?"Suspender":"Activar"}
          </button>
        </td>
      </tr>`;

      const coords={
        "BogotÃ¡":[4.7,-74.07],
        "MedellÃ­n":[6.24,-75.58],
        "Cali":[3.45,-76.53]
      };

      const pos=coords[t.ciudad]||[4.57,-74.29];

      markers.push(
        L.circleMarker(pos,{
          radius:7,
          color:t.estado==="activo"?"#10b981":"#ef4444"
        }).addTo(map)
      );

    });

    document.getElementById("kpiTalleres").innerText=total;
    document.getElementById("kpiActivos").innerText=activos;
    document.getElementById("kpiVence").innerText=vence;
    document.getElementById("kpiPlanes").innerText=planes;

    renderChart(ciudades);

  });

}

// ===============================
window.toggle=async(id,estadoActual)=>{
  const next=estadoActual==="activo"?"suspendido":"activo";
  if(confirm(`Cambiar estado a ${next}?`)){
    await updateDoc(doc(db,"talleres",id),{estado:next});
  }
};

// ===============================
function renderChart(data){

  if(chart) chart.destroy();

  chart=new Chart(
    document.getElementById("chartCiudades"),
    {
      type:"doughnut",
      data:{
        labels:Object.keys(data),
        datasets:[{
          data:Object.values(data),
          backgroundColor:["#f59e0b","#10b981","#3b82f6","#ef4444"]
        }]
      },
      options:{
        plugins:{legend:{position:"bottom"}}
      }
    }
  );

}

// ===============================
window.logout=()=>{
  signOut(auth).then(()=>window.location.href="index.html");
};
</script>

</body>
</html>