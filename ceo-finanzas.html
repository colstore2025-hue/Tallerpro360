<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEO 路 Dashboard Financiero | TallerPRO360</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#0f172a; color:#f1f5f9; font-family:system-ui; }
.glass {
  background:rgba(15,23,42,.8);
  backdrop-filter: blur(18px);
  border-radius:1.5rem;
  border:1px solid rgba(255,255,255,.08);
}
</style>
</head>

<body class="min-h-screen p-6">

<header class="flex justify-between items-center mb-8">
  <h1 class="text-2xl font-bold text-amber-500">
     TallerPRO360 路 CEO Finanzas
  </h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded font-bold hover:bg-red-700">
    Cerrar sesi贸n
  </button>
</header>

<!-- KPIs -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 text-center">

  <div class="glass p-6">
    <p class="text-gray-400 text-sm">MRR</p>
    <h2 id="mrr" class="text-3xl font-bold text-green-400">$0</h2>
  </div>

  <div class="glass p-6">
    <p class="text-gray-400 text-sm">ARR</p>
    <h2 id="arr" class="text-3xl font-bold text-cyan-400">$0</h2>
  </div>

  <div class="glass p-6">
    <p class="text-gray-400 text-sm">ARPU</p>
    <h2 id="arpu" class="text-3xl font-bold text-amber-400">$0</h2>
  </div>

  <div class="glass p-6">
    <p class="text-gray-400 text-sm">Talleres Activos</p>
    <h2 id="activos" class="text-3xl font-bold text-emerald-400">0</h2>
  </div>

</section>

<!-- DISTRIBUCIN PLANES -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-8">

  <div class="glass p-6 text-center">
    <h3 class="mb-4 text-lg font-bold">Distribuci贸n por Plan</h3>
    <canvas id="chartPlanes"></canvas>
  </div>

  <div class="glass p-6 text-center">
    <h3 class="mb-4 text-lg font-bold">Resumen Planes</h3>
    <div class="space-y-2 text-sm">
      <p>B谩sico: <span id="basicos" class="font-bold"></span></p>
      <p>PRO Mensual: <span id="pros" class="font-bold"></span></p>
      <p>PRO Anual: <span id="proAnuales" class="font-bold"></span></p>
    </div>
  </div>

</section>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  doc,
  getDoc,
  collection,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= PRECIOS SaaS ================= */

const precios = {
  basico: 29900,
  pro: 59900,
  pro_anual: 599000 / 12
};

let chart;

/* ================= VALIDAR SUPERADMIN ================= */

onAuthStateChanged(auth, async (user)=>{

  if(!user){
    window.location.replace("index.html");
    return;
  }

  const snap = await getDoc(doc(db,"usuarios",user.uid));

  if(!snap.exists() || snap.data().rolGlobal!=="superadmin"){
    window.location.replace("index.html");
    return;
  }

  cargarMetricas();
});

/* ================= MTRICAS EN TIEMPO REAL ================= */

function cargarMetricas(){

  onSnapshot(collection(db,"talleres"), snapshot=>{

    let activos=0;
    let ingresosMensuales=0;
    let basicos=0, pros=0, proAnuales=0;

    snapshot.forEach(docSnap=>{
      const data=docSnap.data();

      if(data.estado==="activo"){
        activos++;

        if(data.plan==="basico"){
          ingresosMensuales+=precios.basico;
          basicos++;
        }

        if(data.plan==="pro"){
          ingresosMensuales+=precios.pro;
          pros++;
        }

        if(data.plan==="pro_anual"){
          ingresosMensuales+=precios.pro_anual;
          proAnuales++;
        }
      }
    });

    const arr=ingresosMensuales*12;
    const arpu=activos>0 ? ingresosMensuales/activos : 0;

    document.getElementById("activos").innerText=activos;
    document.getElementById("mrr").innerText="$"+ingresosMensuales.toLocaleString();
    document.getElementById("arr").innerText="$"+arr.toLocaleString();
    document.getElementById("arpu").innerText="$"+Math.round(arpu).toLocaleString();

    document.getElementById("basicos").innerText=basicos;
    document.getElementById("pros").innerText=pros;
    document.getElementById("proAnuales").innerText=proAnuales;

    renderChart(basicos,pros,proAnuales);
  });
}

/* ================= GRFICO ================= */

function renderChart(basicos,pros,proAnuales){

  if(chart) chart.destroy();

  chart=new Chart(
    document.getElementById("chartPlanes"),
    {
      type:"doughnut",
      data:{
        labels:["B谩sico","PRO Mensual","PRO Anual"],
        datasets:[{
          data:[basicos,pros,proAnuales],
          backgroundColor:["#3b82f6","#10b981","#f59e0b"]
        }]
      },
      options:{
        plugins:{legend:{position:"bottom"}}
      }
    }
  );
}

/* ================= LOGOUT ================= */

window.logout=()=>{
  signOut(auth).then(()=>window.location.href="index.html");
};

</script>

</body>
</html>