<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEO Dashboard | TallerPRO360</title>

<!-- Tailwind + Icons + Charts + Maps -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0f172a;font-family:'Inter',sans-serif;color:#f1f5f9}
.font-nexus{font-family:'Orbitron',sans-serif}
.glass{background:rgba(15,23,42,.7);backdrop-filter:blur(20px);border-radius:1.5rem;border:1px solid rgba(255,255,255,.05)}
.status-activo{color:#10b981;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700}
.status-suspendido{color:#ef4444;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700}
#mapa{height:380px;border-radius:1rem}
</style>
</head>

<body class="p-6">

<header class="flex justify-between items-center mb-8">
  <h1 class="text-3xl font-nexus font-black text-amber-500">
    TallerPRO360 <span class="text-white">CEO</span>
  </h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded font-bold">
    <i class="fas fa-power-off"></i> Salir
  </button>
</header>

<!-- KPIs -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Talleres</p>
    <h2 id="kpiTalleres" class="text-4xl font-nexus text-amber-500">0</h2>
  </div>
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Activos</p>
    <h2 id="kpiActivos" class="text-4xl font-nexus text-green-500">0</h2>
  </div>
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Por vencer (≤5 días)</p>
    <h2 id="kpiVence" class="text-4xl font-nexus text-red-500">0</h2>
  </div>
  <div class="glass p-6 text-center">
    <p class="text-xs uppercase text-gray-400">Planes activos</p>
    <h2 id="kpiPlanes" class="text-4xl font-nexus text-blue-500">0</h2>
  </div>
</section>

<!-- Tabla -->
<section class="glass p-6 mb-8">
<table class="w-full text-sm">
<thead class="text-gray-400">
<tr>
<th>Taller</th>
<th>Ciudad</th>
<th>Plan</th>
<th>Estado</th>
<th>Vence</th>
<th class="text-right">Acción</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</section>

<!-- Charts + Map -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
  <div class="glass p-6">
    <canvas id="chartCiudades"></canvas>
  </div>
  <div class="glass p-6">
    <div id="mapa"></div>
  </div>
</section>

<footer class="text-center text-xs text-gray-500">
© 2026 TallerPRO360 · CEO Control Panel
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let map, markers=[], chart;

onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="index.html";
  const ref = doc(db,"usuarios",user.uid);
  const snap = await getDoc(ref);
  if(!snap.exists() || snap.data().rol!=="ceo") location.href="index.html";
  iniciar();
});

function iniciar(){
  initMap();
  cargarTalleres();
}

function initMap(){
  map=L.map("mapa").setView([4.57,-74.29],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);
}

function cargarTalleres(){
  onSnapshot(collection(db,"usuarios"), snap=>{
    let total=0, activos=0, vence=0, planes=0, ciudades={};
    const tbody=document.getElementById("tabla");
    tbody.innerHTML="";
    markers.forEach(m=>map.removeLayer(m)); markers=[];

    snap.forEach(d=>{
      const u=d.data();
      if(u.rol!=="taller") return;

      total++;
      if(u.status==="activo") activos++;
      if(u.plan) planes++;

      let fechaVence=null;
      if(u.vence?.toDate) fechaVence=u.vence.toDate();
      if(fechaVence){
        const diff=(fechaVence-new Date())/(1000*60*60*24);
        if(diff<=5) vence++;
      }

      ciudades[u.ciudad]=(ciudades[u.ciudad]||0)+1;

      tbody.innerHTML+=`
      <tr class="border-b border-slate-700">
        <td>${u.nombreTaller||"N/A"}</td>
        <td>${u.ciudad||"N/A"}</td>
        <td>${u.plan||"-"}</td>
        <td><span class="status-${u.status||'activo'}">${u.status||'activo'}</span></td>
        <td>${fechaVence?fechaVence.toLocaleDateString():"-"}</td>
        <td class="text-right">
          <button onclick="toggle('${d.id}','${u.status||'activo'}')" class="text-xs font-bold px-3 py-1 rounded bg-slate-800">
            ${u.status==="activo"?"Suspender":"Activar"}
          </button>
        </td>
      </tr>`;

      const coords={Bogotá:[4.7,-74.07],Medellín:[6.24,-75.58],Cali:[3.45,-76.53]};
      const pos=coords[u.ciudad]||[4.57,-74.29];
      markers.push(L.circleMarker(pos,{radius:7,color:u.status==="activo"?"#10b981":"#ef4444"}).addTo(map));
    });

    document.getElementById("kpiTalleres").innerText=total;
    document.getElementById("kpiActivos").innerText=activos;
    document.getElementById("kpiVence").innerText=vence;
    document.getElementById("kpiPlanes").innerText=planes;
    renderChart(ciudades);
  });
}

window.toggle=async(id,status)=>{
  const next=status==="activo"?"suspendido":"activo";
  if(confirm(`Cambiar estado a ${next}?`))
    await updateDoc(doc(db,"usuarios",id),{status:next});
};

function renderChart(data){
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chartCiudades"),{
    type:"doughnut",
    data:{labels:Object.keys(data),datasets:[{data:Object.values(data),backgroundColor:["#f59e0b","#10b981","#3b82f6","#ef4444"]}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

window.logout=()=>signOut(auth).then(()=>location.href="index.html");
</script>
</body>
</html>