<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CEO GLOBAL COMMAND | Nexus-X Infrastructure</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --gold: #f59e0b; 
            --deep: #020617; 
            --slate-custom: #0f172a;
            --emerald-glow: #10b981;
            --ruby: #ef4444;
            --neon-blue: #3b82f6;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--deep); 
            color: #f1f5f9; 
            margin: 0; 
            overflow-x: hidden;
            background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0);
            background-size: 30px 30px;
        }

        .font-nexus { font-family: 'Orbitron', sans-serif; }

        /* INTERFAZ DE CRISTAL CEO */
        .glass-ceo { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(30px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .status-active { color: var(--emerald-glow); border: 1px solid rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05); }
        .status-suspended { color: var(--ruby); border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05); }

        /* ANIMACIONES Y EFECTOS */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            100% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
        }
        .radar-active { animation: pulse-gold 2s infinite; }

        .scan-line {
            width: 100%; height: 2px;
            background: rgba(245, 158, 11, 0.2);
            position: absolute; top: 0; left: 0;
            animation: scan 4s linear infinite;
            box-shadow: 0 0 15px var(--gold);
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        /* SCROLLBAR CEO */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        .chart-container { position: relative; height: 300px; width: 100%; }
        
        .btn-protocol {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .btn-protocol:hover { background: var(--gold); color: black; transform: scale(1.02); }
    </style>
</head>
<body class="p-4 lg:p-8 min-h-screen">

    <nav class="max-w-[1600px] mx-auto flex flex-col lg:flex-row justify-between items-center mb-10 gap-6 relative z-50">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-slate-950 shadow-2xl radar-active overflow-hidden relative">
                <i class="fas fa-globe text-2xl relative z-10"></i>
                <div class="absolute inset-0 bg-gold opacity-80"></div>
            </div>
            <div>
                <h1 class="font-nexus text-3xl font-black tracking-tighter">NEXUS<span class="text-gold italic">ZERO</span></h1>
                <p id="ceo-identity" class="text-[9px] text-slate-500 font-bold tracking-[0.3em] uppercase italic">Auth: Global Administrator</p>
            </div>
        </div>

        <div class="flex gap-3 bg-slate-950/50 p-2 rounded-2xl border border-white/5">
            <div class="px-6 py-2 border-r border-white/10">
                <p class="text-[8px] text-slate-500 uppercase font-bold">Estado Servidor</p>
                <p class="text-[10px] text-emerald-400 font-black uppercase tracking-tighter">ONLINE - STARLINK v3</p>
            </div>
            <div class="px-6 py-2">
                <p class="text-[8px] text-slate-500 uppercase font-bold">Fecha de Reporte</p>
                <p id="current-date" class="text-[10px] text-white font-black uppercase tracking-tighter">00/00/2026</p>
            </div>
            <button onclick="protocoloCierre()" class="w-12 h-12 flex items-center justify-center text-ruby hover:bg-ruby/20 rounded-xl transition-all">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </nav>

    <main class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">
        
        <div class="col-span-12 lg:col-span-3 space-y-6">
            <div class="glass-ceo p-8 rounded-[2rem] relative overflow-hidden group">
                <div class="scan-line"></div>
                <i class="fas fa-coins text-gold/20 text-6xl absolute -right-4 -bottom-4"></i>
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Ingreso Bruto Red</p>
                <h2 id="total-revenue" class="text-4xl font-nexus text-white">$0</h2>
                <p class="text-[9px] text-emerald-400 mt-2 font-bold uppercase italic"><i class="fas fa-chart-line mr-1"></i> +18.4% este mes</p>
            </div>

            <div class="glass-ceo p-8 rounded-[2rem]">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Puntos de Servicio</p>
                <h2 id="node-count" class="text-4xl font-nexus text-white">0</h2>
                <p class="text-[9px] text-blue-400 mt-2 font-bold uppercase italic"><i class="fas fa-satellite mr-1"></i> Nodos Activos</p>
            </div>

            <div class="glass-ceo p-8 rounded-[2rem]">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Vencimientos Críticos</p>
                <h2 id="expiring-count" class="text-4xl font-nexus text-ruby">0</h2>
                <p class="text-[9px] text-slate-500 mt-2 font-bold uppercase italic"><i class="fas fa-exclamation-triangle mr-1"></i> < 5 días de servicio</p>
            </div>

            <div class="glass-ceo p-6 rounded-[2rem]">
                <h4 class="text-[10px] font-black text-gold uppercase tracking-widest mb-6">Market Share por Ciudad</h4>
                <div class="chart-container">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-span-12 lg:col-span-9 space-y-8">
            <div class="glass-ceo rounded-[2.5rem] p-10">
                <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                    <div>
                        <h3 class="font-nexus text-2xl tracking-tighter text-white uppercase">Infraestructura Global</h3>
                        <p class="text-[9px] text-slate-500 font-bold uppercase tracking-[4px] mt-1">Monitoreo en tiempo real de terminales autorizadas</p>
                    </div>
                    <div class="flex gap-4 w-full md:w-auto">
                        <input type="text" id="node-filter" onkeyup="filtrarNodos()" placeholder="Filtrar por ID, Ciudad o Taller..." class="w-full md:w-80 bg-slate-950/80 border border-white/5 rounded-2xl py-4 px-6 text-[10px] text-white outline-none focus:border-gold">
                        <button onclick="descargarReporte()" class="px-6 bg-white text-black text-[9px] font-black uppercase rounded-2xl hover:bg-gold transition-all">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-separate border-spacing-y-3">
                        <thead>
                            <tr class="text-[9px] text-slate-500 font-black uppercase tracking-[3px] text-left">
                                <th class="px-6 pb-2 italic">Terminal ID</th>
                                <th class="px-6 pb-2 italic">Ubicación</th>
                                <th class="px-6 pb-2 italic">Productividad</th>
                                <th class="px-6 pb-2 italic text-center">Protocolo</th>
                                <th class="px-6 pb-2 italic text-right">Acción CEO</th>
                            </tr>
                        </thead>
                        <tbody id="ceo-node-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="glass-ceo p-8 rounded-[2.5rem]">
                    <h3 class="font-nexus text-xs text-gold uppercase mb-6 tracking-widest">Flujo de Producción Global</h3>
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
                <div class="glass-ceo p-8 rounded-[2.5rem]">
                    <h3 class="font-nexus text-xs text-gold uppercase mb-6 tracking-widest">Logs de Auditoría Starlink</h3>
                    <div id="audit-logs" class="space-y-4 max-h-[300px] overflow-y-auto pr-4">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
            authDomain: "tallerpro360.firebaseapp.com",
            projectId: "tallerpro360",
            storageBucket: "tallerpro360.appspot.com",
            messagingSenderId: "636224778184",
            appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let charts = {};

        // INICIO DE SESIÓN Y SEGURIDAD CEO
        onAuthStateChanged(auth, (user) => {
            if (user && (user.email === 'col.store2025@gmail.com' || user.email === 'test@tallerpro360.com')) {
                document.getElementById('current-date').innerText = new Date().toLocaleDateString();
                document.getElementById('ceo-identity').innerText = `Auth: ${user.email}`;
                iniciarSincronizacionGlobal();
            } else {
                location.href = "index.html";
            }
        });

        function iniciarSincronizacionGlobal() {
            // 1. MONITOR DE NODOS (USUARIOS)
            onSnapshot(collection(db, "usuarios"), (snap) => {
                const table = document.getElementById('ceo-node-table');
                table.innerHTML = "";
                let count = 0, critical = 0, cityStats = {};

                snap.forEach(d => {
                    const data = d.data();
                    if(data.rol === 'CEO') return;

                    count++;
                    const v = data.vence || Date.now();
                    const dias = Math.ceil((v - Date.now()) / (1000*60*60*24));
                    if(dias <= 5) critical++;

                    // Stats por ciudad
                    const city = data.ciudad || 'No Asignada';
                    cityStats[city] = (cityStats[city] || 0) + 1;

                    const statusColor = data.status === 'ACTIVO' ? 'status-active' : 'status-suspended';
                    const btnClass = data.status === 'ACTIVO' ? 'border-ruby text-ruby hover:bg-ruby hover:text-white' : 'border-emerald-500 text-emerald-500 hover:bg-emerald-500 hover:text-black';

                    table.innerHTML += `
                        <tr class="bg-slate-900/40 hover:bg-slate-800/60 transition-all group">
                            <td class="px-6 py-5 rounded-l-2xl border-l border-white/5">
                                <p class="font-bold text-white text-xs uppercase">${data.nombreTaller || 'Sede Remota'}</p>
                                <p class="text-[8px] text-slate-500 font-mono tracking-tighter">${d.id}</p>
                            </td>
                            <td class="px-6 py-5">
                                <div class="flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 bg-gold rounded-full"></span>
                                    <span class="text-[10px] text-slate-300 font-bold uppercase">${city}</span>
                                </div>
                            </td>
                            <td class="px-6 py-5">
                                <p class="text-[10px] font-nexus text-emerald-400">$${(data.facturacionAcumulada || 0).toLocaleString()}</p>
                                <p class="text-[8px] text-slate-600 font-black uppercase">Ingresos Totales</p>
                            </td>
                            <td class="px-6 py-5 text-center">
                                <span class="px-3 py-1 rounded-lg text-[8px] font-black uppercase ${statusColor}">
                                    ${data.status || 'ACTIVO'}
                                </span>
                            </td>
                            <td class="px-6 py-5 text-right rounded-r-2xl border-r border-white/5">
                                <button onclick="toggleNodo('${d.id}', '${data.status || 'ACTIVO'}')" 
                                        class="btn-protocol border px-4 py-2 rounded-xl text-[8px] font-black uppercase tracking-widest ${btnClass}">
                                    ${data.status === 'ACTIVO' ? 'SUSPENDER' : 'REINSTALAR'}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('node-count').innerText = count;
                document.getElementById('expiring-count').innerText = critical;
                updateCityChart(cityStats);
            });

            // 2. MONITOR DE TRANSACCIONES (ÓRDENES)
            const qOrders = query(collection(db, "ordenes"), orderBy("timestamp", "desc"));
            onSnapshot(qOrders, (snap) => {
                let rev = 0, chartData = { labels: [], values: [] };
                const logs = document.getElementById('audit-logs');
                logs.innerHTML = "";

                snap.forEach((o, index) => {
                    const data = o.data();
                    rev += (data.total || 0);

                    // Últimos 10 logs de auditoría
                    if(index < 10) {
                        logs.innerHTML += `
                            <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5">
                                <div>
                                    <p class="text-xs font-bold text-white">${data.placa || 'PLACA-X'}</p>
                                    <p class="text-[8px] text-slate-500 uppercase">${data.tallerId ? data.tallerId.substring(0,8) : 'Sede Global'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-nexus text-gold">+$${(data.total || 0).toLocaleString()}</p>
                                    <p class="text-[7px] text-emerald-500 font-bold italic">Sincronizado</p>
                                </div>
                            </div>
                        `;
                    }
                });
                document.getElementById('total-revenue').innerText = `$${rev.toLocaleString()}`;
                updateMainChart(snap.size);
            });
        }

        // --- FUNCIONES DE CONTROL ---

        window.toggleNodo = async (id, status) => {
            const next = status === 'ACTIVO' ? 'SUSPENDIDO' : 'ACTIVO';
            if(confirm(`ADVERTENCIA: ¿Desea cambiar el estado del nodo a ${next}?`)) {
                await updateDoc(doc(db, "usuarios", id), { status: next });
            }
        };

        function updateCityChart(stats) {
            const ctx = document.getElementById('cityChart').getContext('2d');
            if(charts.city) charts.city.destroy();
            charts.city = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats),
                    datasets: [{
                        data: Object.values(stats),
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: { 
                    cutout: '80%',
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateMainChart(total) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(charts.main) charts.main.destroy();
            charts.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['S1', 'S2', 'S3', 'S4', 'S5', 'S6'],
                    datasets: [{
                        label: 'Volumen Operativo',
                        data: [total*0.5, total*0.7, total*0.6, total*0.9, total*0.8, total],
                        borderColor: '#f59e0b',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(245, 158, 11, 0.05)'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { display: false },
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#475569', font: { size: 9 } } }
                    }
                }
            });
        }

        window.descargarReporte = () => {
            const rows = [["TALLER", "ID", "CIUDAD", "FACTURACIÓN", "ESTADO"]];
            document.querySelectorAll("#ceo-node-table tr").forEach(tr => {
                const tds = tr.querySelectorAll("td");
                rows.push([tds[0].querySelector("p").innerText, tds[1].innerText, tds[2].querySelector("p").innerText, tds[3].innerText]);
            });
            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "NEXUS_INFRASTRUCTURE_REPORT.csv");
            link.click();
        };

        window.filtrarNodos = () => {
            const val = document.getElementById('node-filter').value.toUpperCase();
            document.querySelectorAll("#ceo-node-table tr").forEach(r => {
                r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none";
            });
        };

        window.protocoloCierre = () => {
            if(confirm("¿Cerrar sesión de Command Zero?")) {
                signOut(auth).then(() => location.href = "index.html");
            }
        };

    </script>
</body>
</html>
