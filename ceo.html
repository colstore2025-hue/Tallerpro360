<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CEO COMMAND | Nexus-X Starlink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #f59e0b; --deep: #020617; --neon: #3b82f6; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--deep); color: white; margin: 0; overflow-x: hidden; }
        .font-nexus { font-family: 'Orbitron', sans-serif; }
        .glass-ceo { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 24px; }
        .stat-card { border-top: 4px solid var(--gold); transition: 0.3s; }
        .stat-card:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(245, 158, 11, 0.1); }
        .btn-kill { background: linear-gradient(135deg, #ef4444, #991b1b); }
        .btn-active { background: linear-gradient(135deg, #10b981, #065f46); }
        
        /* Animación de Radar */
        .radar-line { width: 100%; height: 2px; background: var(--gold); position: absolute; animation: scan 4s linear infinite; opacity: 0.1; z-index: 0; }
        @keyframes scan { from { top: 0%; } to { top: 100%; } }
    </style>
</head>
<body class="p-4 lg:p-10">

<header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6 relative z-10">
    <div>
        <h1 class="font-nexus text-4xl text-gold tracking-tighter">GLOBAL COMMAND</h1>
        <p class="text-[10px] text-slate-500 font-black tracking-[0.5em] uppercase">William Urquijo - CEO Operations</p>
    </div>
    <div class="flex gap-3">
        <button onclick="exportarData()" class="glass-ceo px-6 flex items-center gap-3 text-xs font-bold hover:bg-gold hover:text-black transition-all">
            <i class="fas fa-file-csv"></i> EXPORTAR LOGS
        </button>
        <button onclick="logout()" class="w-14 h-14 glass-ceo flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all">
            <i class="fas fa-power-off"></i>
        </button>
    </div>
</header>

<main class="space-y-10 relative z-10">
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="glass-ceo p-6 stat-card">
            <p class="text-[10px] font-black text-slate-500 uppercase">Facturación Red Colombia</p>
            <h2 id="total-money" class="text-3xl font-nexus mt-2 text-white">$0</h2>
            <p class="text-[9px] text-emerald-400 mt-1 font-bold italic">Sincronizado con Starlink</p>
        </div>
        <div class="glass-ceo p-6 stat-card">
            <p class="text-[10px] font-black text-slate-500 uppercase">Nodos Activos</p>
            <h2 id="total-nodos" class="text-3xl font-nexus mt-2 text-white">0</h2>
            <p class="text-[9px] text-gold mt-1 font-bold uppercase">Talleres Registrados</p>
        </div>
        <div class="glass-ceo p-6 stat-card" style="border-top-color: #3b82f6;">
            <p class="text-[10px] font-black text-slate-500 uppercase">Vencimientos Proximos</p>
            <h2 id="total-demo" class="text-3xl font-nexus mt-2 text-neon">0</h2>
            <p class="text-[9px] text-slate-500 mt-1 font-bold uppercase">Alerta de Licencia</p>
        </div>
        <div class="glass-ceo p-6 stat-card" style="border-top-color: #10b981;">
            <p class="text-[10px] font-black text-slate-500 uppercase">Flujo Vehicular</p>
            <h2 id="total-units" class="text-3xl font-nexus mt-2 text-success">0</h2>
            <p class="text-[9px] text-slate-500 mt-1 font-bold uppercase">Órdenes Procesadas</p>
        </div>
    </section>

    <section class="glass-ceo p-8 relative overflow-hidden">
        <div class="radar-line"></div>
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <h3 class="font-nexus text-sm tracking-widest border-l-4 border-gold pl-4">CONTROL DE SATÉLITES (TALLERES)</h3>
            <input id="search-taller" onkeyup="filterTable()" placeholder="FILTRAR NODO..." class="bg-slate-950 border border-slate-800 rounded-full px-6 py-3 text-xs w-full md:w-64 outline-none focus:border-gold transition-all">
        </div>

        <div class="overflow-x-auto relative z-10">
            <table id="main-table" class="w-full text-left text-sm border-separate border-spacing-y-2">
                <thead class="text-slate-500">
                    <tr class="uppercase text-[9px] tracking-widest">
                        <th class="px-4 pb-4">Identificación Nodo</th>
                        <th class="px-4 pb-4">Volumen Negocio</th>
                        <th class="px-4 pb-4">Vencimiento</th>
                        <th class="px-4 pb-4">Estado</th>
                        <th class="px-4 pb-4 text-center">Protocolo</th>
                    </tr>
                </thead>
                <tbody id="taller-table-body">
                    </tbody>
            </table>
        </div>
    </section>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- SEGURIDAD CEO ---
    onAuthStateChanged(auth, (user) => {
        // Tu correo maestro
        if (!user || user.email !== 'col.store2025@gmail.com') {
            window.location.href = "index.html";
        } else {
            initCEOCommand();
        }
    });

    function initCEOCommand() {
        // 1. Monitoreo de Talleres
        onSnapshot(collection(db, "usuarios"), (snap) => {
            const tbody = document.getElementById('taller-table-body');
            tbody.innerHTML = "";
            let countNodos = 0;
            let countDemo = 0;

            snap.forEach(d => {
                const u = d.data();
                if(u.rol === 'ADMIN') return;

                countNodos++;
                const hoy = Date.now();
                const vencimiento = u.vence || hoy;
                const diasRestantes = Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24));
                
                if(diasRestantes <= 5) countDemo++;

                tbody.innerHTML += `
                    <tr class="bg-slate-900/40 hover:bg-slate-800/60 transition-all rounded-2xl">
                        <td class="p-4 rounded-l-2xl">
                            <p class="font-bold text-white uppercase text-xs">${u.nombreTaller}</p>
                            <p class="text-[9px] text-slate-500 font-medium tracking-tight">${u.email}</p>
                        </td>
                        <td class="p-4 font-nexus text-gold">$${(u.facturacionAcumulada || 0).toLocaleString()}</td>
                        <td class="p-4 text-[10px]">
                            <span class="${diasRestantes < 5 ? 'text-red-500 font-black animate-pulse' : 'text-slate-300'}">
                                ${new Date(vencimiento).toLocaleDateString()} (${diasRestantes}d)
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="px-3 py-1 rounded-lg text-[8px] font-black border ${u.status === 'ACTIVO' ? 'border-emerald-500/50 text-emerald-500' : 'border-red-500/50 text-red-500'}">
                                ${u.status || 'ACTIVO'}
                            </span>
                        </td>
                        <td class="p-4 text-center rounded-r-2xl">
                            <button onclick="toggleNodo('${d.id}', '${u.status || 'ACTIVO'}')" class="px-4 py-2 rounded-xl text-[9px] font-black uppercase transition-all ${u.status === 'ACTIVO' ? 'btn-kill shadow-lg shadow-red-900/20' : 'btn-active shadow-lg shadow-emerald-900/20'}">
                                ${u.status === 'ACTIVO' ? 'Suspender' : 'Activar'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('total-nodos').innerText = countNodos;
            document.getElementById('total-demo').innerText = countDemo;
        });

        // 2. Monitoreo de Órdenes Globales
        onSnapshot(collection(db, "ordenes"), (snap) => {
            let totalMoney = 0;
            snap.forEach(d => {
                totalMoney += (d.data().contabilidad?.total || 0);
            });
            document.getElementById('total-money').innerText = `$${totalMoney.toLocaleString()}`;
            document.getElementById('total-units').innerText = snap.size;
        });
    }

    // --- ACCIONES MAESTRAS ---
    window.toggleNodo = async (id, currentStatus) => {
        const newStatus = currentStatus === 'ACTIVO' ? 'SUSPENDIDO' : 'ACTIVO';
        if(confirm(`Nexus-X Protocol: ¿Deseas cambiar el estado a ${newStatus}?`)) {
            await updateDoc(doc(db, "usuarios", id), { status: newStatus });
        }
    };

    window.exportarData = () => {
        const rows = [["Taller", "Email", "Facturación", "Estado"]];
        const tableRows = document.querySelectorAll("#taller-table-body tr");
        tableRows.forEach(tr => {
            const data = Array.from(tr.querySelectorAll("td")).map(td => td.innerText.replace(/\n/g, " "));
            rows.push([data[0], data[0], data[1], data[3]]);
        });
        
        let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `RED_NEXUS_REPORTE_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(link);
        link.click();
    };

    window.filterTable = () => {
        const val = document.getElementById('search-taller').value.toUpperCase();
        const rows = document.querySelectorAll("#taller-table-body tr");
        rows.forEach(r => {
            r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none";
        });
    };

    window.logout = () => signOut(auth).then(() => location.href = "index.html");
</script>
</body>
</html>
