<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TallerPRO360 - Nexus-X Starlink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --primary: #0f172a; --secondary: #1e293b; --success: #16a34a; --accent: #3b82f6; --danger: #ef4444; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f5f9; padding-bottom: 70px; }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
    
    /* Navegaci√≥n */
    .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 55px; z-index: 99; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.8em; color: var(--secondary); }
    .tab.active { border-bottom: 3px solid var(--accent); color: var(--accent); }
    
    .container { padding: 15px; max-width: 600px; margin: auto; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    
    input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; font-size: 16px; }
    .btn-main { background: var(--success); }
    .btn-accent { background: var(--accent); }
    .btn-voice { background: var(--secondary); margin-bottom: 5px; }
    
    .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
    .photo-preview { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 5px; background: #eee; border: 1px solid #ddd; }

    .list-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    .badge { padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; background: #dcfce7; color: #166534; }
  </style>
</head>
<body>

<header>
  <strong>TallerPRO360</strong> | <small>Nexus-X Starlink</small>
</header>

<div class="nav-tabs">
  <div class="tab active" onclick="showTab('ordenes')">ORDENES</div>
  <div class="tab" onclick="showTab('finanzas')">FINANZAS</div>
  <div class="tab" onclick="showTab('nomina')">N√ìMINA</div>
  <div class="tab" onclick="showTab('dashboard')">DASHBOARD</div>
</div>

<div class="container">
  
  <section id="sec-ordenes">
    <div class="card" style="background: var(--accent); color: white; text-align: center;">
      <p style="margin:0 0 10px 0;">üéôÔ∏è <strong>Modo Manos Libres</strong></p>
      <button onclick="startGlobalVoice()" class="btn" style="background:white; color:var(--accent); margin:0;">DICTAR ORDEN COMPLETA</button>
    </div>

    <div class="card">
      <h3>üìã Nueva Orden de Trabajo</h3>
      <input id="o-placa" placeholder="Placa del Veh√≠culo">
      <input id="o-cliente" placeholder="Nombre del Cliente">
      <input id="o-tel" type="tel" placeholder="WhatsApp (ej: 310...)">
      <textarea id="o-trabajo" placeholder="¬øQu√© le vamos a hacer al carro?" rows="3"></textarea>
      
      <p style="font-size: 0.9em; color: #64748b;">üì∑ Fotos de Ingreso:</p>
      <input type="file" id="o-fotos" accept="image/*" capture="environment" multiple onchange="previewImages()">
      <div id="photo-preview-container" class="photo-grid"></div>
      
      <button class="btn btn-main" onclick="saveOrder()">GUARDAR Y NOTIFICAR WHATSAPP</button>
    </div>

    <h3>üõ†Ô∏è √ìrdenes en Curso</h3>
    <div id="lista-ordenes"></div>
  </section>

  <section id="sec-finanzas" class="hidden">
    <div class="card">
      <h3>üí∏ Registrar Gasto / Compra</h3>
      <select id="g-tipo">
        <option value="Insumos">Repuestos / Insumos</option>
        <option value="Servicios">Servicios (Luz, Agua, Internet)</option>
        <option value="Arriendo">Arriendo</option>
        <option value="Nomina">Pago de N√≥mina</option>
        <option value="Otros">Otros Gastos</option>
      </select>
      <input id="g-valor" type="number" placeholder="Valor en Pesos ($)">
      <input id="g-desc" placeholder="Descripci√≥n breve">
      <select id="g-ordenId">
        <option value="general">Gasto General</option>
      </select>
      <button class="btn btn-accent" onclick="saveGasto()">REGISTRAR GASTO</button>
    </div>
    <h3>üìä Historial de Salidas</h3>
    <div id="lista-gastos"></div>
  </section>

  <section id="sec-nomina" class="hidden">
    <div class="card">
      <h3>üë∑ Liquidaci√≥n de T√©cnico</h3>
      <input id="n-nombre" placeholder="Nombre del colaborador">
      <select id="n-tipo">
        <option value="porcentaje">Porcentaje (Obra/Labor)</option>
        <option value="fijo">Sueldo Fijo / Quincena</option>
      </select>
      <input id="n-monto" type="number" placeholder="Monto base ($)">
      <button class="btn btn-main" onclick="generarPDFNomina()">GENERAR COMPROBANTE PDF</button>
    </div>
    <h3>Historial de Pagos</h3>
    <div id="lista-nomina"></div>
  </section>

  <section id="sec-dashboard" class="hidden">
    <div class="card" style="text-align: center;">
      <h4>Estado Financiero</h4>
      <canvas id="chartFinanzas" style="max-height: 250px;"></canvas>
    </div>
    <div class="card">
      <p>Total Ingresos Estimados: <strong id="d-ingresos">$0</strong></p>
      <p>Total Gastos Registrados: <strong id="d-gastos" style="color:var(--danger)">$0</strong></p>
      <hr>
      <h3>Utilidad Neta: <span id="d-utilidad">$0</span></h3>
    </div>
  </section>

</div>

<script>
// --- MOTOR DE BASE DE DATOS (IndexedDB) ---
let db;
const request = indexedDB.open("TallerProGlobalDB", 3);

request.onupgradeneeded = (e) => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("ordenes")) db.createObjectStore("ordenes", { keyPath: "id", autoIncrement: true });
  if(!db.objectStoreNames.contains("gastos")) db.createObjectStore("gastos", { keyPath: "id", autoIncrement: true });
  if(!db.objectStoreNames.contains("nomina")) db.createObjectStore("nomina", { keyPath: "id", autoIncrement: true });
};

request.onsuccess = (e) => {
  db = e.target.result;
  renderAll();
};

// --- NAVEGACI√ìN ---
function showTab(tab) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`sec-${tab}`).classList.remove('hidden');
  event.currentTarget.classList.add('active');
  if(tab === 'dashboard') initChart();
}

// --- L√ìGICA DE √ìRDENES Y FOTOS ---
let fotosBase64 = [];
function previewImages() {
  const files = document.getElementById('o-fotos').files;
  const container = document.getElementById('photo-preview-container');
  container.innerHTML = "";
  fotosBase64 = [];

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.className = "photo-preview";
      container.appendChild(img);
      fotosBase64.push(e.target.result);
    };
    reader.readAsDataURL(file);
  });
}

function saveOrder() {
  const placa = document.getElementById('o-placa').value.toUpperCase();
  const data = {
    placa,
    cliente: document.getElementById('o-cliente').value,
    tel: document.getElementById('o-tel').value,
    trabajo: document.getElementById('o-trabajo').value,
    fotos: fotosBase64,
    fecha: new Date().toLocaleString(),
    estado: 'Abierta'
  };

  const tx = db.transaction("ordenes", "readwrite");
  tx.objectStore("ordenes").add(data);
  tx.oncomplete = () => {
    enviarWhatsApp(data);
    alert("Orden Guardada Correctamente");
    location.reload();
  };
}

function enviarWhatsApp(data) {
  let num = data.tel.replace(/\D/g, '');
  if (num.length === 10) num = "57" + num;
  const msj = encodeURIComponent(`üöó *TallerPRO360 - NEXUS-X*\nHola ${data.cliente}, recibimos tu veh√≠culo con placa *${data.placa}*.\nDetalle: ${data.trabajo}\n\n*Estado:* En proceso.`);
  window.open(`https://wa.me/${num}?text=${msj}`, '_blank');
}

// --- L√ìGICA DE GASTOS ---
function saveGasto() {
  const data = {
    tipo: document.getElementById('g-tipo').value,
    valor: parseFloat(document.getElementById('g-valor').value),
    desc: document.getElementById('g-desc').value,
    ordenId: document.getElementById('g-ordenId').value,
    fecha: new Date().toLocaleString()
  };
  const tx = db.transaction("gastos", "readwrite");
  tx.objectStore("gastos").add(data);
  tx.oncomplete = () => {
    alert("Gasto registrado");
    renderAll();
  };
}

// --- VOZ (NLP B√°sico) ---
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'es-CO';

function startGlobalVoice() {
  recognition.start();
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript.toLowerCase();
    if(text.includes("placa")) document.getElementById('o-placa').value = text.split("placa")[1].split(" ")[1].toUpperCase();
    if(text.includes("cliente")) document.getElementById('o-cliente').value = text.split("cliente")[1].trim();
    document.getElementById('o-trabajo').value = text;
  };
}

// --- PDF DE N√ìMINA ---
async function generarPDFNomina() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const nombre = document.getElementById('n-nombre').value;
  const monto = parseFloat(document.getElementById('n-monto').value);
  const tipo = document.getElementById('n-tipo').value;
  
  if(!nombre || !monto) return alert("Ingrese datos de n√≥mina");

  let total = monto;
  let detalle = "Salario Fijo";
  if(tipo === "porcentaje") {
    const porc = prompt("¬øQu√© porcentaje aplicar? (ej: 30)");
    total = (monto * (porc / 100));
    detalle = `Pago por porcentaje (${porc}%) de labor`;
  }

  doc.setFontSize(18);
  doc.text("COMPROBANTE DE PAGO - TallerPRO360", 20, 20);
  doc.setFontSize(10);
  doc.text("Nexus-X Starlink SAS - Tecnolog√≠a para Talleres", 20, 28);
  doc.line(20, 32, 190, 32);
  doc.text(`Beneficiario: ${nombre}`, 20, 50);
  doc.text(`Concepto: ${detalle}`, 20, 60);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 70);
  doc.setFontSize(14);
  doc.text(`TOTAL PAGADO: $${total.toLocaleString()}`, 20, 90);
  doc.save(`Pago_${nombre}.pdf`);
  
  // Guardar en DB
  const tx = db.transaction("nomina", "readwrite");
  tx.objectStore("nomina").add({ nombre, total, fecha: new Date().toLocaleString() });
}

// --- ACTUALIZAR VISTAS ---
function renderAll() {
  const listO = document.getElementById('lista-ordenes');
  const selectG = document.getElementById('g-ordenId');
  listO.innerHTML = "";
  
  db.transaction("ordenes").objectStore("ordenes").getAll().onsuccess = (e) => {
    e.target.result.forEach(o => {
      listO.innerHTML += `<div class="list-item">
        <div><strong>${o.placa}</strong> - ${o.cliente}</div>
        <span class="badge">Abierta</span>
      </div>`;
      selectG.innerHTML += `<option value="${o.id}">Orden: ${o.placa}</option>`;
    });
  };

  const listG = document.getElementById('lista-gastos');
  listG.innerHTML = "";
  db.transaction("gastos").objectStore("gastos").getAll().onsuccess = (e) => {
    let totalGastos = 0;
    e.target.result.forEach(g => {
      totalGastos += g.valor;
      listG.innerHTML += `<div class="list-item"><span>${g.desc}</span> <strong style="color:red">-$${g.valor.toLocaleString()}</strong></div>`;
    });
    document.getElementById('d-gastos').innerText = `$${totalGastos.toLocaleString()}`;
  };
}

// --- DASHBOARD ---
function initChart() {
  const ctx = document.getElementById('chartFinanzas').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Ingresos', 'Gastos'],
      datasets: [{
        data: [1000000, 450000], // Aqu√≠ se conectar√≠an los datos reales de la DB
        backgroundColor: ['#16a34a', '#ef4444']
      }]
    }
  });
}

// Service Worker para PWA
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
