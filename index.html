<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TallerPRO360 Elite - Nexus-X</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    :root { --primary: #0f172a; --accent: #3b82f6; --success: #16a34a; --gold: #f59e0b; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f5f9; padding-bottom: 80px; }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; }
    .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; overflow-x: auto; }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.75rem; color: #64748b; min-width: 90px; }
    .tab.active { border-bottom: 4px solid var(--accent); color: var(--accent); }
    .container { padding: 15px; max-width: 600px; margin: auto; }
    .card { background: white; padding: 18px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 15px; }
    input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 8px; }
    .btn-main { background: var(--success); }
    .btn-accent { background: var(--accent); }
    .btn-edit { background: var(--gold); font-size: 0.7rem; padding: 8px; width: auto; }
    .list-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
    #auth-screen { background: var(--primary); height: 100vh; color: white; display: flex; flex-direction: column; justify-content: center; position: fixed; top: 0; left: 0; z-index: 9999; width: 100%; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="auth-screen">
  <div style="background:white; color:var(--primary); margin:20px; padding:30px; border-radius:20px;">
    <h2 style="text-align:center;">TallerPRO360</h2>
    <div id="login-form">
      <input id="auth-email" type="email" placeholder="Correo del taller">
      <input id="auth-pass" type="password" placeholder="Contrase√±a">
      <button class="btn btn-accent" onclick="handleAuth('login')">ENTRAR</button>
      <p onclick="toggleAuth()" style="text-align:center; font-size:0.8rem;">¬øNo tienes cuenta? Reg√≠strate</p>
    </div>
    <div id="register-form" class="hidden">
      <input id="reg-taller" type="text" placeholder="Nombre del Taller">
      <input id="reg-email" type="email" placeholder="Correo electr√≥nico">
      <input id="reg-pass" type="password" placeholder="Contrase√±a">
      <button class="btn btn-main" onclick="handleAuth('register')">REGISTRAR MI TALLER</button>
      <p onclick="toggleAuth()" style="text-align:center; font-size:0.8rem;">Volver al login</p>
    </div>
  </div>
</div>

<header>
  <strong id="display-taller">Nexus-X Starlink</strong><br>
  <small style="font-size:0.6rem;">LOG√çSTICA VEHICULAR USA-COLOMBIA</small>
</header>

<div class="nav-tabs">
  <div class="tab active" onclick="showTab('ordenes')">ORDENES</div>
  <div class="tab" onclick="showTab('finanzas')">FINANZAS</div>
  <div class="tab" onclick="showTab('nomina')">N√ìMINA</div>
  <div id="tab-admin" class="tab" style="background:#000; color:var(--gold); display:none;" onclick="showTab('admin')">ADMIN</div>
</div>

<div class="container">
  <section id="sec-ordenes">
    <div class="card" style="background:var(--primary);">
      <button id="btn-voz" class="btn btn-accent">üéôÔ∏è DICTAR ORDEN (TOQUE AQU√ç)</button>
    </div>
    <div class="card">
      <h3>üìã Nueva Orden / Edici√≥n</h3>
      <input id="o-id" type="hidden">
      <input id="o-placa" placeholder="PLACA" style="text-transform:uppercase; font-weight:bold;">
      <input id="o-cliente" placeholder="Cliente">
      <input id="o-tel" type="tel" placeholder="WhatsApp">
      <textarea id="o-trabajo" placeholder="Tareas y repuestos..." rows="4"></textarea>
      <button class="btn btn-main" onclick="saveOrder()">GUARDAR CAMBIOS</button>
    </div>
    <div id="lista-ordenes"></div>
  </section>

  <section id="sec-admin" class="hidden">
    <div class="card">
      <h3 style="color:var(--gold);">üëë Panel Nexus-X Maestro</h3>
      <div id="admin-users"></div>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
    authDomain: "tallerpro360.firebaseapp.com",
    projectId: "tallerpro360",
    storageBucket: "tallerpro360.appspot.com",
    messagingSenderId: "636224778184",
    appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- AUTH ---
  window.handleAuth = async (mode) => {
    const email = mode === 'login' ? document.getElementById('auth-email').value : document.getElementById('reg-email').value;
    const pass = mode === 'login' ? document.getElementById('auth-pass').value : document.getElementById('reg-pass').value;
    try {
      if (mode === 'register') {
        const res = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "usuarios", res.user.uid), {
          nombreTaller: document.getElementById('reg-taller').value,
          email: email,
          fechaRegistro: serverTimestamp(),
          estado: "TRIAL"
        });
      } else {
        await signInWithEmailAndPassword(auth, email, pass);
      }
      location.reload();
    } catch (e) { alert(e.message); }
  };

  // --- LOGICA DE ESTADO ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const uDoc = await getDoc(doc(db, "usuarios", user.uid));
      if (uDoc.exists()) {
        const data = uDoc.data();
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('display-taller').innerText = data.nombreTaller;
        
        // CORRECCI√ìN ADMIN: Verificaci√≥n por email o UID
        if(user.email === 'william@nexus-x.com' || user.uid === 'TU_UID_AQUI') {
          document.getElementById('tab-admin').style.display = 'block';
          loadAdmin();
        }
        renderOrders();
      }
    }
  });

  // --- GESTI√ìN DE ORDENES (CREAR Y EDITAR) ---
  window.saveOrder = async () => {
    const id = document.getElementById('o-id').value;
    const orden = {
      placa: document.getElementById('o-placa').value.toUpperCase(),
      cliente: document.getElementById('o-cliente').value,
      tel: document.getElementById('o-tel').value,
      trabajo: document.getElementById('o-trabajo').value,
      tallerId: auth.currentUser.uid,
      ultimaModificacion: serverTimestamp()
    };

    if (id) {
      await updateDoc(doc(db, "ordenes", id), orden);
      alert("Orden Actualizada");
    } else {
      await addDoc(collection(db, "ordenes"), orden);
      alert("Orden Creada");
    }
    location.reload();
  };

  window.editOrder = (id, placa, cliente, tel, trabajo) => {
    document.getElementById('o-id').value = id;
    document.getElementById('o-placa').value = placa;
    document.getElementById('o-cliente').value = cliente;
    document.getElementById('o-tel').value = tel;
    document.getElementById('o-trabajo').value = trabajo;
    window.scrollTo(0,0);
    alert("Modo Edici√≥n: Modifique las tareas y guarde.");
  };

  async function renderOrders() {
    const q = query(collection(db, "ordenes"), where("tallerId", "==", auth.currentUser.uid));
    const snap = await getDocs(q);
    const list = document.getElementById('lista-ordenes');
    list.innerHTML = "<h3>√ìrdenes Activas</h3>";
    snap.forEach(d => {
      const o = d.data();
      list.innerHTML += `<div class="list-item">
        <div><b>${o.placa}</b> - ${o.cliente}</div>
        <button class="btn-edit" onclick="editOrder('${d.id}','${o.placa}','${o.cliente}','${o.tel}','${o.trabajo}')">GESTIONAR</button>
      </div>`;
    });
  }

  // --- VOZ MEJORADA ---
  const btnVoz = document.getElementById('btn-voz');
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-CO';
    recognition.continuous = false;

    btnVoz.onclick = () => {
      recognition.start();
      btnVoz.innerText = "üî¥ ESCUCHANDO...";
    };

    recognition.onresult = (event) => {
      const text = event.results[0][0].transcript;
      document.getElementById('o-trabajo').value += (document.getElementById('o-trabajo').value ? " " : "") + text;
      btnVoz.innerText = "üéôÔ∏è DICTAR ORDEN (TOQUE AQU√ç)";
    };

    recognition.onerror = () => {
      btnVoz.innerText = "üéôÔ∏è DICTAR ORDEN (TOQUE AQU√ç)";
      alert("Error en micr√≥fono. Verifique permisos.");
    };
  }

  // --- ADMIN PANEL ---
  async function loadAdmin() {
    const snap = await getDocs(collection(db, "usuarios"));
    const container = document.getElementById('admin-users');
    container.innerHTML = "";
    snap.forEach(u => {
      const d = u.data();
      container.innerHTML += `<div class="list-item">
        <div>${d.nombreTaller} (${d.estado})</div>
        <button onclick="activateTaller('${u.id}')" style="background:green; color:white; border-radius:5px;">ACTIVAR</button>
      </div>`;
    });
  }

  window.activateTaller = async (id) => {
    await updateDoc(doc(db, "usuarios", id), { estado: "PAGADO" });
    alert("Usuario Activado");
    location.reload();
  };

  window.showTab = (tab) => {
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`sec-${tab}`).classList.remove('hidden');
    event.currentTarget.classList.add('active');
  };

  window.toggleAuth = () => {
    document.getElementById('login-form').classList.toggle('hidden');
    document.getElementById('register-form').classList.toggle('hidden');
  };
</script>
</body>
</html>
