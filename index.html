<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TallerPRO360 - Nexus-X Starlink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #0f172a; --secondary: #1e293b; --success: #16a34a; --accent: #3b82f6; --danger: #ef4444; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f5f9; padding-bottom: 70px; }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; sticky: top; z-index: 100; }
    
    /* Navegaci√≥n */
    .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; sticky: top; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.8em; color: var(--secondary); }
    .tab.active { border-bottom: 3px solid var(--accent); color: var(--accent); }
    
    .container { padding: 15px; max-width: 600px; margin: auto; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    
    /* Inputs y Botones */
    input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 5px; }
    .btn-main { background: var(--success); }
    .btn-accent { background: var(--accent); }
    .btn-voice { background: var(--secondary); width: auto; margin: 0; }
    
    /* Fotos */
    .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
    .photo-preview { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 5px; background: #eee; }

    /* Listas */
    .list-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
    .hidden { display: none; }
    
    /* Bottom Nav (Mobile style) */
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; }
    .nav-item { flex: 1; padding: 15px; text-align: center; font-size: 1.2em; cursor: pointer; }
  </style>
</head>
<body>

<header>
  <strong>TallerPRO360</strong> | <small>Nexus-X</small>
</header>

<div class="nav-tabs">
  <div class="tab active" onclick="showTab('ordenes')">ORDENES</div>
  <div class="tab" onclick="showTab('finanzas')">FINANZAS</div>
  <div class="tab" onclick="showTab('nomina')">N√ìMINA</div>
  <div class="tab" onclick="showTab('dashboard')">DASHBOARD</div>
</div>

<div class="container">
  
  <section id="sec-ordenes">
    <div class="card" style="background: var(--accent); color: white;">
      <strong>üéôÔ∏è Asistente de Voz:</strong>
      <button onclick="startGlobalVoice()" class="btn" style="background:white; color:var(--accent); margin-top:10px;">DICTAR ORDEN COMPLETA</button>
    </div>

    <div class="card">
      <h3>Nueva Orden</h3>
      <input id="o-placa" placeholder="Placa">
      <input id="o-cliente" placeholder="Cliente">
      <input id="o-tel" type="tel" placeholder="WhatsApp">
      <textarea id="o-trabajo" placeholder="Descripci√≥n del servicio"></textarea>
      
      <p>üì∑ Evidencias (Fotos):</p>
      <input type="file" id="o-fotos" accept="image/*" capture="environment" multiple onchange="previewImages()">
      <div id="photo-preview-container" class="photo-grid"></div>
      
      <button class="btn btn-main" onclick="saveOrder()">GUARDAR Y ENVIAR WHATSAPP</button>
    </div>

    <h3>√ìrdenes Activas</h3>
    <div id="lista-ordenes"></div>
  </section>

  <section id="sec-finanzas" class="hidden">
    <div class="card">
      <h3>Registrar Gasto</h3>
      <select id="g-tipo">
        <option value="Insumos">Insumos/Repuestos</option>
        <option value="Servicios">Servicios P√∫blicos</option>
        <option value="Arriendo">Arriendo</option>
        <option value="Otros">Otros</option>
      </select>
      <input id="g-valor" type="number" placeholder="Valor ($)">
      <input id="g-desc" placeholder="Descripci√≥n del gasto">
      <select id="g-ordenId">
        <option value="general">Gasto General (No asociado a orden)</option>
      </select>
      <button class="btn btn-accent" onclick="saveGasto()">REGISTRAR GASTO</button>
    </div>
    <h3>Historial de Gastos</h3>
    <div id="lista-gastos"></div>
  </section>

  <section id="sec-nomina" class="hidden">
    <div class="card">
      <h3>Liquidaci√≥n de Personal</h3>
      <input id="n-nombre" placeholder="Nombre del Mec√°nico/Pintor">
      <select id="n-tipo">
        <option value="porcentaje">Porcentaje por Obra (Destajo)</option>
        <option value="fijo">Salario Fijo</option>
      </select>
      <input id="n-monto" type="number" placeholder="Monto o %">
      <button class="btn btn-main" onclick="saveNomina()">GUARDAR COLABORADOR</button>
    </div>
    <div id="lista-nomina"></div>
  </section>

  <section id="sec-dashboard" class="hidden">
    <div class="card">
      <canvas id="chartFinanzas"></canvas>
    </div>
    <div class="card">
      <h4>Resumen del Mes</h4>
      <p>Ingresos: <strong id="d-ingresos">$0</strong></p>
      <p>Gastos: <strong id="d-gastos" style="color:var(--danger)">$0</strong></p>
      <hr>
      <p>Utilidad: <strong id="d-utilidad">$0</strong></p>
    </div>
  </section>

</div>

<script>
// --- CONFIGURACI√ìN DE BASE DE DATOS ---
let db;
const request = indexedDB.open("TallerProUltimateDB", 2);
request.onupgradeneeded = (e) => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("ordenes")) db.createObjectStore("ordenes", { keyPath: "id", autoIncrement: true });
  if(!db.objectStoreNames.contains("gastos")) db.createObjectStore("gastos", { keyPath: "id", autoIncrement: true });
  if(!db.objectStoreNames.contains("nomina")) db.createObjectStore("nomina", { keyPath: "id", autoIncrement: true });
};
request.onsuccess = (e) => { db = e.target.result; renderAll(); };

// --- NAVEGACI√ìN ---
function showTab(tab) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`sec-${tab}`).classList.remove('hidden');
  event.currentTarget.classList.add('active');
  if(tab === 'dashboard') initChart();
}

// --- L√ìGICA DE ORDENES ---
let fotosBase64 = [];
function previewImages() {
  const files = document.getElementById('o-fotos').files;
  const container = document.getElementById('photo-preview-container');
  container.innerHTML = "";
  fotosBase64 = [];

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.className = "photo-preview";
      container.appendChild(img);
      fotosBase64.push(e.target.result);
    };
    reader.readAsDataURL(file);
  });
}

function saveOrder() {
  const data = {
    placa: document.getElementById('o-placa').value.toUpperCase(),
    cliente: document.getElementById('o-cliente').value,
    tel: document.getElementById('o-tel').value,
    trabajo: document.getElementById('o-trabajo').value,
    fotos: fotosBase64,
    fecha: new Date().toISOString(),
    estado: 'Abierta'
  };

  const tx = db.transaction("ordenes", "readwrite");
  tx.objectStore("ordenes").add(data);
  tx.oncomplete = () => {
    enviarWhatsApp(data);
    location.reload(); 
  };
}

function enviarWhatsApp(data) {
  let num = data.tel.replace(/\D/g, '');
  if (num.length === 10) num = "57" + num;
  const msj = encodeURIComponent(`üöó *TallerPRO360*\nHola ${data.cliente}, recibimos tu veh√≠culo placa *${data.placa}*.\nServicio: ${data.trabajo}\nNexus-X Starlink SAS.`);
  window.open(`https://wa.me/${num}?text=${msj}`, '_blank');
}

// --- L√ìGICA DE GASTOS Y FINANZAS ---
function saveGasto() {
  const data = {
    tipo: document.getElementById('g-tipo').value,
    valor: parseFloat(document.getElementById('g-valor').value),
    desc: document.getElementById('g-desc').value,
    ordenId: document.getElementById('g-ordenId').value,
    fecha: new Date().toISOString()
  };
  const tx = db.transaction("gastos", "readwrite");
  tx.objectStore("gastos").add(data);
  tx.oncomplete = () => renderAll();
}

// --- VOZ ---
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'es-CO';

function startGlobalVoice() {
  recognition.start();
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript.toLowerCase();
    if(text.includes("placa")) document.getElementById('o-placa').value = text.split("placa")[1].split(" ")[1].toUpperCase();
    if(text.includes("cliente")) document.getElementById('o-cliente').value = text.split("cliente")[1].trim();
    document.getElementById('o-trabajo').value = text;
  };
}

// --- RENDERING ---
function renderAll() {
  // Render √ìrdenes
  const listO = document.getElementById('lista-ordenes');
  const selectG = document.getElementById('g-ordenId');
  listO.innerHTML = "";
  db.transaction("ordenes").objectStore("ordenes").getAll().onsuccess = (e) => {
    e.target.result.forEach(o => {
      listO.innerHTML += `<div class="list-item"><span>${o.placa} - ${o.cliente}</span> <span class="badge">Activa</span></div>`;
      selectG.innerHTML += `<option value="${o.id}">Orden: ${o.placa}</option>`;
    });
  };
  
  // Render Gastos
  const listG = document.getElementById('lista-gastos');
  listG.innerHTML = "";
  db.transaction("gastos").objectStore("gastos").getAll().onsuccess = (e) => {
    e.target.result.forEach(g => {
      listG.innerHTML += `<div class="list-item"><span>${g.desc}</span> <strong style="color:red">-$${g.valor}</strong></div>`;
    });
  };
}

function initChart() {
  const ctx = document.getElementById('chartFinanzas').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Ingresos', 'Gastos'],
      datasets: [{
        data: [5000000, 2400000], // Ejemplo est√°tico, se vincula a DB despu√©s
        backgroundColor: ['#16a34a', '#ef4444']
      }]
    }
  });
}
</script>

</body>
</html>
