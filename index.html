<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TallerPRO360 - Nexus-X Starlink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Reemplaza con tus credenciales de la Consola Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
      authDomain: "tallerpro360.firebaseapp.com",
      projectId: "tallerpro360",
      storageBucket: "tallerpro360.appspot.com",
      messagingSenderId: "XXXXXXXX",
      appId: "XXXXXXXX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Exponer a nivel global para el resto del script
    window.auth = auth;
    window.db = db;
    window.setDoc = setDoc;
    window.doc = doc;
    window.getDoc = getDoc;
  </script>

  <style>
    :root { --primary: #0f172a; --secondary: #1e293b; --success: #16a34a; --accent: #3b82f6; --danger: #ef4444; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f5f9; padding-bottom: 70px; }
    header { background: var(--primary); color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 100; }
    
    /* Pantalla de Autenticaci√≥n */
    #auth-screen { background: var(--primary); height: 100vh; color: white; display: flex; flex-direction: column; justify-content: center; position: fixed; top: 0; left: 0; z-index: 999; width: 100%; transition: 0.3s; }
    .auth-card { background: white; color: var(--primary); margin: 20px; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    
    /* Navegaci√≥n */
    .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 55px; z-index: 99; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.8em; color: var(--secondary); }
    .tab.active { border-bottom: 3px solid var(--accent); color: var(--accent); }
    
    .container { padding: 15px; max-width: 600px; margin: auto; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    
    input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; font-size: 16px; }
    .btn-main { background: var(--success); }
    .btn-accent { background: var(--accent); }
    .btn-voice { background: var(--secondary); margin-bottom: 5px; }
    
    .hidden { display: none !important; }
    .list-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
    .badge { padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; background: #dcfce7; color: #166534; }
  </style>
</head>
<body>

<div id="auth-screen">
  <div class="auth-card">
    <h2 style="text-align: center; margin-bottom: 5px;">TallerPRO360</h2>
    <p style="text-align: center; font-size: 0.8em; color: #64748b; margin-bottom: 20px;">Nexus-X Starlink SAS</p>
    
    <div id="login-form">
      <input id="auth-email" type="email" placeholder="Correo del taller">
      <input id="auth-pass" type="password" placeholder="Contrase√±a">
      <button class="btn btn-accent" onclick="handleAuth('login')">ENTRAR AL SISTEMA</button>
      <p style="text-align: center; font-size: 0.8em; color: var(--accent);" onclick="toggleAuth()">¬øNo tienes cuenta? Reg√≠strate aqu√≠</p>
    </div>

    <div id="register-form" class="hidden">
      <input id="reg-taller" type="text" placeholder="Nombre de tu Taller">
      <input id="reg-email" type="email" placeholder="Correo electr√≥nico">
      <input id="reg-pass" type="password" placeholder="Contrase√±a segura">
      <button class="btn btn-main" onclick="handleAuth('register')">ACTIVAR 7 D√çAS GRATIS</button>
      <p style="text-align: center; font-size: 0.8em; color: var(--accent);" onclick="toggleAuth()">Ya tengo cuenta, volver</p>
    </div>
    <p style="text-align: center; font-size: 0.7em; margin-top: 15px; color: #94a3b8;">"Menos grasa en el papel, m√°s plata en su bolsillo."</p>
  </div>
</div>

<header>
  <strong id="display-taller">TallerPRO360</strong><br>
  <small style="font-size: 0.6em; letter-spacing: 1px;">NEXUS-X: MENOS GRASA EN EL PAPEL, M√ÅS PLATA EN SU BOLSILLO</small>
</header>

<div class="nav-tabs">
  <div class="tab active" onclick="showTab('ordenes')">ORDENES</div>
  <div class="tab" onclick="showTab('finanzas')">FINANZAS</div>
  <div class="tab" onclick="showTab('nomina')">N√ìMINA</div>
  <div class="tab" onclick="showTab('dashboard')">DASHBOARD</div>
</div>

<div class="container">
  <section id="sec-ordenes">
    <div class="card" style="background: var(--accent); color: white; text-align: center;">
      <p style="margin:0 0 10px 0;">üéôÔ∏è <strong>Modo Manos Libres</strong></p>
      <button onclick="startGlobalVoice()" class="btn" style="background:white; color:var(--accent); margin:0;">DICTAR ORDEN COMPLETA</button>
    </div>

    <div class="card">
      <h3>üìã Nueva Orden de Trabajo</h3>
      <input id="o-placa" placeholder="Placa del Veh√≠culo">
      <input id="o-cliente" placeholder="Nombre del Cliente">
      <input id="o-tel" type="tel" placeholder="WhatsApp (ej: 310...)">
      <textarea id="o-trabajo" placeholder="¬øQu√© le vamos a hacer al carro?" rows="3"></textarea>
      <button class="btn btn-main" onclick="saveOrder()">GUARDAR Y NOTIFICAR WHATSAPP</button>
    </div>
    <h3>üõ†Ô∏è √ìrdenes en Curso</h3>
    <div id="lista-ordenes"></div>
  </section>

  <section id="sec-finanzas" class="hidden">
    <div class="card">
      <h3>üí∏ Registrar Gasto</h3>
      <select id="g-tipo">
        <option value="Insumos">Repuestos / Insumos</option>
        <option value="Servicios">Servicios</option>
        <option value="Nomina">Pago de N√≥mina</option>
      </select>
      <input id="g-valor" type="number" placeholder="Valor ($)">
      <input id="g-desc" placeholder="Descripci√≥n">
      <button class="btn btn-accent" onclick="saveGasto()">REGISTRAR GASTO</button>
    </div>
    <div id="lista-gastos"></div>
  </section>

  <section id="sec-nomina" class="hidden">
    <div class="card">
      <h3>üë∑ Liquidaci√≥n de T√©cnico</h3>
      <input id="n-nombre" placeholder="Nombre del colaborador">
      <input id="n-monto" type="number" placeholder="Monto base ($)">
      <button class="btn btn-main" onclick="generarPDFNomina()">GENERAR PDF Y PAGAR</button>
    </div>
  </section>

  <section id="sec-dashboard" class="hidden">
    <div class="card" style="text-align: center;">
      <h4>Estado Financiero</h4>
      <canvas id="chartFinanzas" style="max-height: 250px;"></canvas>
    </div>
  </section>
</div>

<script>
// --- PUNTO 2: L√ìGICA DE NUBE Y TRIAL ---
function toggleAuth() {
  document.getElementById('login-form').classList.toggle('hidden');
  document.getElementById('register-form').classList.toggle('hidden');
}

async function handleAuth(mode) {
  const email = mode === 'login' ? document.getElementById('auth-email').value : document.getElementById('reg-email').value;
  const pass = mode === 'login' ? document.getElementById('auth-pass').value : document.getElementById('reg-pass').value;

  try {
    if (mode === 'register') {
      const nombreTaller = document.getElementById('reg-taller').value;
      const res = await window.auth.createUserWithEmailAndPassword(window.auth, email, pass);
      await window.setDoc(window.doc(window.db, "usuarios", res.user.uid), {
        nombreTaller: nombreTaller,
        fechaRegistro: new Date(),
        estado: "TRIAL"
      });
    } else {
      await window.auth.signInWithEmailAndPassword(window.auth, email, pass);
    }
    location.reload();
  } catch (e) { alert("Error: " + e.message); }
}

// Verificaci√≥n de acceso al cargar
window.onload = () => {
  setTimeout(async () => {
    const user = window.auth.currentUser;
    if (user) {
      const docSnap = await window.getDoc(window.doc(window.db, "usuarios", user.uid));
      if (docSnap.exists()) {
        const data = docSnap.data();
        const dias = Math.floor((new Date() - data.fechaRegistro.toDate()) / (1000*60*60*24));
        
        if (data.estado === "PAGADO" || dias <= 7) {
          document.getElementById('auth-screen').classList.add('hidden');
          document.getElementById('display-taller').innerText = data.nombreTaller;
        } else {
          alert("Periodo de prueba vencido. Contacta a Nexus-X.");
        }
      }
    }
  }, 1500);
};

// --- BASE DE DATOS LOCAL (√ìrdenes) ---
let localDB;
const req = indexedDB.open("TallerProDB", 1);
req.onsuccess = (e) => { localDB = e.target.result; renderAll(); };
req.onupgradeneeded = (e) => {
  let db = e.target.result;
  db.createObjectStore("ordenes", { keyPath: "id", autoIncrement: true });
};

function showTab(tab) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`sec-${tab}`).classList.remove('hidden');
  event.currentTarget.classList.add('active');
  if(tab === 'dashboard') initChart();
}

function saveOrder() {
  const data = {
    placa: document.getElementById('o-placa').value.toUpperCase(),
    cliente: document.getElementById('o-cliente').value,
    tel: document.getElementById('o-tel').value,
    trabajo: document.getElementById('o-trabajo').value,
    fecha: new Date().toLocaleString()
  };
  const tx = localDB.transaction("ordenes", "readwrite");
  tx.objectStore("ordenes").add(data);
  tx.oncomplete = () => {
    let num = data.tel.replace(/\D/g, '');
    const msj = encodeURIComponent(`üöó *TallerPRO360*\nHola ${data.cliente}, recibimos tu veh√≠culo placa *${data.placa}*.\nServicio: ${data.trabajo}`);
    window.open(`https://wa.me/57${num}?text=${msj}`, '_blank');
    location.reload();
  };
}

function renderAll() {
  const list = document.getElementById('lista-ordenes');
  list.innerHTML = "";
  localDB.transaction("ordenes").objectStore("ordenes").getAll().onsuccess = (e) => {
    e.target.result.forEach(o => {
      list.innerHTML += `<div class="list-item"><div><strong>${o.placa}</strong> - ${o.cliente}</div><span class="badge">Activa</span></div>`;
    });
  };
}

// --- VOZ ---
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'es-CO';
function startGlobalVoice() {
  recognition.start();
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript.toLowerCase();
    document.getElementById('o-trabajo').value = text;
  };
}

// --- PDF N√ìMINA ---
function generarPDFNomina() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const nombre = document.getElementById('n-nombre').value;
  const monto = document.getElementById('n-monto').value;
  doc.text("COMPROBANTE DE PAGO - NEXUS-X", 20, 20);
  doc.text(`T√©cnico: ${nombre}`, 20, 40);
  doc.text(`Total: $${monto}`, 20, 50);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 60);
  doc.save(`Pago_${nombre}.pdf`);
}
</script>
</body>
</html>
