<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nexus-X | Mi Unidad Starlink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <link rel="manifest" href="/manifest-cliente.json"> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #020617; --secondary: #0f172a; --accent: #3b82f6; 
            --gold: #f59e0b; --success: #10b981; --danger: #ef4444;
            --glass: rgba(15, 23, 42, 0.7);
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--primary); color: #f1f5f9; margin: 0; padding-bottom: 30px; overflow-x: hidden; }
        .font-nexus { font-family: 'Orbitron', sans-serif; }
        
        /* Glassmorphism Ultra */
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); border-radius: 35px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .neo-input { background: rgba(2, 6, 23, 0.8); border: 2px solid #1e293b; border-radius: 22px; padding: 18px; color: white; width: 100%; transition: 0.3s; font-size: 16px; }
        .neo-input:focus { border-color: var(--accent); box-shadow: 0 0 30px rgba(59, 130, 246, 0.25); }

        /* Loader */
        #loader-nexus { position: fixed; inset: 0; z-index: 9999; background: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .hidden { display: none !important; }

        /* Timeline */
        .timeline { position: relative; padding-left: 30px; }
        .timeline::before { content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.1); }
        .timeline-item { position: relative; margin-bottom: 30px; }
        .timeline-icon { position: absolute; left: 0; top: 0; width: 20px; height: 20px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: translateX(-50%); border: 2px solid var(--primary); }
        .timeline-item.active .timeline-icon { background: var(--accent); animation: pulse-blue 1.5s infinite; border-color: var(--accent); }
        .timeline-item.completed .timeline-icon { background: var(--success); border-color: var(--success); }

        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    </style>
</head>
<body>

<div id="loader-nexus">
    <div class="relative w-40 h-40 mb-10">
        <div class="absolute inset-0 border-2 border-accent/20 rounded-full animate-ping"></div>
        <div class="absolute inset-4 border-2 border-gold/40 rounded-full animate-spin"></div>
        <i class="fas fa-truck-fast text-gold text-5xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
    </div>
    <h2 class="font-nexus text-2xl tracking-[0.4em] text-white animate-pulse">NEXUS-X STATUS</h2>
    <p class="text-[10px] text-slate-500 mt-4 uppercase font-black tracking-widest">Conexión Cliente-Taller</p>
</div>

<header class="p-5 sticky top-0 z-[1000] bg-slate-950/90 backdrop-blur-3xl border-b border-white/5">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-accent/20 rounded-2xl flex items-center justify-center border border-accent/30 shadow-2xl">
                <i class="fas fa-route text-accent text-xl"></i>
            </div>
            <div>
                <h1 class="font-nexus text-xs text-white">MI UNIDAD NEXUS-X</h1>
                <p id="placa-display" class="text-[10px] text-gold font-black uppercase tracking-widest mt-1">Cargando...</p>
            </div>
        </div>
        <button onclick="window.open('https://wa.me/573115709730')" class="w-12 h-12 bg-success/10 text-success rounded-2xl border border-success/20 hover:bg-success hover:text-white transition-all">
            <i class="fab fa-whatsapp"></i>
        </button>
    </div>
</header>

<main class="p-4 max-w-xl mx-auto space-y-8">
    
    <section id="search-section" class="space-y-6 text-center">
        <div class="glass-card p-8">
            <h3 class="font-nexus text-sm text-gold mb-8 uppercase tracking-widest">Rastrea tu Vehículo</h3>
            <div class="flex gap-4">
                <input id="search-placa" placeholder="INGRESA PLACA (EJ: AAA000)" class="neo-input text-center font-nexus text-2xl uppercase">
                <button onclick="buscarEstadoUnidad()" class="btn-nexus px-8 bg-accent rounded-2xl text-lg font-bold">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </section>

    <section id="status-section" class="hidden space-y-6">
        <div class="glass-card p-8 text-center">
            <h3 class="font-nexus text-sm text-white mb-2" id="unidad-nombre">Unidad: -</h3>
            <p class="text-[10px] text-slate-400 uppercase" id="unidad-taller">Taller: -</p>
        </div>

        <div class="glass-card p-8 timeline" id="status-timeline">
            </div>

        <div id="action-buttons" class="hidden glass-card p-8 grid grid-cols-2 gap-4">
            <button onclick="descargarFacturaCliente()" class="btn-nexus bg-success w-full p-5 text-lg font-bold">
                <i class="fas fa-file-invoice"></i> DESCARGAR FACTURA
            </button>
            <button onclick="verHistorialCompleto()" class="btn-nexus bg-gold w-full p-5 text-lg font-bold">
                <i class="fas fa-history"></i> VER HISTORIAL
            </button>
        </div>
    </section>

    <section id="no-results-section" class="hidden glass-card p-8 text-center">
        <i class="fas fa-exclamation-triangle text-danger text-5xl mb-6"></i>
        <h3 class="font-nexus text-xl text-white mb-4">Unidad No Encontrada</h3>
        <p class="text-slate-400 text-sm">Verifica la placa o contacta a tu taller para más información.</p>
    </section>

</main>

<script type="module">
    // --- INTEGRACIÓN FIREBASE CORE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- SERVICE WORKER PARA OFFLINE ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw-cliente.js') // Asegúrate de que este archivo exista en la raíz
                .then(reg => console.log('Service Worker registrado!', reg))
                .catch(err => console.log('Fallo al registrar Service Worker:', err));
        });
    }

    // --- ESTADOS POSIBLES DEL SERVICIO (SECRETAIA IA) ---
    const serviceStages = [
        { id: 'ingresado', label: 'Unidad en Patio', icon: 'fas fa-truck-pickup' },
        { id: 'diagnostico', label: 'Diagnóstico Técnico IA', icon: 'fas fa-stethoscope' },
        { id: 'reparacion', label: 'En Reparación Avanzada', icon: 'fas fa-wrench' },
        { id: 'control_calidad', label: 'Control de Calidad Nexus', icon: 'fas fa-check-double' },
        { id: 'listo_entrega', label: 'Listo para Entrega', icon: 'fas fa-flag-checkered' }
    ];

    let currentOrderData = null; // Para almacenar la orden actual del cliente

    // --- FUNCIÓN PRINCIPAL DE BÚSQUEDA ---
    window.buscarEstadoUnidad = async () => {
        const placaInput = document.getElementById('search-placa');
        const placa = placaInput.value.toUpperCase().trim();

        if (!placa) {
            alert("Por favor, ingresa la placa de tu unidad.");
            return;
        }

        document.getElementById('loader-nexus').classList.remove('hidden');
        document.getElementById('search-section').classList.add('hidden');
        document.getElementById('status-section').classList.add('hidden');
        document.getElementById('no-results-section').classList.add('hidden');
        document.getElementById('action-buttons').classList.add('hidden');

        try {
            // Buscar la orden más reciente para esta placa
            const q = query(collection(db, "ordenes"), where("placa", "==", placa), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                currentOrderData = querySnapshot.docs[0].data(); // Obtiene la orden más reciente
                currentOrderData.id = querySnapshot.docs[0].id; // Guarda el ID de la orden

                document.getElementById('placa-display').innerText = currentOrderData.placa;
                document.getElementById('unidad-nombre').innerText = `Unidad: ${currentOrderData.marca || 'N/A'} - ${currentOrderData.modelo || 'N/A'}`;
                
                // Obtener nombre del taller
                if (currentOrderData.tallerId) {
                    const tallerDoc = await getDoc(doc(db, "usuarios", currentOrderData.tallerId));
                    if (tallerDoc.exists()) {
                        document.getElementById('unidad-taller').innerText = `Taller: ${tallerDoc.data().nombreTaller}`;
                    }
                }

                renderTimeline(currentOrderData.status || 'ingresado'); // Estado por defecto
                document.getElementById('status-section').classList.remove('hidden');
                document.getElementById('action-buttons').classList.remove('hidden');

                // Cachear la última búsqueda para modo offline
                localStorage.setItem('lastSearchedPlaca', placa);
                localStorage.setItem('lastOrderData', JSON.stringify(currentOrderData));

            } else {
                document.getElementById('no-results-section').classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error al buscar el estado de la unidad:", error);
            alert("Hubo un error al buscar la unidad. Intenta de nuevo.");
            document.getElementById('no-results-section').classList.remove('hidden');
        } finally {
            document.getElementById('loader-nexus').classList.add('hidden');
        }
    };

    // --- RENDERIZADO DE LA LÍNEA DE TIEMPO ---
    function renderTimeline(currentStatus) {
        const timelineContainer = document.getElementById('status-timeline');
        timelineContainer.innerHTML = ''; // Limpiar estados anteriores

        let foundCurrent = false;
        serviceStages.forEach(stage => {
            const isCompleted = foundCurrent;
            const isActive = stage.id === currentStatus;

            if (isActive) foundCurrent = true; // Marca que hemos pasado el estado activo para los siguientes

            const itemClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
            timelineContainer.innerHTML += `
                <div class="timeline-item ${itemClass}">
                    <div class="timeline-icon">
                        <i class="${stage.icon} text-white text-xs"></i>
                    </div>
                    <div class="glass-card p-4 ml-6">
                        <p class="text-sm font-bold ${isActive ? 'text-accent' : (isCompleted ? 'text-success' : 'text-slate-400')}">
                            ${stage.label}
                            ${isActive ? '<i class="fas fa-sync-alt fa-spin ml-2"></i>' : ''}
                        </p>
                        <p class="text-[9px] text-slate-500 mt-1">
                            ${isActive ? 'Tu unidad se encuentra en esta fase de servicio.' : (isCompleted ? 'Fase completada exitosamente.' : 'Fase pendiente.')}
                        </p>
                    </div>
                </div>
            `;
        });
    }

    // --- DESCARGAR FACTURA PDF (Módulo Contable Futuro) ---
    window.descargarFacturaCliente = async () => {
        if (!currentOrderData || !currentOrderData.id) {
            alert("No hay datos de orden para generar la factura.");
            return;
        }

        // Aquí simulamos datos de factura, en el futuro se obtendrán del taller.html
        // Para que esto funcione, 'taller.html' debe guardar estos datos en la orden
        const facturaData = {
            numero: currentOrderData.id.substring(0, 8).toUpperCase(),
            fecha: new Date().toLocaleDateString(),
            placa: currentOrderData.placa,
            cliente: currentOrderData.cliente,
            taller: document.getElementById('unidad-taller').innerText.replace('Taller: ', ''),
            items: [
                { descripcion: "Diagnóstico Computarizado Starlink", cantidad: 1, valorUnitario: 80000 },
                { descripcion: "Repuesto X (SIMULADO)", cantidad: 2, valorUnitario: 45000 },
                { descripcion: "Mano de Obra Especializada", cantidad: 1, valorUnitario: 150000 }
            ],
            subtotal: 0,
            iva: 0,
            total: 0
        };

        // Calcular totales (esto se haría en el backend o en el taller.html idealmente)
        facturaData.subtotal = facturaData.items.reduce((sum, item) => sum + (item.cantidad * item.valorUnitario), 0);
        facturaData.iva = facturaData.subtotal * 0.19; // IVA 19% en Colombia
        facturaData.total = facturaData.subtotal + facturaData.iva;

        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();

        // Encabezado de Élite
        docPDF.setFillColor(15, 23, 42); 
        docPDF.rect(0, 0, 210, 40, 'F');
        docPDF.setTextColor(255, 255, 255); docPDF.setFontSize(22);
        docPDF.text("NEXUS-X LOGISTICS SAS", 20, 25);
        
        // Información de Factura
        docPDF.setTextColor(0, 0, 0); docPDF.setFontSize(14);
        docPDF.text(`FACTURA N°: ${facturaData.numero}`, 20, 55);
        docPDF.text(`Fecha: ${facturaData.fecha}`, 20, 65);
        docPDF.text(`Taller: ${facturaData.taller}`, 20, 75);
        docPDF.text(`Cliente: ${facturaData.cliente}`, 20, 85);
        docPDF.text(`Placa: ${facturaData.placa}`, 20, 95);

        // Tabla de ítems
        docPDF.setFontSize(10);
        docPDF.text("Descripción", 20, 115);
        docPDF.text("Cant.", 90, 115);
        docPDF.text("V. Unit.", 120, 115);
        docPDF.text("Total", 160, 115);
        docPDF.line(15, 117, 195, 117); // Línea divisoria

        let y = 125;
        facturaData.items.forEach(item => {
            docPDF.text(item.descripcion, 20, y);
            docPDF.text(item.cantidad.toString(), 90, y);
            docPDF.text(`$${item.valorUnitario.toLocaleString('es-CO')}`, 120, y);
            docPDF.text(`$${(item.cantidad * item.valorUnitario).toLocaleString('es-CO')}`, 160, y);
            y += 10;
        });
        docPDF.line(15, y, 195, y); // Línea divisoria

        // Totales
        y += 10;
        docPDF.text(`Subtotal: $${facturaData.subtotal.toLocaleString('es-CO')}`, 140, y);
        y += 10;
        docPDF.text(`IVA (19%): $${facturaData.iva.toLocaleString('es-CO')}`, 140, y);
        y += 10;
        docPDF.setFontSize(12); docPDF.setFont(undefined, 'bold');
        docPDF.text(`TOTAL: $${facturaData.total.toLocaleString('es-CO')}`, 140, y);

        // Footer
        docPDF.setFontSize(8); docPDF.setFont(undefined, 'normal');
        docPDF.text("Gracias por confiar en Nexus-X Starlink SAS. Calidad garantizada por Colombian Trucks Logistics.", 20, docPDF.internal.pageSize.height - 20);

        docPDF.save(`Factura_Nexus_${facturaData.placa}.pdf`);
    };

    // --- VER HISTORIAL COMPLETO (Se podría hacer una nueva sección) ---
    window.verHistorialCompleto = () => {
        // Aquí podrías redirigir a otra sección o cargar un modal con más detalles.
        // Por ahora, solo alertamos.
        alert("Mostrando historial completo de mantenimiento (próxima feature).");
    };

    // --- CARGA INICIAL (Modo Offline) ---
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loader-nexus').classList.add('hidden'); // Ocultar loader al cargar
        // Intentar cargar la última búsqueda si está en caché
        const lastPlaca = localStorage.getItem('lastSearchedPlaca');
        const lastOrder = localStorage.getItem('lastOrderData');
        if (lastPlaca && lastOrder) {
            document.getElementById('search-placa').value = lastPlaca;
            currentOrderData = JSON.parse(lastOrder);
            document.getElementById('placa-display').innerText = currentOrderData.placa;
            document.getElementById('unidad-nombre').innerText = `Unidad: ${currentOrderData.marca || 'N/A'} - ${currentOrderData.modelo || 'N/A'}`;
            // Simular carga de taller para el modo offline
            document.getElementById('unidad-taller').innerText = `Taller: ${currentOrderData.tallerNameCached || 'Desconocido'}`; 
            
            renderTimeline(currentOrderData.status || 'ingresado');
            document.getElementById('search-section').classList.add('hidden');
            document.getElementById('status-section').classList.remove('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');
        } else {
            document.getElementById('search-section').classList.remove('hidden');
        }
    });

    // Ocultar loader al inicio
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            document.getElementById('loader-nexus').classList.add('hidden');
        }, 1000); // 1 segundo para la animación inicial
    });
</script>
</body>
</html>
