<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 - Panel Cliente</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{background:#0f172a;color:#fff;font-family:Inter,sans-serif;}
header{background:#111827;padding:15px;text-align:center;}
.container{max-width:800px;margin:auto;padding:20px;}
.card-dark{
  background:#1e293b;
  border:1px solid rgba(255,255,255,.1);
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
}
.badge-estado{
  padding:5px 10px;
  border-radius:20px;
  font-size:.8rem;
  font-weight:600;
}
.estado-ingreso{background:#2563eb;}
.estado-proceso{background:#f59e0b;color:#000;}
.estado-listo{background:#06b6d4;color:#000;}
.estado-entregado{background:#22c55e;}
.timeline{list-style:none;padding:0;margin-top:10px;font-size:.85rem;}
.timeline li{opacity:.8;margin-bottom:4px;}
input{background:#1e293b;border:1px solid rgba(255,255,255,.2);color:#fff;}
button{border-radius:8px;}
</style>
</head>

<body>

<header>
<h3>TallerPRO360</h3>
<button id="logoutBtn" class="btn btn-sm btn-danger d-none">Cerrar sesión</button>
</header>

<div class="container">

<div id="loginBox" class="card-dark">
<h5>Iniciar Sesión</h5>
<input type="email" id="email" placeholder="Correo electrónico" class="form-control mb-2">
<input type="password" id="password" placeholder="Contraseña" class="form-control mb-2">
<button id="loginBtn" class="btn btn-primary w-100">Ingresar</button>
</div>

<div id="ordenesContainer" class="d-none"></div>

</div>

<!-- Firebase Modular -->
<script type="module">

import { db } from "./firebase-config.js";
import {
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= VALIDACIÓN REAL ================= */

const empresaId = localStorage.getItem("empresaId");
const rol = localStorage.getItem("rol");
const uid = localStorage.getItem("uid");
const sucursalId = localStorage.getItem("sucursalId");

if (!empresaId || !uid || rol !== "cliente") {
  window.location.href = "login.html";
}

/* ================= UI ================= */

const logoutBtn = document.getElementById("logoutBtn");
const ordenesContainer = document.getElementById("ordenesContainer");
const loginBox = document.getElementById("loginBox");

loginBox?.remove();
ordenesContainer.classList.remove("d-none");
logoutBtn.classList.remove("d-none");

/* ================= LOGOUT ================= */

logoutBtn.addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "login.html";
});

/* ================= RENDER TIMELINE ================= */

function renderTimeline(stages) {

  if (!stages.length) return "<li>Sin actualizaciones</li>";

  return stages
    .sort((a,b)=> a.at?.seconds - b.at?.seconds)
    .map(s=>{
      const fecha = s.at?.toDate()?.toLocaleString() || "";
      return `<li>${s.stage} - ${fecha}</li>`;
    })
    .join("");

}

/* ================= ESCUCHAR ÓRDENES ================= */

function escucharOrdenes() {

  const q = query(
    collection(
      db,
      "empresas",
      empresaId,
      "sucursales",
      sucursalId,
      "ordenes"
    ),
    where("clienteId", "==", uid),
    where("visibleCliente", "==", true),
    orderBy("fechaIngreso", "desc")
  );

  onSnapshot(q, async snapshot => {

    ordenesContainer.innerHTML = "";

    if (snapshot.empty) {
      ordenesContainer.innerHTML = `
        <div class="card-dark text-center">
          No tienes órdenes registradas.
        </div>
      `;
      return;
    }

    for (const docSnap of snapshot.docs) {

      const o = docSnap.data();
      const ordenId = docSnap.id;

      /* ========= Cargar stages ordenados ========= */

      const stagesSnap = await getDocs(
        query(
          collection(
            db,
            "empresas",
            empresaId,
            "sucursales",
            sucursalId,
            "ordenes",
            ordenId,
            "stages"
          ),
          orderBy("at","asc")
        )
      );

      const stages = stagesSnap.docs.map(d=>d.data());

      /* ========= Badge dinámico ========= */

      const estado = o.estado || "ingreso";

      const div = document.createElement("div");
      div.className = "card-dark";

      div.innerHTML = `
        <div class="d-flex justify-content-between">
          <div>
            <strong>${o.consecutivo || ""}</strong><br>
            Placa: ${o.placa || "-"}<br>
            Vehículo: ${o.vehiculo || "-"}
          </div>
          <div class="text-end">
            <span class="badge-estado estado-${estado}">
              ${estado}
            </span><br>
            <small>Total: $${o.total?.toLocaleString() || 0}</small>
          </div>
        </div>

        <ul class="timeline mt-2">
          ${renderTimeline(stages)}
        </ul>
      `;

      ordenesContainer.appendChild(div);

    }

  }, error=>{
    console.error(error);
    ordenesContainer.innerHTML = `
      <div class="card-dark text-center text-danger">
        Error cargando órdenes.
      </div>
    `;
  });

}

/* ================= INICIAR ================= */

escucharOrdenes();

</script>

</body>
</html>