<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TallerPRO360 ¬∑ Estado de tu veh√≠culo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { background:#0f172a; }
    .node {
      width:26px;height:26px;border-radius:9999px;
      display:flex;align-items:center;justify-content:center;
      background:#22c55e;color:#022c22;font-size:12px;
    }
    .node.pending {
      background:#334155;color:#94a3b8;
    }
  </style>
</head>

<body class="text-slate-200">

<!-- LOADER -->
<div id="loader" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
  <div class="text-center">
    <i class="fas fa-car text-4xl text-emerald-400 animate-pulse"></i>
    <p class="mt-3 text-sm text-slate-400">Consultando tu veh√≠culo‚Ä¶</p>
  </div>
</div>

<!-- ERROR -->
<section id="error" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="text-center">
    <i class="fas fa-circle-exclamation text-5xl text-red-400 mb-4"></i>
    <h2 class="text-xl font-bold">Orden no encontrada</h2>
    <p class="text-slate-400 mt-2 text-sm">
      Verifica el c√≥digo entregado por el taller.
    </p>
  </div>
</section>

<!-- DASHBOARD -->
<section id="app" class="hidden max-w-xl mx-auto p-5">

  <!-- HEADER -->
  <header class="mb-5">
    <img src="./logo.png" class="h-12 mb-3" alt="TallerPRO360">
    <h1 class="text-xl font-black text-emerald-400">
      Estado de tu veh√≠culo
    </h1>
    <p class="text-xs text-slate-400">
      Seguimiento en tiempo real
    </p>
  </header>

  <!-- INFO -->
  <div class="bg-slate-800 rounded-xl p-4 mb-5">
    <div class="grid grid-cols-2 gap-3 text-sm">
      <div>
        <p class="text-slate-400">Orden</p>
        <p id="codigo" class="font-bold"></p>
      </div>
      <div>
        <p class="text-slate-400">Estado actual</p>
        <p id="estado" class="font-bold text-emerald-400"></p>
      </div>
      <div>
        <p class="text-slate-400">Veh√≠culo</p>
        <p id="vehiculo"></p>
      </div>
      <div>
        <p class="text-slate-400">Placa</p>
        <p id="placa"></p>
      </div>
    </div>
  </div>

  <!-- TIMELINE -->
  <div class="bg-slate-800 rounded-xl p-4">
    <h3 class="text-sm font-bold mb-4 text-slate-300 uppercase">
      Progreso del servicio
    </h3>

    <div id="timeline" class="space-y-5 relative pl-8"></div>
  </div>

  <footer class="text-center text-[10px] text-slate-500 mt-6">
    TallerPRO360 ¬© 2026 ¬∑ Informaci√≥n autom√°tica
  </footer>
</section>

<!-- FIREBASE -->
<script type="module">
  import { db } from "./firebase-config.js";
  import {
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import { speakOrderStage } from "./js/serviceOrders.voice.js";

  const loader = document.getElementById("loader");
  const app = document.getElementById("app");
  const error = document.getElementById("error");

  const params = new URLSearchParams(window.location.search);
  const codigo = params.get("orden");

  if (!codigo) {
    loader.classList.add("hidden");
    error.classList.remove("hidden");
    throw new Error("C√≥digo requerido");
  }

  const ref = doc(db, "ordenes", codigo);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    loader.classList.add("hidden");
    error.classList.remove("hidden");
    throw new Error("Orden no existe");
  }

  const orden = snap.data();

  // Render info
  document.getElementById("codigo").textContent = orden.codigo;
  document.getElementById("estado").textContent = orden.estado;
  document.getElementById("vehiculo").textContent = orden.vehiculo;
  document.getElementById("placa").textContent = orden.placa;

  // VOZ üîä
  speakOrderStage(orden);

  // Timeline
  const timeline = document.getElementById("timeline");

  orden.timeline.forEach(t => {
    timeline.innerHTML += `
      <div class="relative">
        <div class="absolute left-0 top-1 node">
          <i class="fas fa-check"></i>
        </div>
        <div>
          <p class="font-bold text-sm">${t.estado}</p>
          <p class="text-[10px] text-slate-400">
            ${new Date(t.fecha.seconds * 1000).toLocaleString("es-CO")}
          </p>
        </div>
      </div>
    `;
  });

  loader.classList.add("hidden");
  app.classList.remove("hidden");
</script>

</body>
</html>