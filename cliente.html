<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexus-X | Terminal de Cliente Starlink</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #020617; --secondary: #0f172a; --accent: #3b82f6; 
            --gold: #f59e0b; --success: #10b981; --danger: #ef4444;
            --glass: rgba(15, 23, 42, 0.75);
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top, #1e293b 0%, #020617 100%); 
            color: #f1f5f9; 
            margin: 0; 
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .font-nexus { font-family: 'Orbitron', sans-serif; }
        
        /* Efecto Glassmorphism Nivel 3 */
        .glass-card { 
            background: var(--glass); 
            backdrop-filter: blur(30px); 
            border: 1px solid rgba(255,255,255,0.06); 
            border-radius: 40px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        }

        .neo-input { 
            background: rgba(0,0,0,0.4); 
            border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 25px; 
            padding: 22px; 
            color: white; 
            font-size: 20px;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .neo-input:focus { border-color: var(--gold); box-shadow: 0 0 25px rgba(245, 158, 11, 0.2); transform: scale(1.02); }

        /* Timeline de Ingeniería */
        .timeline-container { position: relative; padding-left: 45px; }
        .timeline-container::before { 
            content: ''; position: absolute; left: 18px; top: 0; bottom: 0; 
            width: 3px; background: linear-gradient(to bottom, var(--gold), transparent); 
        }
        .step-node { 
            position: absolute; left: 0; top: 0; width: 40px; height: 40px; 
            background: var(--secondary); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid rgba(255,255,255,0.1); transform: translateX(-50%);
            transition: 0.5s;
        }
        .step-active .step-node { background: var(--gold); color: var(--primary); box-shadow: 0 0 20px var(--gold); border-color: white; }
        .step-complete .step-node { background: var(--success); color: white; border-color: var(--success); }

        /* Report Cards (Carfax Style) */
        .report-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .report-badge { 
            background: rgba(255,255,255,0.03); 
            border-radius: 20px; 
            padding: 15px; 
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Animaciones */
        @keyframes pulse-gold { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .scanning { animation: pulse-gold 2s infinite; }
        .hidden { display: none !important; }

        #loader-nexus { 
            position: fixed; inset: 0; z-index: 9999; 
            background: var(--primary); display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
        }

        .btn-action {
            background: linear-gradient(135deg, var(--gold) 0%, #d97706 100%);
            color: var(--primary); font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            padding: 20px; border-radius: 25px;
            transition: 0.3s;
        }
        .btn-action:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>

<div id="loader-nexus">
    <div class="relative w-48 h-48 flex items-center justify-center">
        <div class="absolute inset-0 border-[3px] border-gold/10 rounded-full"></div>
        <div class="absolute inset-0 border-t-[3px] border-gold rounded-full animate-spin"></div>
        <img src="https://cdn-icons-png.flaticon.com/512/2555/2555013.png" class="w-20 h-20 brightness-200 grayscale" alt="Nexus Logo">
    </div>
    <div class="mt-10 text-center">
        <h2 class="font-nexus text-2xl tracking-[0.5em] text-white">NEXUS<span class="text-gold">-X</span></h2>
        <p class="text-[9px] text-slate-500 mt-2 uppercase font-black tracking-widest italic">Iniciando Enlace Satelital Starlink...</p>
    </div>
</div>

<nav class="sticky top-0 z-[1000] p-6 bg-slate-950/80 backdrop-blur-2xl border-b border-white/5">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="bg-gold/10 p-3 rounded-2xl border border-gold/20">
                <i class="fas fa-satellite-dish text-gold"></i>
            </div>
            <div>
                <span class="block text-[10px] font-black text-slate-500 uppercase tracking-widest">Global Status</span>
                <h1 class="font-nexus text-sm text-white">NEXUS HUB <span class="text-gold">v3.0</span></h1>
            </div>
        </div>
        <div id="badge-container" class="hidden flex items-center gap-2 bg-emerald-500/10 px-4 py-2 rounded-full border border-emerald-500/20">
            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span>
            <span class="text-[9px] font-black text-emerald-400 uppercase">Live Trace</span>
        </div>
    </div>
</nav>

<main class="max-w-2xl mx-auto p-6 space-y-10">
    
    <section id="search-box" class="space-y-8 py-10">
        <div class="text-center space-y-4">
            <h2 class="text-4xl font-black tracking-tighter">Tu vehículo, <br><span class="text-gold italic">bajo control total.</span></h2>
            <p class="text-slate-400 text-sm font-medium">Accede al diagnóstico de ingeniería en tiempo real.</p>
        </div>
        
        <div class="glass-card p-10 space-y-6">
            <div class="relative">
                <input id="placa-input" type="text" placeholder="PLACA (EJ: AAA000)" 
                       class="neo-input w-full text-center font-nexus uppercase placeholder:text-slate-700">
                <i class="fas fa-qrcode absolute right-6 top-1/2 -translate-y-1/2 text-slate-600"></i>
            </div>
            <button onclick="conectarUnidad()" class="btn-action w-full shadow-2xl shadow-gold/20 flex items-center justify-center gap-4">
                <i class="fas fa-bolt"></i> Vincular Mi Unidad
            </button>
        </div>
    </section>

    <section id="unit-dashboard" class="hidden space-y-10 animate-in fade-in duration-700">
        
        <div class="glass-card overflow-hidden">
            <div class="bg-gradient-to-r from-gold to-yellow-600 p-1 text-center">
                <p class="text-[9px] font-black text-slate-950 uppercase tracking-widest">Certificación de Servicio Nexus-X</p>
            </div>
            <div class="p-8 space-y-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 id="display-vehiculo" class="text-2xl font-black uppercase">KENWORTH T800</h3>
                        <p id="display-placa" class="font-nexus text-gold text-lg tracking-widest">PLACA: -</p>
                    </div>
                    <div class="text-right">
                        <span id="display-year" class="bg-white/5 px-4 py-2 rounded-xl text-xs font-bold text-slate-400">Año: 2024</span>
                    </div>
                </div>

                <div class="report-grid">
                    <div class="report-badge flex items-center gap-4">
                        <i class="fas fa-oil-can text-gold text-xl"></i>
                        <div>
                            <p class="text-[8px] text-slate-500 uppercase font-black">Estado Aceite</p>
                            <p class="text-xs font-bold text-emerald-400">Óptimo</p>
                        </div>
                    </div>
                    <div class="report-badge flex items-center gap-4">
                        <i class="fas fa-battery-three-quarters text-gold text-xl"></i>
                        <div>
                            <p class="text-[8px] text-slate-500 uppercase font-black">Sistema Eléctrico</p>
                            <p class="text-xs font-bold text-emerald-400">Verificado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card p-10">
            <h4 class="font-nexus text-[10px] text-gold uppercase tracking-[5px] mb-10">Hoja de Ruta del Servicio</h4>
            <div id="timeline-flow" class="timeline-container space-y-12">
                </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <button onclick="generarReporteSalud()" class="p-6 bg-slate-100 text-slate-950 rounded-[2rem] font-black uppercase text-[11px] tracking-widest flex items-center justify-center gap-4 shadow-xl">
                <i class="fas fa-file-pdf text-lg"></i> Descargar AutoCheck PDF
            </button>
            <button onclick="contactarIngeniero()" class="p-6 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 rounded-[2rem] font-black uppercase text-[11px] tracking-widest flex items-center justify-center gap-4">
                <i class="fab fa-whatsapp text-lg"></i> Consultar con el Ingeniero
            </button>
        </div>

    </section>

    <section id="not-found" class="hidden glass-card p-12 text-center space-y-6">
        <div class="w-24 h-24 bg-danger/10 text-danger rounded-full flex items-center justify-center mx-auto text-3xl">
            <i class="fas fa-search-minus"></i>
        </div>
        <h3 class="font-nexus text-xl text-white">Sin Registro en la Red</h3>
        <p class="text-slate-500 text-sm">No encontramos órdenes activas para esta placa. Contacta a soporte si crees que es un error.</p>
        <button onclick="location.reload()" class="text-gold text-[10px] font-black uppercase tracking-widest">Reintentar Conexión</button>
    </section>

</main>

<footer class="mt-20 py-10 border-t border-white/5 text-center px-6">
    <p class="text-[9px] text-slate-600 font-black uppercase tracking-[5px] mb-2">Powered by</p>
    <p class="text-xs font-bold text-white uppercase tracking-tighter">Colombian Trucks Logistics LLC <span class="text-gold">Charlotte, NC</span></p>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const stages = [
        { id: 'ingreso', label: 'Recepción Técnica', icon: 'fa-truck-ramp-box', desc: 'Registro de entrada y peritaje visual inicial.' },
        { id: 'diagnostico', label: 'Escaneo Starlink IA', icon: 'fa-microchip', desc: 'Análisis de códigos de falla y telemetría de motor.' },
        { id: 'reparacion', label: 'Intervención de Ingeniería', icon: 'fa-screwdriver-wrench', desc: 'Ejecución de mantenimiento según protocolo CTL LLC.' },
        { id: 'calidad', label: 'Certificación de Calidad', icon: 'fa-certificate', desc: 'Pruebas de ruta y validación de sistemas de seguridad.' },
        { id: 'entrega', label: 'Listo para Despacho', icon: 'fa-flag-checkered', desc: 'Unidad certificada y lista para operación nacional.' }
    ];

    let currentOrder = null;

    window.conectarUnidad = async () => {
        const placa = document.getElementById('placa-input').value.toUpperCase().trim();
        if(!placa) return alert("Ingrese una placa válida.");

        mostrarLoader(true);

        try {
            const q = query(collection(db, "ordenes"), where("placa", "==", placa), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);

            if(!snap.empty) {
                currentOrder = { id: snap.docs[0].id, ...snap.docs[0].data() };
                renderDashboard(currentOrder);
            } else {
                mostrarSeccion('not-found');
            }
        } catch (e) {
            console.error(e);
            alert("Error de enlace satelital. Reintente.");
        } finally {
            mostrarLoader(false);
        }
    };

    function renderDashboard(data) {
        document.getElementById('display-vehiculo').innerText = `${data.marca} ${data.modelo}`;
        document.getElementById('display-placa').innerText = `PLACA: ${data.placa}`;
        document.getElementById('display-year').innerText = `Año: ${data.año || 'N/A'}`;
        
        const timeline = document.getElementById('timeline-flow');
        timeline.innerHTML = '';

        let activeFound = false;
        stages.forEach(s => {
            const isActive = s.id === data.status;
            const isComplete = !activeFound && !isActive;
            if(isActive) activeFound = true;

            const stateClass = isActive ? 'step-active' : (isComplete ? 'step-complete' : '');

            timeline.innerHTML += `
                <div class="relative pl-10 ${stateClass}">
                    <div class="step-node">
                        <i class="fas ${s.icon} text-xs"></i>
                    </div>
                    <div>
                        <h5 class="text-sm font-black uppercase ${isActive ? 'text-gold' : 'text-slate-200'}">${s.label}</h5>
                        <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">${s.desc}</p>
                    </div>
                </div>
            `;
        });

        mostrarSeccion('unit-dashboard');
        document.getElementById('badge-container').classList.remove('hidden');
    }

    window.generarReporteSalud = () => {
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        
        // Estética Carfax/Autocheck
        docPDF.setFillColor(2, 6, 23);
        docPDF.rect(0, 0, 210, 297, 'F');
        
        docPDF.setTextColor(245, 158, 11);
        docPDF.setFontSize(26);
        docPDF.text("NEXUS-X AUTO-CHECK", 20, 30);
        
        docPDF.setTextColor(255, 255, 255);
        docPDF.setFontSize(10);
        docPDF.text("INFORME DE INGENIERÍA Y SALUD VEHICULAR", 20, 40);
        
        docPDF.line(20, 45, 190, 45);
        
        docPDF.setFontSize(14);
        docPDF.text(`VEHÍCULO: ${currentOrder.marca} ${currentOrder.modelo}`, 20, 60);
        docPDF.text(`IDENTIFICACIÓN: ${currentOrder.placa}`, 20, 70);
        docPDF.text(`TALLER EMISOR: TallerPro360 Global`, 20, 80);
        
        docPDF.setFillColor(15, 23, 42);
        docPDF.roundedRect(20, 90, 170, 60, 5, 5, 'F');
        docPDF.text("DIAGNÓSTICO TÉCNICO:", 30, 105);
        docPDF.setFontSize(10);
        docPDF.setTextColor(150, 150, 150);
        docPDF.text(currentOrder.notas || "Sin observaciones críticas registradas en sistema.", 30, 115, { maxWidth: 150 });
        
        docPDF.setTextColor(16, 185, 129);
        docPDF.text("ESTADO: UNIDAD CERTIFICADA PARA OPERACIÓN", 20, 250);
        
        docPDF.setTextColor(100, 100, 100);
        docPDF.text("Validado por Colombian Trucks Logistics LLC - Charlotte, NC", 20, 280);
        
        docPDF.save(`Reporte_Nexus_${currentOrder.placa}.pdf`);
    };

    function mostrarSeccion(id) {
        ['search-box', 'unit-dashboard', 'not-found'].forEach(s => {
            document.getElementById(s).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    function mostrarLoader(show) {
        document.getElementById('loader-nexus').classList.toggle('hidden', !show);
    }

    window.contactarIngeniero = () => {
        const msg = `Hola! Soy el propietario de la unidad ${currentOrder.placa}. Quisiera más detalles sobre el estado actual en Nexus-X.`;
        window.open(`https://wa.me/573115709730?text=${encodeURIComponent(msg)}`);
    };

    // Auto-init
    window.onload = () => {
        setTimeout(() => mostrarLoader(false), 2000);
    };
</script>
</body>
</html>
