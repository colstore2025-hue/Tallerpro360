<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 - Clientes</title>
<link rel="icon" href="logo-tallerpro360.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { background-color:#0a74da; color:white; text-align:center; padding:15px 0; }
  header img { height:40px; vertical-align: middle; margin-right:10px; }
  h1 { display:inline-block; margin:0; font-size:1.5em; }
  .container { padding:15px; max-width:800px; margin:auto; }
  input, button { padding:10px; margin:5px 0; width:100%; box-sizing:border-box; border-radius:5px; border:1px solid #ccc; }
  button { cursor:pointer; background:#0a74da; color:white; border:none; font-weight:bold; }
  .client-list { margin-top:20px; }
  .client-item { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
  .badge-estado { padding:2px 6px; border-radius:5px; font-size:0.85em; color:white; font-weight:bold; }
  .estado-INGRESO { background:#0d6efd; }
  .estado-DIAGNOSTICO { background:#fd7e14; }
  .estado-APROBADO { background:#198754; }
  .estado-EN_PROCESO { background:#ffc107; color:black; }
  .estado-LISTO { background:#0dcaf0; color:black; }
  .estado-ENTREGADO { background:#6c757d; }
  .timeline { list-style:none; padding-left:0; margin-top:5px; }
  .timeline li { margin-bottom:5px; }
  .logout-btn { float:right; background:#dc3545; margin-top:-35px; }
</style>
</head>

<body>

<header>
  <img src="logo-tallerpro360.png" alt="TallerPRO360">
  <h1>Panel de Clientes</h1>
  <button class="btn btn-sm logout-btn" onclick="logout()">Salir</button>
</header>

<div class="container">

  <!-- Bienvenida -->
  <div id="bienvenida" class="mb-4 text-center"></div>

  <!-- Registrar Cliente (oculto para clientes existentes) -->
  <div id="registroCliente" class="card mb-3 p-3 shadow-sm d-none">
    <h5>Registrar Cliente</h5>
    <input type="text" id="clienteNombreReg" placeholder="Nombre completo" required>
    <input type="email" id="clienteEmailReg" placeholder="Correo electrónico" required>
    <input type="tel" id="clienteTelefonoReg" placeholder="Teléfono" required>
    <input type="password" id="clientePasswordReg" placeholder="Contraseña" required>
    <button onclick="registrarCliente()">Registrar Cliente</button>
  </div>

  <!-- Login Cliente -->
  <div id="loginCliente" class="card mb-3 p-3 shadow-sm">
    <h5>Ingresar</h5>
    <input type="email" id="clienteEmailLogin" placeholder="Correo electrónico" required>
    <input type="password" id="clientePasswordLogin" placeholder="Contraseña" required>
    <button onclick="loginCliente()">Ingresar</button>
  </div>

  <!-- Lista de órdenes -->
  <div id="ordenesList" class="client-list d-none"></div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script type="module">
import { speakOrderStage, listenOrderVoice, initVoiceActivation } from './serviceOrders.voice.js';
initVoiceActivation(); // Activar voz

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();
let userCliente = null;

// === REGISTRAR CLIENTE ===
window.registrarCliente = async () => {
  const nombre = document.getElementById("clienteNombreReg").value.trim();
  const email = document.getElementById("clienteEmailReg").value.trim();
  const telefono = document.getElementById("clienteTelefonoReg").value.trim();
  const pass = document.getElementById("clientePasswordReg").value.trim();
  if(!nombre || !email || !telefono || !pass) return alert("Todos los campos son obligatorios");
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection("clientes").doc(cred.user.uid).set({nombre,email,telefono,creadoEn:firebase.firestore.Timestamp.now()});
    alert("Cliente registrado correctamente. Ya puede iniciar sesión.");
    document.getElementById("registroCliente").style.display="none";
  } catch(err){ alert(err.message); }
};

// === LOGIN CLIENTE ===
window.loginCliente = async () => {
  const email = document.getElementById("clienteEmailLogin").value.trim();
  const pass = document.getElementById("clientePasswordLogin").value.trim();
  if(!email || !pass) return alert("Completa todos los campos");
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    userCliente = cred.user;
    document.getElementById("loginCliente").style.display="none";
    document.getElementById("bienvenida").innerHTML = `<h4>Bienvenido, ${userCliente.email}</h4>`;
    cargarOrdenes();
  } catch(err){ alert(err.message); }
};

// === LOGOUT ===
window.logout = async () => {
  await auth.signOut();
  location.reload();
};

// === CARGAR ORDENES ===
function cargarOrdenes(){
  if(!userCliente) return;
  const ordenesDiv = document.getElementById("ordenesList");
  ordenesDiv.innerHTML="";
  ordenesDiv.classList.remove("d-none");

  db.collection("ordenes").where("clienteId","==",userCliente.uid)
    .orderBy("actualizadoEn","desc")
    .onSnapshot(snapshot=>{
      ordenesDiv.innerHTML="";
      snapshot.forEach(doc=>{
        const o = doc.data();
        const div = document.createElement("div");
        div.className = "client-item";
        const timelineHTML = o.timeline?.map(t=>`<li>${t.estado} - ${t.fecha?.toDate().toLocaleString() || ''}</li>`).join("");
        div.innerHTML = `
          <strong>${o.codigo}</strong><br>
          Vehículo: ${o.vehiculo} (${o.placa})<br>
          Estado: <span class="badge-estado estado-${o.estado}">${o.estado}</span>
          <ul class="timeline">${timelineHTML}</ul>
          Última actualización: ${o.actualizadoEn?.toDate().toLocaleString() || ''}
        `;
        ordenesDiv.appendChild(div);
        listenOrderVoice(db,o.codigo);
      });
    });
}
</script>

</body>
</html>