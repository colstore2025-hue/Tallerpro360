<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 - Clientes</title>
<link rel="icon" href="logo-tallerpro360.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { background-color:#0a74da; color:white; text-align:center; padding:15px 0; }
  header img { height:40px; vertical-align: middle; margin-right:10px; }
  h1 { display:inline-block; margin:0; font-size:1.5em; }
  .container { padding:15px; max-width:800px; margin:auto; }
  input, button { padding:10px; margin:5px 0; width:100%; box-sizing:border-box; border-radius:5px; border:1px solid #ccc; }
  button { cursor:pointer; background:#0a74da; color:white; border:none; font-weight:bold; }
  .client-item { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
  .badge-estado { padding:4px 8px; border-radius:5px; font-size:0.85em; color:white; font-weight:bold; }
  .estado-INGRESO { background:#0d6efd; }
  .estado-DIAGNOSTICO { background:#fd7e14; }
  .estado-APROBADO { background:#198754; }
  .estado-EN_PROCESO { background:#ffc107; color:black; }
  .estado-LISTO { background:#0dcaf0; color:black; }
  .estado-ENTREGADO { background:#6c757d; }
  .timeline { list-style:none; padding-left:0; margin-top:10px; font-size:0.9em; }
  .timeline li { margin-bottom:5px; }
  .logout-btn { float:right; background:#dc3545; margin-top:-35px; }
</style>
</head>

<body>

<header>
  <img src="logo-tallerpro360.png" alt="TallerPRO360">
  <h1>Panel de Clientes</h1>
  <button class="btn btn-sm logout-btn" onclick="logout()">Salir</button>
</header>

<div class="container">

  <div id="bienvenida" class="mb-4 text-center"></div>

  <div id="loginCliente" class="card mb-3 p-3 shadow-sm">
    <h5>Ingresar</h5>
    <input type="email" id="clienteEmailLogin" placeholder="Correo electr칩nico" required>
    <input type="password" id="clientePasswordLogin" placeholder="Contrase침a" required>
    <button onclick="loginCliente()">Ingresar</button>
  </div>

  <div id="ordenesList" class="d-none"></div>

</div>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script type="module">
import { listenOrderVoice, initVoiceActivation } from './serviceOrders.voice.js';

initVoiceActivation();

// 游댠 CAMBIAR POR EL ID REAL DEL TALLER
const EMPRESA_ID = "demo"; 

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

let userCliente = null;

// ===============================
// LOGIN
// ===============================

window.loginCliente = async () => {
  const email = document.getElementById("clienteEmailLogin").value.trim();
  const pass = document.getElementById("clientePasswordLogin").value.trim();

  if(!email || !pass) return alert("Completa todos los campos");

  try {
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    userCliente = cred.user;

    document.getElementById("loginCliente").style.display="none";
    document.getElementById("bienvenida").innerHTML =
      `<h4>Bienvenido, ${userCliente.email}</h4>`;

    cargarOrdenes();

  } catch(err){
    alert(err.message);
  }
};

// ===============================
// LOGOUT
// ===============================

window.logout = async () => {
  await auth.signOut();
  location.reload();
};

// ===============================
// CARGAR 칍RDENES (MULTIEMPRESA)
// ===============================

function cargarOrdenes(){

  const ordenesDiv = document.getElementById("ordenesList");
  ordenesDiv.classList.remove("d-none");

  db.collection("talleres")
    .doc(EMPRESA_ID)
    .collection("ordenes")
    .where("clienteId","==",userCliente.uid)
    .orderBy("updatedAt","desc")
    .onSnapshot(async snapshot => {

      ordenesDiv.innerHTML = "";

      for (const docSnap of snapshot.docs) {

        const o = docSnap.data();
        const ordenId = docSnap.id;

        // 游댳 Cargar stages reales
        const stagesSnap = await db
          .collection("talleres")
          .doc(EMPRESA_ID)
          .collection("ordenes")
          .doc(ordenId)
          .collection("stages")
          .orderBy("at","desc")
          .get();

        const timelineHTML = stagesSnap.docs.map(s => {
          const data = s.data();
          const fecha = data.at?.toDate()?.toLocaleString() || "";
          return `<li>${data.stage || data.type} - ${fecha}</li>`;
        }).join("");

        const div = document.createElement("div");
        div.className = "client-item";

        div.innerHTML = `
          <strong>${o.codigo}</strong><br>
          Veh칤culo: ${o.vehiculo || ""} (${o.placa || ""})<br>
          Estado: 
          <span class="badge-estado estado-${o.status}">
            ${o.status}
          </span>

          <ul class="timeline">
            ${timelineHTML}
          </ul>

          칔ltima actualizaci칩n:
          ${o.updatedAt?.toDate()?.toLocaleString() || ""}
        `;

        ordenesDiv.appendChild(div);

        // 游댉 Activar voz autom치tica
        listenOrderVoice(db, EMPRESA_ID, ordenId);
      }

    });
}

</script>

</body>
</html>