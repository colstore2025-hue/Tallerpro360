<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEO Â· AprobaciÃ³n de Pagos | TallerPRO360</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body { background:#0f172a; color:#f1f5f9; }
  .glass {
    background:rgba(15,23,42,.75);
    backdrop-filter: blur(20px);
    border-radius:1.5rem;
    border:1px solid rgba(255,255,255,.08);
  }
</style>
</head>

<body class="min-h-screen p-6">

<header class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-bold text-amber-500">
    ðŸ’³ AprobaciÃ³n de Pagos
  </h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded font-bold">
    Cerrar sesiÃ³n
  </button>
</header>

<div class="glass p-6 overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="text-gray-400 border-b border-gray-700">
      <tr>
        <th class="py-2 text-left">Taller</th>
        <th>Email</th>
        <th>MÃ©todo</th>
        <th>Comprobante</th>
        <th>Fecha</th>
        <th>AcciÃ³n</th>
      </tr>
    </thead>
    <tbody id="tablaPagos"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tabla = document.getElementById("tablaPagos");

// ðŸ” Seguridad CEO
onAuthStateChanged(auth, async user => {
  if (!user) location.href="login.html";

  const ref = doc(db,"usuarios",user.uid);
  const snap = await getDoc(ref);
  if (!snap.exists() || snap.data().rol !== "ceo") {
    alert("Acceso denegado");
    signOut(auth);
  }

  cargarPagos();
});

function cargarPagos(){
  onSnapshot(collection(db,"pagos"), snap => {
    tabla.innerHTML = "";
    snap.forEach(d => {
      const p = d.data();
      if (p.estado !== "pendiente") return;

      const fecha = p.creadoEn?.toDate().toLocaleString() || "";

      tabla.innerHTML += `
      <tr class="border-b border-gray-800 hover:bg-slate-900/50">
        <td class="py-2 font-bold">${p.uid}</td>
        <td>${p.email}</td>
        <td>${p.metodo}</td>
        <td>
          <a href="${p.comprobanteURL}" target="_blank"
            class="text-amber-400 underline">Ver</a>
        </td>
        <td>${fecha}</td>
        <td>
          <button
            onclick="aprobarPago('${d.id}','${p.uid}')"
            class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded font-bold">
            Aprobar
          </button>
        </td>
      </tr>`;
    });
  });
}

window.aprobarPago = async (pagoId, uid) => {
  if (!confirm("Â¿Aprobar este pago?")) return;

  const hoy = new Date();
  const vence = new Date();
  vence.setDate(hoy.getDate() + 30);

  // Activar taller
  await updateDoc(doc(db,"usuarios",uid),{
    status:"ACTIVO",
    vence: Timestamp.fromDate(vence)
  });

  // Marcar pago aprobado
  await updateDoc(doc(db,"pagos",pagoId),{
    estado:"aprobado",
    aprobadoEn: Timestamp.now()
  });

  alert("âœ… Pago aprobado y taller activado");
};

window.logout = () => signOut(auth).then(()=>location.href="login.html");
</script>

</body>
</html>