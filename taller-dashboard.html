<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 | ERP Master</title>
<link rel="icon" href="logo-tallerpro360.png">

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0f172a,#111827);color:#f1f5f9;}
.erp-wrapper{display:flex;height:100vh;overflow:hidden;}
.sidebar{width:260px;background:rgba(15,23,42,.95);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.05);padding:30px 20px;display:flex;flex-direction:column;}
.logo{font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;margin-bottom:50px;}
.logo span{background:linear-gradient(90deg,#22c55e,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-btn{background:none;border:none;color:#94a3b8;padding:14px;text-align:left;border-radius:12px;margin-bottom:8px;transition:.3s;font-weight:600;}
.nav-btn:hover,.nav-btn.active{background:rgba(34,197,94,.1);color:#22c55e;}
.main-content{flex:1;padding:40px;overflow-y:auto;}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
.metric-card{padding:1.5rem;border-radius:1rem;background:rgba(15,23,42,.7);border:1px solid rgba(255,255,255,.05);}
table th, table td{padding:10px;text-align:left;}
input[type="date"]{background:#0f172a;border:1px solid #1e293b;padding:6px 10px;border-radius:8px;color:#fff;}
</style>
</head>
<body>

<div class="erp-wrapper">
<aside class="sidebar">
  <div class="logo">Taller<span>PRO360</span></div>

  <button class="nav-btn active" data-section="dashboard"><i class="fa-solid fa-chart-line mr-2"></i> Dashboard</button>
  <button class="nav-btn" data-section="ordenes"><i class="fa-solid fa-car mr-2"></i> Órdenes</button>
  <button class="nav-btn" data-section="inventario"><i class="fa-solid fa-boxes-stacked mr-2"></i> Inventario</button>
  <button class="nav-btn" data-section="finanzas"><i class="fa-solid fa-coins mr-2"></i> Finanzas</button>
  <button class="nav-btn" data-section="nomina"><i class="fa-solid fa-users mr-2"></i> Nómina</button>
</aside>

<main class="main-content">
<header class="topbar">
  <div>
    <h2 id="sectionTitle" class="text-2xl font-bold">Dashboard</h2>
    <p class="text-slate-400 text-sm">Centro de control operativo en tiempo real</p>
  </div>
  <button id="logoutBtn" class="border px-3 py-1 rounded">Salir</button>
</header>

<section id="contentArea"></section>
</main>
</div>

<script type="module">

import { getFirestore, collection, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getAuth, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const db = getFirestore();
const auth = getAuth();

const empresaId = localStorage.getItem("empresaId");
const rol = localStorage.getItem("rol");

if(!empresaId && rol!=="superadmin") window.location.href="index.html";

let ordenes=[];
let chartFinanzas=null;

// ================= AUTH =================
onAuthStateChanged(auth,user=>{
  if(!user) window.location.href="index.html";
});

// ================= REALTIME =================
function iniciarRealtime(){
  let ref = rol==="superadmin"
    ? collection(db,"ordenesGlobal")
    : collection(db,"empresas",empresaId,"ordenes");

  onSnapshot(ref,(snapshot)=>{
    ordenes=[];
    snapshot.forEach(doc=>ordenes.push({id:doc.id,...doc.data()}));
    renderDashboard(ordenes);
  });
}

// ================= DASHBOARD =================
function renderDashboard(data){

  const ingresos=data.reduce((s,o)=>s+(o.pagado||0),0);
  const activas=data.filter(o=>o.estado!=="entregado").length;
  const crm=data.length?Math.round(data.reduce((s,o)=>s+(o.crmScore||0),0)/data.length):0;
  const proyeccion=Math.round((ingresos/data.length||0)*30);

  document.getElementById("contentArea").innerHTML=`
  <div class="flex gap-4 mb-6">
    <input type="date" id="fDesde">
    <input type="date" id="fHasta">
    <button onclick="aplicarFiltros()" class="bg-green-600 px-4 py-1 rounded">Filtrar</button>
  </div>

  <div class="grid md:grid-cols-4 gap-6 mb-8">
    ${kpi("Ingresos", "$"+ingresos.toLocaleString())}
    ${kpi("Órdenes Activas", activas)}
    ${kpi("CRM Promedio", crm)}
    ${kpi("Proyección IA", "$"+proyeccion.toLocaleString())}
  </div>

  <div class="bg-slate-900/60 p-6 rounded-2xl mb-8">
    <h3 class="mb-4 font-semibold">Panel Financiero Mensual</h3>
    <canvas id="chartFinanzas"></canvas>
  </div>

  <div class="bg-slate-900/60 p-6 rounded-2xl">
    <h3 class="mb-4 font-semibold">Órdenes</h3>
    ${renderTabla(data)}
  </div>
  `;

  renderGrafico(data);
}

function kpi(t,v){
  return `<div class="metric-card"><div class="text-slate-400">${t}</div><h2 class="text-3xl font-bold">${v}</h2></div>`;
}

// ================= FILTROS =================
window.aplicarFiltros=function(){
  const d=document.getElementById("fDesde").value;
  const h=document.getElementById("fHasta").value;

  let filtradas=[...ordenes];

  if(d){
    const fd=new Date(d);
    filtradas=filtradas.filter(o=>o.creadoEn?.seconds && new Date(o.creadoEn.seconds*1000)>=fd);
  }

  if(h){
    const fh=new Date(h);
    filtradas=filtradas.filter(o=>o.creadoEn?.seconds && new Date(o.creadoEn.seconds*1000)<=fh);
  }

  renderDashboard(filtradas);
}

// ================= TABLA =================
function renderTabla(data){
  if(!data.length) return "<div>No hay órdenes</div>";

  return `<table class="w-full text-sm">
  <thead><tr class="text-slate-400 border-b border-slate-700">
  <th>Cliente</th><th>Placa</th><th>Estado</th><th>Total</th><th>CRM</th><th>PDF</th>
  </tr></thead>
  <tbody>
  ${data.map(o=>`
  <tr class="border-b border-slate-800">
    <td>${o.clienteNombre||"-"}</td>
    <td>${o.placa||"-"}</td>
    <td>${o.estado||"-"}</td>
    <td>$${(o.totalOrden||0).toLocaleString()}</td>
    <td>${o.crmScore||0}</td>
    <td><button onclick="generarPDF('${o.id}')" class="bg-green-600 px-2 py-1 rounded text-xs">PDF</button></td>
  </tr>`).join("")}
  </tbody></table>`;
}

// ================= GRAFICO =================
function renderGrafico(data){
  const meses=Array(12).fill(0);
  data.forEach(o=>{
    if(o.creadoEn?.seconds){
      const f=new Date(o.creadoEn.seconds*1000);
      meses[f.getMonth()]+=o.pagado||0;
    }
  });

  if(chartFinanzas) chartFinanzas.destroy();

  chartFinanzas=new Chart(document.getElementById("chartFinanzas"),{
    type:"bar",
    data:{labels:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],
    datasets:[{data:meses,backgroundColor:"#22c55e"}]},
    options:{plugins:{legend:{display:false}}}
  });
}

// ================= PDF =================
window.generarPDF=function(id){
  const o=ordenes.find(x=>x.id===id);
  if(!o) return;
  const blob=new Blob([`Orden ${o.id}\nCliente:${o.clienteNombre}\nTotal:${o.totalOrden}`],{type:"application/pdf"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="orden-"+o.id+".pdf";
  link.click();
};

// ================= NAV =================
document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("sectionTitle").innerText=btn.innerText.trim();
    renderDashboard(ordenes);
  });
});

// ================= LOGOUT =================
document.getElementById("logoutBtn").addEventListener("click",async()=>{
  await signOut(auth);
  localStorage.clear();
  window.location.href="index.html";
});

iniciarRealtime();

</script>
</body>
</html>