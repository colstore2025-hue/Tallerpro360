<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 | Dashboard Taller</title>

<!-- Tailwind + Icons + Charts + Excel Export -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family:'Inter',sans-serif; background:#f5f5f5; color:#1f2937; }
.font-nexus{font-family:'Orbitron',sans-serif}
.glass{background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-radius:1rem; border:1px solid rgba(0,0,0,.05);}
.status-activo{color:#10b981;background:rgba(16,185,129,.1);padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;}
.status-suspendido{color:#ef4444;background:rgba(239,68,68,.1);padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;}
.kpi {text-align:center;}
.kpi h2 {font-size:2rem; font-weight:700;}
</style>
</head>
<body class="p-6">

<header class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-nexus text-amber-500">TallerPRO360 <span class="text-gray-700 text-lg">Dashboard</span></h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded font-bold text-white hover:bg-red-700"><i class="fas fa-power-off"></i> Salir</button>
</header>

<!-- KPIs -->
<section class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
  <div class="glass p-4 kpi">
    <p class="text-gray-500 uppercase text-xs">Órdenes totales</p>
    <h2 id="kpiOrdenes">0</h2>
  </div>
  <div class="glass p-4 kpi">
    <p class="text-gray-500 uppercase text-xs">Órdenes activas</p>
    <h2 id="kpiActivas">0</h2>
  </div>
  <div class="glass p-4 kpi">
    <p class="text-gray-500 uppercase text-xs">Clientes</p>
    <h2 id="kpiClientes">0</h2>
  </div>
  <div class="glass p-4 kpi">
    <p class="text-gray-500 uppercase text-xs">Ingresos</p>
    <h2 id="kpiIngresos">$0</h2>
  </div>
  <div class="glass p-4 kpi">
    <p class="text-gray-500 uppercase text-xs">Utilidad P&G</p>
    <h2 id="kpiUtilidad">$0</h2>
  </div>
</section>

<!-- Órdenes -->
<section class="glass p-4 mb-6">
  <h2 class="font-bold mb-3">Órdenes de Servicio</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="ordenesTabla">
      <thead class="text-gray-500 uppercase text-xs">
        <tr>
          <th>Orden</th>
          <th>Cliente</th>
          <th>Vehículo</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- Inventario -->
<section class="glass p-4 mb-6">
  <h2 class="font-bold mb-3">Inventario</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="inventarioTabla">
      <thead class="text-gray-500 uppercase text-xs">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Costo Unitario</th>
          <th>Total</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="mt-2 bg-blue-600 text-white px-3 py-1 rounded" onclick="exportInventario()">Exportar Excel</button>
  </div>
</section>

<!-- Finanzas -->
<section class="glass p-4 mb-6">
  <h2 class="font-bold mb-3">Finanzas</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="finanzasTabla">
      <thead class="text-gray-500 uppercase text-xs">
        <tr>
          <th>Tipo</th>
          <th>Concepto</th>
          <th>Monto</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="mt-2 bg-green-600 text-white px-3 py-1 rounded" onclick="exportFinanzas()">Exportar Excel</button>
  </div>
</section>

<!-- Charts -->
<section class="glass p-4 mb-6">
  <h2 class="font-bold mb-3">Gráficos</h2>
  <canvas id="chartFinanzas"></canvas>
</section>

<footer class="text-center text-xs text-gray-500 mt-6">
© 2026 TallerPRO360 · Dashboard Taller
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let tallerId = null;

// Autenticación
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";
  const snap = await db.collection("usuarios").doc(user.uid).get();
  if(!snap.exists) return location.href="index.html";
  const data = snap.data();
  if(data.rol!=="taller") return location.href="index.html";
  tallerId = user.uid;
  cargarDashboard();
});

// Logout
function logout(){ auth.signOut().then(()=>location.href="index.html"); }

// Cargar dashboard
async function cargarDashboard(){
  // KPIs
  const ordenSnap = await db.collection("ordenes").where("tallerId","==",tallerId).get();
  document.getElementById("kpiOrdenes").innerText = ordenSnap.size;
  let activas = 0, ingresos = 0, utilidad = 0;
  ordenSnap.forEach(o=>{
    if(o.data().estado!=="ENTREGADO") activas++;
    ingresos += o.data().total || 0;
    utilidad += o.data().utilidad || 0;
  });
  document.getElementById("kpiActivas").innerText = activas;
  document.getElementById("kpiIngresos").innerText = `$${ingresos.toLocaleString()}`;
  document.getElementById("kpiUtilidad").innerText = `$${utilidad.toLocaleString()}`;

  // Clientes
  const clientesSnap = await db.collection("clientes").where("tallerId","==",tallerId).get();
  document.getElementById("kpiClientes").innerText = clientesSnap.size;

  // Cargar tablas
  cargarOrdenes();
  cargarInventario();
  cargarFinanzas();
  renderChart();
}

// Cargar órdenes
function cargarOrdenes(){
  db.collection("ordenes").where("tallerId","==",tallerId).orderBy("creadoEn","desc").onSnapshot(snap=>{
    const tbody = document.querySelector("#ordenesTabla tbody");
    tbody.innerHTML="";
    snap.forEach(d=>{
      const o = d.data();
      tbody.innerHTML += `
        <tr>
          <td>${o.codigo}</td>
          <td>${o.cliente?.nombre||"-"}</td>
          <td>${o.vehiculo||"-"}</td>
          <td><span class="status-${o.estado.toLowerCase()}">${o.estado}</span></td>
          <td>${o.creadoEn?.toDate().toLocaleDateString()||"-"}</td>
          <td>$${(o.total||0).toLocaleString()}</td>
          <td><button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="avanzarOrden('${d.id}','${o.estado}')">Avanzar</button></td>
        </tr>
      `;
    });
  });
}

// Avanzar orden
function avanzarOrden(id,estado){
  const estados = ["INGRESO","DIAGNOSTICO","APROBADO","EN PROCESO","LISTO","ENTREGADO"];
  const i = estados.indexOf(estado);
  if(i < estados.length-1){
    const nuevo = estados[i+1];
    db.collection("ordenes").doc(id).update({estado:nuevo});
  }
}

// Inventario
function cargarInventario(){
  db.collection("inventario").where("tallerId","==",tallerId).onSnapshot(snap=>{
    const tbody = document.querySelector("#inventarioTabla tbody");
    tbody.innerHTML="";
    snap.forEach(d=>{
      const i = d.data();
      tbody.innerHTML += `
        <tr>
          <td>${i.nombre}</td>
          <td>${i.cantidad}</td>
          <td>$${i.costo}</td>
          <td>$${(i.cantidad*i.costo).toLocaleString()}</td>
          <td><button class="bg-red-600 text-white px-2 py-1 rounded" onclick="eliminarInventario('${d.id}')">Eliminar</button></td>
        </tr>
      `;
    });
  });
}

function eliminarInventario(id){ db.collection("inventario").doc(id).delete(); }
function exportInventario(){
  const wb = XLSX.utils.table_to_book(document.getElementById("inventarioTabla"));
  XLSX.writeFile(wb,"inventario.xlsx");
}

// Finanzas
function cargarFinanzas(){
  db.collection("finanzas").where("tallerId","==",tallerId).onSnapshot(snap=>{
    const tbody = document.querySelector("#finanzasTabla tbody");
    tbody.innerHTML="";
    snap.forEach(d=>{
      const f = d.data();
      tbody.innerHTML += `
        <tr>
          <td>${f.tipo}</td>
          <td>${f.concepto}</td>
          <td>$${f.monto.toLocaleString()}</td>
          <td>${f.fecha?.toDate().toLocaleDateString()||"-"}</td>
        </tr>
      `;
    });
  });
}
function exportFinanzas(){
  const wb = XLSX.utils.table_to_book(document.getElementById("finanzasTabla"));
  XLSX.writeFile(wb,"finanzas.xlsx");
}

// Chart Finanzas
let chart;
function renderChart(){
  db.collection("finanzas").where("tallerId","==",tallerId).onSnapshot(snap=>{
    const ingresos = [], egresos = [], labels = [];
    snap.forEach(f=>{
      const data = f.data();
      labels.push(data.fecha?.toDate().toLocaleDateString()||"-");
      if(data.tipo==="Ingreso") ingresos.push(data.monto); else egresos.push(data.monto);
    });
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("chartFinanzas"),{
      type:"bar",
      data:{labels, datasets:[
        {label:"Ingresos",data:ingresos,backgroundColor:"#10b981"},
        {label:"Egresos",data:egresos,backgroundColor:"#ef4444"}
      ]},
      options:{responsive:true, plugins:{legend:{position:"top"}}}
    });
  });
}
</script>
</body>
</html>