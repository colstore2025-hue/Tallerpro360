<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 | Panel Cliente</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background: linear-gradient(135deg,#0f172a,#111827);
  color:#f1f5f9;
  font-family:'Inter',sans-serif;
}
.glass{
  background: rgba(15,23,42,.7);
  backdrop-filter: blur(20px);
  border-radius: 1.5rem;
  border: 1px solid rgba(255,255,255,.05);
  padding: 1.5rem;
}
.title-gradient{
  background: linear-gradient(90deg,#22c55e,#38bdf8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight:900;
}
.badge-status{
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}
.badge-ingreso{ background:rgba(59,130,246,.2); color:#38bdf8;}
.badge-proceso{ background:rgba(34,197,94,.2); color:#22c55e;}
.badge-entregado{ background:rgba(250,204,21,.2); color:#facc15;}
button{ border-radius:12px !important; }
input{
  background:#1e293b !important;
  border:1px solid rgba(255,255,255,.1) !important;
  color:#fff !important;
}
.form-floating label{
  color:#ffffff !important;
  font-weight:600;
}

.form-control{
  background:#0f172a !important;
  border:1px solid rgba(255,255,255,.2) !important;
  color:#ffffff !important;
}

.form-control::placeholder{
  color:#cbd5e1 !important;
}

.form-control:focus{
  border-color:#22c55e !important;
  box-shadow:0 0 0 .25rem rgba(34,197,94,.3) !important;
}

</style>
</head>

<body class="p-4">

<div class="container">

<div class="text-center mb-5">
<h1 class="title-gradient">Panel Cliente</h1>
<p class="text-secondary">Gestiona tus 贸rdenes en tiempo real</p>
<button id="logoutBtn" class="btn btn-sm btn-outline-light mt-2 d-none">Cerrar sesi贸n</button>
</div>

<div id="registroCliente" class="glass mb-4">
<h5 class="mb-3">Registrar Cliente</h5>
<form id="formCliente">
<input type="text" id="clienteNombreReg" class="form-control mb-2" placeholder="Nombre completo" required>
<input type="email" id="clienteEmailReg" class="form-control mb-2" placeholder="Correo electr贸nico" required>
<input type="tel" id="clienteTelefonoReg" class="form-control mb-2" placeholder="Tel茅fono" required>
<input type="password" id="clientePasswordReg" class="form-control mb-2" placeholder="Contrase帽a" required>
<button type="submit" class="btn btn-success w-100 mt-2">Registrar</button>
</form>
</div>

<div id="loginCliente" class="glass mb-4">
<h5 class="mb-4 text-info">Iniciar Sesi贸n</h5>

<form id="formLogin">

<div class="form-floating mb-3">
  <input type="email" class="form-control" id="clienteEmailLogin" placeholder="Correo electr贸nico" required>
  <label for="clienteEmailLogin">Correo electr贸nico</label>
</div>

<div class="form-floating mb-3">
  <input type="password" class="form-control" id="clientePasswordLogin" placeholder="Contrase帽a" required>
  <label for="clientePasswordLogin">Contrase帽a</label>
</div>

<button type="submit" class="btn btn-primary w-100 py-2">
Ingresar
</button>

</form>
</div>

<div id="crearOrden" class="glass mb-4 d-none">
<h5 class="mb-3">Nueva Orden</h5>
<form id="formOrden">
<input type="text" id="placa" class="form-control mb-2" placeholder="Placa del veh铆culo" required>
<input type="text" id="vehiculo" class="form-control mb-2" placeholder="Marca / Modelo" required>
<button type="submit" class="btn btn-success w-100 mt-2">Crear Orden</button>
</form>
</div>

<div id="ordenesList" class="glass d-none">
<h5 class="mb-3">rdenes Activas</h5>
<ul class="list-group bg-transparent" id="ordenesUl"></ul>
</div>

</div>
<script type="module">

import { db } from "./firebase-config.js";
import {
  collection,
  addDoc,
  query,
  where,
  onSnapshot,
  serverTimestamp,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= VALIDACIN DE SESIN ================= */

const empresaId = localStorage.getItem("empresaId");
const rol = localStorage.getItem("rol");
const uid = localStorage.getItem("uid");
const sucursalId = localStorage.getItem("sucursalId");

if (!empresaId || !rol || !uid) {
  window.location.href = "login.html";
}

/* Solo staff interno */
if (rol === "cliente") {
  window.location.href = "login.html";
}

/* ================= ELEMENTOS ================= */

const crearOrdenDiv = document.getElementById("crearOrden");
const ordenesListDiv = document.getElementById("ordenesList");
const ordenesUl = document.getElementById("ordenesUl");
const logoutBtn = document.getElementById("logoutBtn");
const formOrden = document.getElementById("formOrden");

/* Limpiar interfaz heredada */
document.getElementById("registroCliente")?.remove();
document.getElementById("loginCliente")?.remove();

crearOrdenDiv.classList.remove("d-none");
ordenesListDiv.classList.remove("d-none");
logoutBtn.classList.remove("d-none");

/* ================= LOGOUT LIMPIO ================= */

logoutBtn.addEventListener("click", ()=>{
  localStorage.clear();
  window.location.href = "login.html";
});

/* ================= CREAR ORDEN (INGRESO MANUAL) ================= */

formOrden.addEventListener("submit", async e=>{
  e.preventDefault();

  await addDoc(
    collection(
      db,
      "empresas",
      empresaId,
      "sucursales",
      sucursalId,
      "ordenes"
    ),
    {
      clienteId: null,                 // puede vincularse luego
      placa: placa.value,
      vehiculo: vehiculo.value,
      estado: "ingreso",
      fechaIngreso: serverTimestamp(),
      creadoPor: uid,
      origen: "taller",                //  importante CRM
      visibleCliente: false
    }
  );

  formOrden.reset();
});

/* ================= ESCUCHAR RDENES ================= */

function escucharOrdenes(){

  const q = query(
    collection(
      db,
      "empresas",
      empresaId,
      "sucursales",
      sucursalId,
      "ordenes"
    )
  );

  onSnapshot(q,(snapshot)=>{

    ordenesUl.innerHTML="";

    if(snapshot.empty){
      ordenesUl.innerHTML = `
        <li class="list-group-item bg-transparent text-white">
          No hay 贸rdenes registradas
        </li>
      `;
      return;
    }

    snapshot.forEach(docSnap=>{

      const data = docSnap.data();
      const ordenId = docSnap.id;

      const li = document.createElement("li");
      li.className="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center";

      let badgeClass="badge-ingreso";
      if(data.estado==="proceso") badgeClass="badge-proceso";
      if(data.estado==="entregado") badgeClass="badge-entregado";

      li.innerHTML=`
        <span>
          ${data.placa} - ${data.vehiculo}
        </span>
        <div>
          <span class="badge-status ${badgeClass}">
            ${data.estado}
          </span>
          <button class="btn btn-sm btn-outline-light ms-2" data-id="${ordenId}">
            Cambiar
          </button>
        </div>
      `;

      li.querySelector("button").addEventListener("click", async ()=>{

        let nuevoEstado="proceso";
        if(data.estado==="proceso") nuevoEstado="entregado";
        if(data.estado==="entregado") nuevoEstado="ingreso";

        await updateDoc(
          doc(
            db,
            "empresas",
            empresaId,
            "sucursales",
            sucursalId,
            "ordenes",
            ordenId
          ),
          {
            estado: nuevoEstado
          }
        );

      });

      ordenesUl.appendChild(li);

    });

  });

}

/* ================= INICIAR ================= */

escucharOrdenes();

/* ================= VOZ OPCIONAL ================= */

function hablar(texto){
  const voz = new SpeechSynthesisUtterance(texto);
  voz.lang="es-ES";
  speechSynthesis.speak(voz);
}

</script>
</body>
</html>