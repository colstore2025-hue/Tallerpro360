<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nexus-X Terminal | Operaciones de Taller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #020617; --accent: #3b82f6; --gold: #f59e0b; 
            --success: #10b981; --danger: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--primary); color: #f1f5f9; padding-bottom: 100px; }
        .font-nexus { font-family: 'Orbitron', sans-serif; }
        
        .glass-panel { 
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.08); border-radius: 28px; 
        }

        .neo-input { 
            background: rgba(0,0,0,0.3); border: 1px solid #1e293b; 
            border-radius: 15px; padding: 15px; color: white; width: 100%; outline: none;
        }

        /* Timeline de Estados */
        .step-pill { padding: 6px 12px; border-radius: 10px; font-size: 9px; font-weight: 800; cursor: pointer; transition: 0.3s; opacity: 0.4; border: 1px solid transparent; }
        .step-pill.active { opacity: 1; border-color: var(--gold); color: var(--gold); background: rgba(245, 158, 11, 0.1); }

        /* Navbar Inferior */
        .nav-nexus { 
            position: fixed; bottom: 20px; left: 10px; right: 10px; height: 75px; 
            background: rgba(7, 10, 25, 0.95); backdrop-filter: blur(15px); 
            border-radius: 25px; display: flex; justify-content: space-around; 
            align-items: center; z-index: 1000; border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-btn { text-align: center; color: #475569; font-size: 8px; font-weight: 900; }
        .nav-btn.active { color: var(--gold); }
        .nav-btn i { font-size: 20px; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

<header class="p-5 flex justify-between items-center sticky top-0 bg-slate-950/80 backdrop-blur-md z-50 border-b border-white/5">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gold rounded-xl flex items-center justify-center shadow-lg shadow-gold/20">
            <i class="fas fa-satellite text-black"></i>
        </div>
        <div>
            <h1 id="shop-name" class="font-nexus text-[10px] text-white tracking-widest uppercase italic">Nexus-X Terminal</h1>
            <p id="live-clock" class="text-[9px] text-gold font-bold">00:00:00</p>
        </div>
    </div>
    <button onclick="logout()" class="text-slate-500 hover:text-red-500"><i class="fas fa-power-off"></i></button>
</header>

<main class="p-4 space-y-6">

    <section id="tab-patio" class="tab-content space-y-4">
        <div class="glass-panel p-6 border-l-4 border-accent">
            <h2 class="font-nexus text-[10px] text-accent mb-6 tracking-widest uppercase font-black italic">Registro de MisiÃ³n</h2>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <input id="in-placa" placeholder="PLACA" class="neo-input font-nexus text-xl text-center col-span-1 border-accent/30 uppercase text-gold">
                <input id="in-cliente" placeholder="CLIENTE / EMPRESA" class="neo-input text-xs col-span-2 font-bold uppercase">
            </div>
            <textarea id="in-reporte" rows="3" placeholder="SÃNTOMAS Y FALLAS DETECTADAS..." class="neo-input text-sm mb-4"></textarea>
            
            <button onclick="crearOrden()" class="w-full bg-white text-black font-nexus py-4 rounded-2xl text-[11px] tracking-[4px] shadow-xl hover:bg-gold transition-all uppercase">
                Iniciar Servicio
            </button>
        </div>

        <div id="lista-ordenes" class="space-y-4">
            </div>
    </section>

    <div id="modal-gestion" class="fixed inset-0 bg-black/95 z-[100] hidden overflow-y-auto">
        <div class="p-6 max-w-2xl mx-auto pb-32">
            <div class="flex justify-between items-center mb-8">
                <button onclick="cerrarModal()" class="text-slate-400"><i class="fas fa-chevron-left mr-2"></i> Volver</button>
                <div class="text-right">
                    <h2 id="m-placa" class="font-nexus text-2xl text-gold">---</h2>
                    <p id="m-cliente" class="text-[9px] font-black uppercase text-slate-500 tracking-widest">---</p>
                </div>
            </div>

            <div class="flex justify-between gap-1 mb-8">
                <div onclick="cambiarEstado('INGRESADO')" id="step-INGRESADO" class="step-pill active">PATIO</div>
                <div onclick="cambiarEstado('REPARACION')" id="step-REPARACION" class="step-pill">MOTOR</div>
                <div onclick="cambiarEstado('REPUESTOS')" id="step-REPUESTOS" class="step-pill">STOCK</div>
                <div onclick="cambiarEstado('LISTO')" id="step-LISTO" class="step-pill">LISTO</div>
            </div>

            <div class="glass-panel p-6 space-y-6">
                <h3 class="font-nexus text-[10px] text-slate-400 uppercase tracking-widest">BitÃ¡cora de Costos</h3>
                
                <div class="flex gap-2">
                    <input id="item-nombre" placeholder="ITEM / REPUESTO" class="neo-input text-xs flex-1">
                    <input id="item-costo" type="number" placeholder="$ COSTO" class="neo-input text-xs w-24">
                    <button onclick="agregarGasto()" class="w-12 h-12 bg-gold text-black rounded-xl"><i class="fas fa-plus"></i></button>
                </div>

                <div id="lista-gastos" class="space-y-2 border-t border-white/5 pt-4">
                    </div>

                <div class="pt-4">
                    <label class="text-[9px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Mano de Obra TÃ©cnica</label>
                    <input id="m-labor" type="number" onchange="guardarManoObra()" placeholder="$0.00" class="neo-input font-nexus text-xl text-success">
                </div>
            </div>

            <div class="mt-8 glass-panel p-6 bg-gold/5 border-gold/20">
                <div class="flex justify-between items-center">
                    <p class="font-nexus text-xs text-slate-400">LIQUIDACIÃ“N TOTAL</p>
                    <h3 id="m-total" class="font-nexus text-3xl text-gold">$0</h3>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button onclick="compartirWhatsApp()" class="bg-emerald-600 p-4 rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button onclick="generarPDF()" class="bg-white text-black p-4 rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2">
                        <i class="fas fa-file-pdf"></i> Reporte PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

</main>

<nav class="nav-nexus">
    <div class="nav-btn active" onclick="switchTab('patio')"><i class="fas fa-truck-monster"></i>PATIO</div>
    <div class="nav-btn" onclick="switchTab('caja')"><i class="fas fa-cash-register"></i>CAJA</div>
    <div class="nav-btn" onclick="switchTab('stock')"><i class="fas fa-box-open"></i>ALMACÃ‰N</div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, serverTimestamp, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let activeOrderId = null;
    let currentTaller = {};

    onAuthStateChanged(auth, async (user) => {
        if (!user) window.location.href = "index.html";
        const snap = await getDoc(doc(db, "usuarios", user.uid));
        currentTaller = snap.data();
        document.getElementById('shop-name').innerText = currentTaller.nombreTaller;
        initRealtime();
    });

    // --- LOGICA DE Ã“RDENES ---
    window.crearOrden = async () => {
        const placa = document.getElementById('in-placa').value.toUpperCase();
        const cliente = document.getElementById('in-cliente').value.toUpperCase();
        const reporte = document.getElementById('in-reporte').value;
        
        if(!placa || !cliente) return alert("Â¡Placa y Cliente obligatorios!");

        await addDoc(collection(db, "ordenes"), {
            tallerId: auth.currentUser.uid,
            placa, cliente, reporte,
            status: 'INGRESADO',
            items: [],
            labor: 0,
            total: 0,
            timestamp: serverTimestamp()
        });

        document.getElementById('in-placa').value = "";
        document.getElementById('in-cliente').value = "";
        document.getElementById('in-reporte').value = "";
    };

    function initRealtime() {
        const q = query(collection(db, "ordenes"), where("tallerId", "==", auth.currentUser.uid));
        onSnapshot(q, (snap) => {
            const container = document.getElementById('lista-ordenes');
            container.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                container.innerHTML += `
                    <div onclick="abrirGestion('${d.id}')" class="glass-panel p-5 flex justify-between items-center border-l-4 ${o.status==='LISTO'?'border-success':'border-gold'}">
                        <div>
                            <p class="text-[8px] text-slate-500 font-bold tracking-widest">${o.status}</p>
                            <h3 class="font-nexus text-xl">${o.placa}</h3>
                            <p class="text-[10px] text-slate-400">${o.cliente}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-nexus text-xs text-white">$${(o.total || 0).toLocaleString()}</p>
                            <i class="fas fa-chevron-right text-slate-700 mt-2"></i>
                        </div>
                    </div>
                `;
            });
        });
    }

    // --- GESTIÃ“N DE MODAL ---
    window.abrirGestion = async (id) => {
        activeOrderId = id;
        const snap = await getDoc(doc(db, "ordenes", id));
        const o = snap.data();

        document.getElementById('m-placa').innerText = o.placa;
        document.getElementById('m-cliente').innerText = o.cliente;
        document.getElementById('m-labor').value = o.labor || 0;
        
        actualizarTimelineUI(o.status);
        renderItems(o.items || []);
        calcularTotalLocal(o.items, o.labor);
        
        document.getElementById('modal-gestion').classList.remove('hidden');
    };

    window.agregarGasto = async () => {
        const nombre = document.getElementById('item-nombre').value.toUpperCase();
        const costo = parseFloat(document.getElementById('item-costo').value);
        if(!nombre || !costo) return;

        const ref = doc(db, "ordenes", activeOrderId);
        await updateDoc(ref, {
            items: arrayUnion({ nombre, costo, fecha: Date.now() })
        });

        document.getElementById('item-nombre').value = "";
        document.getElementById('item-costo').value = "";
        abrirGestion(activeOrderId); // Refrescar
    };

    function renderItems(items) {
        const list = document.getElementById('lista-gastos');
        list.innerHTML = "";
        items.forEach(it => {
            list.innerHTML += `
                <div class="flex justify-between text-[11px] bg-white/5 p-3 rounded-xl border border-white/5">
                    <span class="text-slate-300 font-bold">${it.nombre}</span>
                    <span class="text-gold font-nexus">$${it.costo.toLocaleString()}</span>
                </div>
            `;
        });
    }

    window.cambiarEstado = async (nuevoStatus) => {
        await updateDoc(doc(db, "ordenes", activeOrderId), { status: nuevoStatus });
        actualizarTimelineUI(nuevoStatus);
        alert(`Estado actualizado: ${nuevoStatus}`);
    };

    function actualizarTimelineUI(status) {
        document.querySelectorAll('.step-pill').forEach(p => p.classList.remove('active'));
        document.getElementById('step-' + status).classList.add('active');
    }

    function calcularTotalLocal(items, labor) {
        let sub = labor || 0;
        items.forEach(i => sub += i.costo);
        document.getElementById('m-total').innerText = `$${sub.toLocaleString()}`;
        updateDoc(doc(db, "ordenes", activeOrderId), { total: sub });
    }

    window.guardarManoObra = async () => {
        const labor = parseFloat(document.getElementById('m-labor').value) || 0;
        await updateDoc(doc(db, "ordenes", activeOrderId), { labor });
        abrirGestion(activeOrderId);
    };

    window.cerrarModal = () => document.getElementById('modal-gestion').classList.add('hidden');

    window.generarPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold");
        doc.text("REPORTE TÃ‰CNICO NEXUS-X", 20, 20);
        doc.setFontSize(10);
        doc.text(`Taller: ${currentTaller.nombreTaller}`, 20, 30);
        doc.text(`Placa: ${document.getElementById('m-placa').innerText}`, 20, 40);
        doc.text(`Cliente: ${document.getElementById('m-cliente').innerText}`, 20, 50);
        doc.text("--------------------------------------------------", 20, 60);
        doc.text(`TOTAL A PAGAR: ${document.getElementById('m-total').innerText}`, 20, 80);
        doc.save(`NexusX_${document.getElementById('m-placa').innerText}.pdf`);
    };

    window.compartirWhatsApp = () => {
        const placa = document.getElementById('m-placa').innerText;
        const total = document.getElementById('m-total').innerText;
        const msg = `ðŸš€ *NEXUS-X STARLINK REPORT*%0A%0AHola, su vehÃ­culo *${placa}* ha sido procesado en *${currentTaller.nombreTaller}*.%0A%0AðŸ’° *Total LiquidaciÃ³n:* ${total}%0A%0APuedes retirar tu unidad. Â¡Gracias por confiar en nuestra red!`;
        window.open(`https://wa.me/?text=${msg}`);
    };

    setInterval(() => {
        document.getElementById('live-clock').innerText = new Date().toLocaleTimeString();
    }, 1000);

</script>
</body>
</html>
