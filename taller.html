<!DOCTYPE html>
<html lang="es">
<head>
    <style>
        .pg-card { background: linear-gradient(135deg, #0f172a 0%, #020617 100%); border: 1px solid #1e293b; }
        .mecanico-tag { background: #3b82f620; color: #3b82f6; border: 1px solid #3b82f640; padding: 2px 8px; border-radius: 6px; font-size: 10px; }
    </style>
</head>
<body class="bg-slate-950 text-white font-inter">

    <section id="view-pg" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="pg-card p-6 rounded-3xl">
            <p class="text-[10px] text-slate-500 font-black uppercase">Utilidad Bruta Mes</p>
            <h2 id="total-utilidad" class="text-3xl font-nexus text-emerald-400 font-black">$ 0</h2>
        </div>
        <div class="pg-card p-6 rounded-3xl">
            <p class="text-[10px] text-slate-500 font-black uppercase">Nómina por Pagar</p>
            <h2 id="total-nomina" class="text-3xl font-nexus text-gold font-black">$ 0</h2>
        </div>
        <div class="pg-card p-6 rounded-3xl">
            <p class="text-[10px] text-slate-500 font-black uppercase">Vehículos Activos</p>
            <h2 id="count-vehiculos" class="text-3xl font-nexus text-white font-black">0</h2>
        </div>
    </section>

    <section id="view-patio" class="p-4">
        <div class="glass-card p-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input id="in-placa" placeholder="PLACA" class="neo-input font-nexus text-2xl text-gold">
                <select id="in-mecanico" class="neo-input text-xs">
                    <option value="">ASIGNAR MECÁNICO...</option>
                    </select>
            </div>
            </div>
    </section>

    <div id="modal-cierre" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[6000] p-6">
        <div class="max-w-md mx-auto bg-slate-900 p-8 rounded-[40px] border border-gold/30">
            <h3 class="font-nexus text-gold text-center mb-6">LIQUIDACIÓN DE MISIÓN</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-slate-500 font-bold uppercase">Mano de Obra (Valor para el Mecánico)</label>
                    <input id="pay-mecanico" type="number" placeholder="$ Valor Fijo Tarea" class="neo-input text-xl text-white">
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 font-bold uppercase">Mano de Obra (Cobro al Cliente)</label>
                    <input id="pay-cliente" type="number" placeholder="$ Valor Cobrado" class="neo-input text-xl text-white font-black">
                </div>
                <button onclick="finalizarYArchivar()" class="w-full bg-gold text-black font-nexus py-4 rounded-2xl font-black">CERRAR Y CALCULAR P&G</button>
            </div>
        </div>
    </div>

<script type="module">
    // LÓGICA DE CÁLCULO DE NÓMINA Y P&G
    window.finalizarYArchivar = async () => {
        const pagoTecnico = parseFloat(document.getElementById('pay-mecanico').value);
        const cobroCliente = parseFloat(document.getElementById('pay-cliente').value);
        
        // El ID de la misión amarra todo
        const ordenRef = doc(db, "ordenes", activeOrderId);
        const snap = await getDoc(ordenRef);
        const data = snap.data();

        // Cálculo de Utilidad de Repuestos
        const costoRepuestos = data.movimientos
            .filter(m => m.tipo === 'EGRESO')
            .reduce((acc, m) => acc + (m.costo || 0), 0);
        
        const ventaRepuestos = data.movimientos
            .filter(m => m.tipo === 'EGRESO')
            .reduce((acc, m) => acc + (m.monto || 0), 0);

        // P&G DE LA ORDEN
        const utilidadOrden = (ventaRepuestos - costoRepuestos) + (cobroCliente - pagoTecnico);

        await updateDoc(ordenRef, {
            status: 'ARCHIVADO',
            pagoMecanico: pagoTecnico,
            cobroMO: cobroCliente,
            utilidadNeta: utilidadOrden,
            fechaCierre: serverTimestamp()
        });
        
        alert("MISIÓN FINALIZADA. UTILIDAD: $" + utilidadOrden.toLocaleString());
    };
</script>
</body>
</html>
