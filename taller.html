<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 - rdenes de Servicio</title>
<link rel="icon" href="logo-tallerpro360.png" type="image/png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
.container { max-width: 800px; margin-top: 20px; }
.estado-badge { font-size: 0.9em; }
.timeline { list-style: none; padding-left: 0; }
.timeline li { margin-bottom: 10px; padding-left: 20px; position: relative; }
.timeline li::before { content: ''; position: absolute; left: 0; top: 5px; width: 10px; height: 10px; background-color: #0d6efd; border-radius: 50%; }
.btn-next { margin-top: 10px; }
.banner-plan { position: sticky; top: 0; z-index: 999; padding: 12px; text-align: center; font-weight: bold; }
.plan-ok { background:#d1fae5; color:#065f46; }
.plan-warning { background:#fef3c7; color:#92400e; }
.plan-danger { background:#fee2e2; color:#991b1b; }
</style>
</head>

<body>

<!-- BANNER PLAN -->
<div id="bannerPlan" class="banner-plan d-none"></div>

<div class="container">

  <!-- LOGO Y TTULO -->
  <div class="text-center mb-4">
    <img src="logo-tallerpro360.png" alt="TallerPRO360" width="120">
    <h2 class="mt-2">Gesti贸n de rdenes de Servicio</h2>
  </div>

  <!-- REGISTRO CLIENTE -->
  <div id="registroCliente" class="card mb-3 p-3 shadow-sm">
    <h5>Registrar Cliente</h5>
    <form id="formCliente">
      <div class="mb-2">
        <label>Nombre completo</label>
        <input type="text" id="clienteNombreReg" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Correo electr贸nico</label>
        <input type="email" id="clienteEmailReg" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Tel茅fono</label>
        <input type="tel" id="clienteTelefonoReg" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Contrase帽a</label>
        <input type="password" id="clientePasswordReg" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Registrar Cliente</button>
    </form>
  </div>

  <!-- LOGIN CLIENTE -->
  <div id="loginCliente" class="card mb-3 p-3 shadow-sm">
    <h5>Ingresar Cliente</h5>
    <form id="formLogin">
      <div class="mb-2">
        <label>Correo electr贸nico</label>
        <input type="email" id="clienteEmailLogin" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Contrase帽a</label>
        <input type="password" id="clientePasswordLogin" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-success w-100 mt-2">Ingresar</button>
    </form>
  </div>

  <!-- CREAR ORDEN -->
  <div id="crearOrden" class="card mb-3 p-3 shadow-sm d-none">
    <h5>Crear nueva orden</h5>
    <form id="formOrden">
      <div class="mb-2">
        <label>Placa del veh铆culo</label>
        <input type="text" id="placa" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Marca / Modelo</label>
        <input type="text" id="vehiculo" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Crear Orden</button>
    </form>
  </div>

  <!-- LISTADO RDENES -->
  <div id="ordenesList" class="card p-3 shadow-sm d-none">
    <h5>rdenes activas</h5>
    <ul class="list-group" id="ordenesUl"></ul>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- ASISTENTE DE VOZ -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  collection,
  setDoc,
  getDoc,
  getDocs,
  query,
  where,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { updateServiceStage } from "./serviceOrders.updateStage.js";


// ============================
//  CONFIG
// ============================

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const TALLER_ID = "demo";

let userCliente = null;


// ============================
//  SESIN
// ============================

onAuthStateChanged(auth, async (user) => {

  if (!user) return;

  const clienteRef = doc(db, "talleres", TALLER_ID, "clientes", user.uid);
  const snap = await getDoc(clienteRef);

  if (!snap.exists()) {
    await signOut(auth);
    alert("No perteneces a este taller.");
    return;
  }

  userCliente = user;

  loginCliente.style.display = "none";
  registroCliente.style.display = "none";
  crearOrden.style.display = "block";

  cargarOrdenes();
});


// ============================
//  REGISTRO CLIENTE
// ============================

formCliente.addEventListener("submit", async (e)=>{
  e.preventDefault();

  try {

    const cred = await createUserWithEmailAndPassword(
      auth,
      clienteEmailReg.value.trim(),
      clientePasswordReg.value
    );

    await setDoc(
      doc(db, "talleres", TALLER_ID, "clientes", cred.user.uid),
      {
        nombre: clienteNombreReg.value.trim(),
        telefono: clienteTelefonoReg.value.trim(),
        email: clienteEmailReg.value.trim(),
        tallerId: TALLER_ID,
        createdAt: serverTimestamp()
      }
    );

    alert("Cliente registrado correctamente.");
    formCliente.reset();

  } catch(err){
    alert(err.message);
  }
});


// ============================
//  LOGIN
// ============================

formLogin.addEventListener("submit", async (e)=>{
  e.preventDefault();

  try {
    await signInWithEmailAndPassword(
      auth,
      clienteEmailLogin.value.trim(),
      clientePasswordLogin.value
    );
  } catch(err){
    alert(err.message);
  }
});


// ============================
//  CREAR ORDEN
// ============================

formOrden.addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!userCliente) return alert("Debes iniciar sesi贸n");

  const codigo = `TP360-${Date.now()}`;

  const ordenRef = doc(
    db,
    "talleres",
    TALLER_ID,
    "ordenes",
    codigo
  );

  try {

    await setDoc(ordenRef, {
      codigo,
      clienteId: userCliente.uid,
      vehiculo: vehiculo.value.trim(),
      placa: placa.value.trim().toUpperCase(),
      status: "INGRESO",
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    //  Registrar primera etapa (ERP REAL)
    await updateServiceStage(
      `talleres/${TALLER_ID}/ordenes/${codigo}`,
      "INGRESO",
      "cliente"
    );

    alert("Orden creada correctamente");

    formOrden.reset();
    cargarOrdenes();

  } catch(err){
    console.error(err);
    alert("Error al crear orden");
  }
});


// ============================
//  LISTAR RDENES
// ============================

async function cargarOrdenes(){

  const q = query(
    collection(db, "talleres", TALLER_ID, "ordenes"),
    where("clienteId","==",userCliente.uid),
    orderBy("updatedAt","desc")
  );

  const snap = await getDocs(q);

  ordenesUl.innerHTML = "";

  snap.forEach(docSnap => {

    const o = docSnap.data();

    const li = document.createElement("li");
    li.className="list-group-item";

    li.innerHTML=`
      <strong>${o.codigo}</strong> - ${o.vehiculo} (${o.placa})
      <span class="badge bg-info ms-2">${o.status}</span>
    `;

    ordenesUl.appendChild(li);
  });

  ordenesList.classList.toggle("d-none", !ordenesUl.children.length);
}

</script>
</body>
</html>