<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 - √ìrdenes de Servicio</title>
<link rel="icon" href="logo-tallerpro360.png" type="image/png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
.container { max-width: 800px; margin-top: 20px; }
.estado-badge { font-size: 0.9em; }
.timeline { list-style: none; padding-left: 0; }
.timeline li { margin-bottom: 10px; padding-left: 20px; position: relative; }
.timeline li::before { content: ''; position: absolute; left: 0; top: 5px; width: 10px; height: 10px; background-color: #0d6efd; border-radius: 50%; }
.btn-next { margin-top: 10px; }
.banner-plan { position: sticky; top: 0; z-index: 999; padding: 12px; text-align: center; font-weight: bold; }
.plan-ok { background:#d1fae5; color:#065f46; }
.plan-warning { background:#fef3c7; color:#92400e; }
.plan-danger { background:#fee2e2; color:#991b1b; }
</style>
</head>

<body>

<!-- BANNER PLAN -->
<div id="bannerPlan" class="banner-plan d-none"></div>

<div class="container">

  <!-- LOGO Y T√çTULO -->
  <div class="text-center mb-4">
    <img src="logo-tallerpro360.png" alt="TallerPRO360" width="120">
    <h2 class="mt-2">Gesti√≥n de √ìrdenes de Servicio</h2>
  </div>

  <!-- REGISTRO CLIENTE -->
  <div id="registroCliente" class="card mb-3 p-3 shadow-sm">
    <h5>Registrar Cliente</h5>
    <form id="formCliente">
      <div class="mb-2">
        <label>Nombre completo</label>
        <input type="text" id="clienteNombreReg" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Correo electr√≥nico</label>
        <input type="email" id="clienteEmailReg" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Tel√©fono</label>
        <input type="tel" id="clienteTelefonoReg" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Contrase√±a</label>
        <input type="password" id="clientePasswordReg" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Registrar Cliente</button>
    </form>
  </div>

  <!-- LOGIN CLIENTE -->
  <div id="loginCliente" class="card mb-3 p-3 shadow-sm">
    <h5>Ingresar Cliente</h5>
    <form id="formLogin">
      <div class="mb-2">
        <label>Correo electr√≥nico</label>
        <input type="email" id="clienteEmailLogin" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Contrase√±a</label>
        <input type="password" id="clientePasswordLogin" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-success w-100 mt-2">Ingresar</button>
    </form>
  </div>

  <!-- CREAR ORDEN -->
  <div id="crearOrden" class="card mb-3 p-3 shadow-sm d-none">
    <h5>Crear nueva orden</h5>
    <form id="formOrden">
      <div class="mb-2">
        <label>Placa del veh√≠culo</label>
        <input type="text" id="placa" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Marca / Modelo</label>
        <input type="text" id="vehiculo" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Crear Orden</button>
    </form>
  </div>

  <!-- LISTADO √ìRDENES -->
  <div id="ordenesList" class="card p-3 shadow-sm d-none">
    <h5>√ìrdenes activas</h5>
    <ul class="list-group" id="ordenesUl"></ul>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- ASISTENTE DE VOZ -->
<script type="module">
import { speakOrderStage, initVoiceActivation, listenOrderVoice } from './serviceOrders.voice.js';

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

// üî• ID del taller (SaaS multiempresa)
const TALLER_ID = "demo";

initVoiceActivation();

let userCliente = null;

// ===============================
// üîê OBSERVADOR DE SESI√ìN
// ===============================
auth.onAuthStateChanged(async (user) => {

  if (!user) return;

  const clienteRef = db.collection("talleres")
    .doc(TALLER_ID)
    .collection("clientes")
    .doc(user.uid);

  const snap = await clienteRef.get();

  if (!snap.exists) {
    await auth.signOut();
    alert("No perteneces a este taller.");
    return;
  }

  userCliente = user;

  document.getElementById("loginCliente").style.display = "none";
  document.getElementById("registroCliente").style.display = "none";
  document.getElementById("crearOrden").style.display = "block";

  cargarOrdenes();
});

// ===============================
// üìù REGISTRO CLIENTE (SaaS)
// ===============================
document.getElementById("formCliente").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const email = clienteEmailReg.value.trim();
  const pass = clientePasswordReg.value;
  const nombre = clienteNombreReg.value.trim();
  const telefono = clienteTelefonoReg.value.trim();

  try {

    const cred = await auth.createUserWithEmailAndPassword(email, pass);

    await db.collection("talleres")
      .doc(TALLER_ID)
      .collection("clientes")
      .doc(cred.user.uid)
      .set({
        nombre,
        telefono,
        email,
        tallerId: TALLER_ID,
        creadoEn: firebase.firestore.Timestamp.now()
      });

    alert("Cliente registrado correctamente. Ahora inicia sesi√≥n.");
    formCliente.reset();

  } catch(err){
    alert(err.message);
  }
});

// ===============================
// üîë LOGIN CLIENTE
// ===============================
document.getElementById("formLogin").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const email = clienteEmailLogin.value.trim();
  const pass = clientePasswordLogin.value;

  try {
    await auth.signInWithEmailAndPassword(email, pass);
    alert("Ingreso exitoso!");
  } catch(err){
    alert(err.message);
  }
});

// ===============================
// üöó CREAR ORDEN (SaaS CORREGIDO)
// ===============================
document.getElementById("formOrden").addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!userCliente) return alert("Debes iniciar sesi√≥n primero.");

  const codigo = `TP360-${Date.now()}`;
  const ts = firebase.firestore.Timestamp.now();

  const orden = {
    codigo,
    clienteId: userCliente.uid,
    vehiculo: vehiculo.value.trim(),
    placa: placa.value.trim().toUpperCase(),
    estado: "INGRESO",
    timeline: [{estado:"INGRESO", fecha:ts}],
    creadoEn: ts,
    actualizadoEn: ts
  };

  try {

    await db.collection("talleres")
      .doc(TALLER_ID)
      .collection("ordenes")
      .doc(codigo)
      .set(orden);

    alert("Orden creada correctamente!");
    formOrden.reset();

    // üîä Voz inmediata SOLO UNA VEZ
    speakOrderStage(orden);

    // üî• Listener controlado (evita duplicados)
    if (!window.ordenesEscuchadas) {
      window.ordenesEscuchadas = new Set();
    }

    if (!window.ordenesEscuchadas.has(codigo)) {
      listenOrderVoice(db, `talleres/${TALLER_ID}/ordenes/${codigo}`);
      window.ordenesEscuchadas.add(codigo);
    }

    cargarOrdenes();

  } catch(err){
    console.error(err);
    alert("Error al crear la orden.");
  }

});

// ===============================
// üìã LISTAR √ìRDENES DEL CLIENTE
// ===============================
async function cargarOrdenes(){

  if(!userCliente) return;

  const snap = await db.collection("talleres")
    .doc(TALLER_ID)
    .collection("ordenes")
    .where("clienteId","==",userCliente.uid)
    .orderBy("actualizadoEn","desc")
    .get();

  const ul = document.getElementById("ordenesUl");
  ul.innerHTML="";

  snap.forEach(doc=>{
    const o = doc.data();

    const li = document.createElement("li");
    li.className="list-group-item";

    li.innerHTML=`
      <strong>${o.codigo}</strong> - ${o.vehiculo} (${o.placa})
      <span class="badge bg-info ms-2">${o.estado}</span>
      <br>
      Timeline: ${o.timeline.map(t=>t.estado).join(" ‚Üí ")}
    `;

    ul.appendChild(li);

    speakOrderStage(o);
    listenOrderVoice(db, `talleres/${TALLER_ID}/ordenes/${o.codigo}`);
  });

  document.getElementById("ordenesList")
    .classList.toggle("d-none", !ul.children.length);
}
</script>
</body>
</html>