<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TallerPRO360 - 칍rdenes de Servicio</title>
  <link rel="icon" href="logo-tallerpro360.png" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
    .container { max-width: 600px; margin-top: 20px; }
    .estado-badge { font-size: 0.9em; }
    .timeline { list-style: none; padding-left: 0; }
    .timeline li { margin-bottom: 10px; padding-left: 20px; position: relative; }
    .timeline li::before {
      content: '';
      position: absolute;
      left: 0; top: 5px;
      width: 10px; height: 10px;
      background-color: #0d6efd;
      border-radius: 50%;
    }
    .btn-next { margin-top: 10px; }

    .banner-plan {
      position: sticky;
      top: 0;
      z-index: 999;
      padding: 12px;
      text-align: center;
      font-weight: bold;
    }
    .plan-ok { background:#d1fae5; color:#065f46; }
    .plan-warning { background:#fef3c7; color:#92400e; }
    .plan-danger { background:#fee2e2; color:#991b1b; }
  </style>
</head>

<body>

<!-- BANNER PLAN -->
<div id="bannerPlan" class="banner-plan d-none"></div>

<div class="container">
  <div class="text-center mb-4">
    <img src="logo-tallerpro360.png" alt="TallerPRO360" width="120">
    <h2 class="mt-2">Gesti칩n de 칍rdenes</h2>
  </div>

  <!-- Crear orden -->
  <div id="crearOrden" class="card mb-3 p-3 shadow-sm">
    <h5>Crear nueva orden</h5>
    <form id="formOrden">
      <div class="mb-2">
        <label>Placa del veh칤culo</label>
        <input type="text" id="placa" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Marca / Modelo</label>
        <input type="text" id="vehiculo" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Nombre del cliente</label>
        <input type="text" id="clienteNombre" class="form-control" required>
      </div>
      <div class="mb-2">
        <label>Tel칠fono</label>
        <input type="tel" id="clienteTelefono" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-2">Crear Orden</button>
    </form>
  </div>

  <!-- 칍rdenes -->
  <div id="ordenesList" class="card p-3 shadow-sm d-none">
    <h5>칍rdenes activas</h5>
    <ul class="list-group" id="ordenesUl"></ul>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- VOZ -->
<script type="module">
import { speakOrderStage, initVoiceActivation, listenOrderVoice } from './serviceOrders.voice.js';
initVoiceActivation();
</script>

<!-- BILLING GUARD -->
<script type="module" src="./billing-guard.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

const estados = ["INGRESO","DIAGNOSTICO","APROBADO","EN PROCESO","LISTO","ENTREGADO"];

let tallerStatus = "ACTIVO";

// 游댏 CONTROL DE PLAN
auth.onAuthStateChanged(async (user)=>{
  if(!user) return;

  const userSnap = await db.collection("usuarios").doc(user.uid).get();
  if(!userSnap.exists) return;

  const data = userSnap.data();
  tallerStatus = data.status || "ACTIVO";

  const banner = document.getElementById("bannerPlan");

  if(tallerStatus === "SUSPENDIDO"){
    banner.className = "banner-plan plan-danger";
    banner.innerHTML = `游뚿 Tu plan est치 vencido. 
      <a href="pagos.html" class="btn btn-sm btn-dark ms-2">Pagar ahora</a>`;
    banner.classList.remove("d-none");
    document.getElementById("crearOrden").style.display="none";
  }
});

// CREAR ORDEN
document.getElementById("formOrden").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(tallerStatus !== "ACTIVO"){
    alert("Tu plan est치 vencido. No puedes crear 칩rdenes.");
    return;
  }

  const codigo = `TP360-${Date.now()}`;
  const ts = firebase.firestore.Timestamp.now();

  const orden = {
    codigo,
    placa: placa.value.toUpperCase(),
    vehiculo: vehiculo.value,
    cliente: { nombre: clienteNombre.value, telefono: clienteTelefono.value },
    estado:"INGRESO",
    timeline:[{estado:"INGRESO",fecha:ts}],
    creadoEn:ts,
    actualizadoEn:ts
  };

  await db.collection("ordenes").doc(codigo).set(orden);
  speakOrderStage(orden);
  formOrden.reset();
  cargarOrdenes();
});

// LISTAR 칍RDENES
async function cargarOrdenes(){
  const snap = await db.collection("ordenes").orderBy("actualizadoEn","desc").get();
  const ul = document.getElementById("ordenesUl");
  ul.innerHTML="";

  snap.forEach(doc=>{
    const o = doc.data();
    const li = document.createElement("li");
    li.className="list-group-item";

    li.innerHTML=`
      <strong>${o.codigo}</strong> - ${o.vehiculo} (${o.placa})
      <span class="badge bg-info ms-2">${o.estado}</span>
      <br>Cliente: ${o.cliente.nombre}
      <button class="btn btn-sm btn-success mt-2">Avanzar</button>
    `;

    li.querySelector("button").onclick = async ()=>{
      if(tallerStatus!=="ACTIVO"){
        alert("Plan vencido. No puedes avanzar 칩rdenes.");
        return;
      }
      const i = estados.indexOf(o.estado);
      if(i < estados.length-1){
        const nuevo = estados[i+1];
        o.estado=nuevo;
        o.timeline.push({estado:nuevo,fecha:firebase.firestore.Timestamp.now()});
        await db.collection("ordenes").doc(o.codigo).update(o);
        speakOrderStage(o);
        cargarOrdenes();
      }
    };

    ul.appendChild(li);
    listenOrderVoice(db,o.codigo);
  });

  document.getElementById("ordenesList").classList.toggle("d-none",!ul.children.length);
}

cargarOrdenes();
</script>

</body>
</html>