<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TallerPro360 | ERP Multinacional & Nexus-X</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #020617; --gold: #f59e0b; --accent: #3b82f6; 
            --success: #10b981; --danger: #ef4444; --surface: rgba(15, 23, 42, 0.98);
        }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--primary); color: #f1f5f9; 
            padding-bottom: 140px; overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%);
            min-height: 100vh;
        }

        .font-nexus { font-family: 'Orbitron', sans-serif; }
        .glass { background: var(--surface); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        
        /* Inputs Ultra-Modernos */
        .neo-input { 
            background: rgba(0,0,0,0.5); border: 1px solid #334155; border-radius: 18px; 
            padding: 16px; color: white; width: 100%; outline: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .neo-input:focus { border-color: var(--gold); background: rgba(0,0,0,0.7); box-shadow: 0 0 25px rgba(245, 158, 11, 0.2); }

        /* Navegación Elevada Pro */
        .nav-nexus { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 800px; height: 90px; border-radius: 35px; 
            display: flex; justify-content: space-around; align-items: center; z-index: 5000; 
            border: 1px solid rgba(255,255,255,0.15); background: rgba(7, 10, 25, 0.95);
            box-shadow: 0 15px 50px rgba(0,0,0,0.8); backdrop-filter: blur(20px);
        }
        .nav-item { color: #64748b; font-size: 8px; font-weight: 900; text-align: center; transition: 0.4s; cursor: pointer; flex: 1; text-transform: uppercase; letter-spacing: 1px; }
        .nav-item i { font-size: 22px; margin-bottom: 8px; display: block; transition: 0.4s; }
        .nav-item.active { color: var(--gold); }
        .nav-item.active i { transform: translateY(-12px) scale(1.2); text-shadow: 0 0 20px var(--gold); }

        /* Módulos de Flota */
        .flota-card { border: 1px solid rgba(255,255,255,0.05); padding: 10px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.3s; grayscale: 1; opacity: 0.5; }
        .flota-card.active { border-color: var(--gold); background: rgba(245,158,11,0.1); grayscale: 0; opacity: 1; }

        .recording { animation: pulse-red 1.2s infinite; background: var(--danger) !important; color: white !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.8); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Sidebar de Configuración */
        #sidebar-owner { position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; z-index: 7000; transition: 0.5s cubic-bezier(0.77, 0, 0.175, 1); }
        #sidebar-owner.open { right: 0; }
    </style>
</head>
<body>

<div id="loader">
    <div class="relative">
        <div class="w-24 h-24 border-4 border-gold border-t-transparent rounded-full animate-spin"></div>
        <i class="fas fa-satellite text-gold absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl animate-pulse"></i>
    </div>
    <h2 class="font-nexus text-[10px] tracking-[5px] text-white mt-8 uppercase text-center">Iniciando Protocolo ERP Multinacional...</h2>
</div>

<div id="sidebar-owner" class="glass border-l border-white/10 p-8 overflow-y-auto">
    <div class="flex justify-between items-center mb-10">
        <h2 class="font-nexus text-xs tracking-widest text-gold uppercase">Configuración Master</h2>
        <button onclick="toggleSidebar()" class="text-white text-2xl">&times;</button>
    </div>
    
    <div class="space-y-8">
        <div class="p-6 bg-white/5 rounded-3xl">
            <h3 class="text-[10px] font-black uppercase text-slate-500 mb-4">Datos del Taller</h3>
            <input id="cfg-nombre" placeholder="Nombre Comercial" class="neo-input mb-3" onchange="saveLocalConfig()">
            <input id="cfg-nit" placeholder="NIT / TAX ID" class="neo-input mb-3" onchange="saveLocalConfig()">
            <input id="cfg-iva" type="number" placeholder="IVA % (ej: 19)" class="neo-input" onchange="saveLocalConfig()">
        </div>

        <div class="p-6 bg-white/5 rounded-3xl">
            <h3 class="text-[10px] font-black uppercase text-slate-500 mb-4">Pasarela de Pagos</h3>
            <input id="cfg-nequi" placeholder="Celular Nequi" class="neo-input mb-3" onchange="saveLocalConfig()">
            <input id="cfg-pse" placeholder="Link PSE / Epayco" class="neo-input" onchange="saveLocalConfig()">
        </div>

        <div class="p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/20">
            <h3 class="text-[10px] font-black uppercase text-emerald-500 mb-4">Soporte Técnico Directo</h3>
            <p class="text-[11px] text-slate-300 mb-4">¿Necesitas ayuda con el ERP? Contacta a tu oficial Nexus-X.</p>
            <a href="https://wa.me/573000000000" class="block text-center py-3 bg-emerald-500 text-black font-black rounded-xl text-[10px] uppercase">Hablar con Soporte</a>
        </div>
    </div>
</div>

<header class="p-6 glass sticky top-0 z-[1000] border-b border-white/10 flex justify-between items-center">
    <div class="flex items-center gap-5">
        <div class="w-14 h-14 bg-gradient-to-br from-gold to-orange-600 rounded-2xl flex items-center justify-center text-black shadow-lg">
            <i class="fas fa-satellite-dish text-2xl"></i>
        </div>
        <div>
            <h1 id="header-name" class="font-nexus text-[11px] tracking-[0.3em] text-white font-black uppercase">TallerPro360</h1>
            <p class="text-[9px] text-gold font-bold tracking-[1px] uppercase">Nexus-X Global Command</p>
        </div>
    </div>
    <div class="flex items-center gap-6">
        <div class="text-right hidden md:block">
            <p class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Yield Real-Time</p>
            <p id="total-pg" class="text-2xl font-nexus text-success font-black">$ 0</p>
        </div>
        <button onclick="toggleSidebar()" class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center text-white border border-white/10 hover:bg-gold hover:text-black transition-all">
            <i class="fas fa-cog"></i>
        </button>
    </div>
</header>

<main class="p-4 max-w-7xl mx-auto space-y-12 pb-32">

    <section id="sec-patio" class="space-y-8">
        <div class="glass p-8 rounded-[40px] border-t-2 border-accent/20">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-10">
                <div class="flota-card active" onclick="setFlota('CAMION', this)"><i class="fas fa-truck-moving block text-xl mb-1"></i><span class="text-[8px] font-bold">CAMIONES</span></div>
                <div class="flota-card" onclick="setFlota('AUTO', this)"><i class="fas fa-car block text-xl mb-1"></i><span class="text-[8px] font-bold">SEDÁN/SUV</span></div>
                <div class="flota-card" onclick="setFlota('VAN', this)"><i class="fas fa-shuttle-van block text-xl mb-1"></i><span class="text-[8px] font-bold">UTILITARIOS</span></div>
                <div class="flota-card" onclick="setFlota('MOTO', this)"><i class="fas fa-motorcycle block text-xl mb-1"></i><span class="text-[8px] font-bold">MOTOS</span></div>
                <div class="flota-card" onclick="setFlota('MAQ', this)"><i class="fas fa-tractor block text-xl mb-1"></i><span class="text-[8px] font-bold">MAQUINARIA</span></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-2 relative">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Identificador / Placa</label>
                    <input id="in-placa" placeholder="DIGITE O DICTE" class="neo-input font-nexus text-2xl text-gold text-center">
                    <button onclick="startNexusVoice('in-placa')" class="absolute right-4 bottom-4 text-white/20"><i class="fas fa-microphone"></i></button>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Ingreso Programado</label>
                    <input id="in-fecha-in" type="datetime-local" class="neo-input">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Salida Estimada (BSC)</label>
                    <input id="in-fecha-out" type="date" class="neo-input text-accent">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <input id="in-cliente" placeholder="CLIENTE / EMPRESA" class="neo-input uppercase">
                <input id="in-tel" type="tel" placeholder="WHATSAPP (+57)" class="neo-input">
            </div>

            <button onclick="registrarMision()" class="w-full mt-8 bg-white text-black font-nexus py-5 rounded-2xl text-[10px] font-black tracking-[4px] uppercase hover:bg-gold transition-all">
                Abrir Misión de Servicio
            </button>
        </div>

        <div id="lista-misiones" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </section>

    <section id="sec-dash" class="hidden space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass p-8 rounded-3xl border-l-4 border-emerald-500">
                <p class="text-[9px] font-black text-slate-500 uppercase mb-2">Utilidad Neta (P&G)</p>
                <h3 id="dash-utilidad" class="text-3xl font-nexus text-white">$ 0</h3>
            </div>
            <div class="glass p-8 rounded-3xl border-l-4 border-gold">
                <p class="text-[9px] font-black text-slate-500 uppercase mb-2">Eficiencia Salida (BSC)</p>
                <h3 id="dash-bsc" class="text-3xl font-nexus text-gold">100%</h3>
            </div>
            <div class="glass p-8 rounded-3xl border-l-4 border-accent">
                <p class="text-[9px] font-black text-slate-500 uppercase mb-2">Órdenes Activas</p>
                <h3 id="dash-activas" class="text-3xl font-nexus text-white">0</h3>
            </div>
            <div class="glass p-8 rounded-3xl">
                <button onclick="exportarExcel()" class="w-full h-full flex flex-col items-center justify-center gap-2">
                    <i class="fas fa-file-excel text-emerald-500 text-2xl"></i>
                    <span class="text-[9px] font-black uppercase">Reporte DIAN / Renta</span>
                </button>
            </div>
        </div>

        <div class="glass p-8 rounded-[40px]">
            <canvas id="chartPG" height="100"></canvas>
        </div>
    </section>

</main>

<nav class="nav-nexus">
    <div onclick="switchSec('patio', this)" class="nav-item active"><i class="fas fa-truck-monster"></i>Patio</div>
    <div onclick="switchSec('dash', this)" class="nav-item"><i class="fas fa-chart-line"></i>Dashboard</div>
    <div onclick="switchSec('caja', this)" class="nav-item"><i class="fas fa-vault"></i>Caja</div>
    <div onclick="switchSec('stock', this)" class="nav-item"><i class="fas fa-boxes-stacked"></i>Stock</div>
</nav>

<div id="modal-orden" class="fixed inset-0 bg-black/95 z-[6000] hidden overflow-y-auto p-4 backdrop-blur-3xl">
    <div class="max-w-6xl mx-auto py-10">
        <div class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-6">
                <div id="mod-flota-icon" class="w-20 h-20 rounded-2xl bg-gold flex items-center justify-center text-black text-3xl"></div>
                <div>
                    <h2 id="mod-placa" class="font-nexus text-6xl text-white italic font-black uppercase tracking-tighter">---</h2>
                    <p id="mod-cliente" class="text-[10px] text-gold font-bold tracking-[3px] uppercase mt-2"></p>
                </div>
            </div>
            <button onclick="closeModal()" class="w-14 h-14 bg-white/10 rounded-full text-3xl text-white">&times;</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="glass p-8 rounded-[35px] border-l-4 border-accent">
                    <h4 class="text-[10px] font-black text-accent uppercase mb-6 tracking-widest">Alimentación de Insumos y Mano de Obra</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="g-desc" placeholder="Descripción Trabajo / Repuesto" class="neo-input uppercase md:col-span-1">
                        <input id="g-costo" type="number" placeholder="Costo Compra ($)" class="neo-input">
                        <input id="g-venta" type="number" placeholder="Precio Venta ($)" class="neo-input text-emerald-400 font-bold">
                    </div>
                    <div class="flex gap-4 mt-4">
                        <select id="g-actor" class="neo-input md:w-1/3 text-[10px] font-bold">
                            <option value="MECANICO">MECÁNICO LÍDER</option>
                            <option value="LATONERO">LATONERÍA/PINTURA</option>
                            <option value="ELECTRICO">ELECTRÓNICA</option>
                        </select>
                        <button onclick="addItem()" class="grow bg-accent text-white rounded-xl font-black text-[10px] uppercase">Vincular a Misión</button>
                    </div>
                </div>

                <div class="glass p-8 rounded-[35px] min-h-[400px]">
                    <div id="mod-items" class="space-y-4"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass p-8 rounded-[35px] bg-gradient-to-b from-white/5 to-transparent border border-white/10">
                    <h4 class="text-[10px] font-black text-gold uppercase text-center mb-8 tracking-widest">Pasarela de Recaudo</h4>
                    
                    <div class="space-y-6">
                        <div class="flex justify-between items-center text-[11px] font-bold border-b border-white/5 pb-4">
                            <span class="text-slate-500 uppercase">Subtotal:</span>
                            <span id="liq-sub" class="text-white">$ 0</span>
                        </div>
                        <div class="flex justify-between items-center text-[11px] font-bold border-b border-white/5 pb-4">
                            <span class="text-slate-500 uppercase">IVA Liquidado:</span>
                            <span id="liq-iva" class="text-white">$ 0</span>
                        </div>
                        <div class="text-center py-4">
                            <p class="text-[9px] text-slate-500 font-black uppercase mb-2">Total a Cobrar</p>
                            <h2 id="liq-total" class="font-nexus text-5xl text-white font-black">$ 0</h2>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="pagoLocal('NEQUI')" class="p-4 bg-fuchsia-600 rounded-xl text-[9px] font-black uppercase text-white">Nequi QR</button>
                            <button onclick="pagoLocal('PSE')" class="p-4 bg-blue-600 rounded-xl text-[9px] font-black uppercase text-white">PSE / Link</button>
                        </div>
                        
                        <button onclick="generarFacturaPDF()" class="w-full py-4 border border-white/20 rounded-xl text-[9px] font-black uppercase text-white hover:bg-white hover:text-black transition-all">
                            <i class="fas fa-file-pdf mr-2"></i> Certificado de Servicio (PDF)
                        </button>
                        
                        <button onclick="finalizarOrden()" class="w-full py-5 bg-emerald-500 text-black font-black rounded-2xl text-[10px] uppercase tracking-widest shadow-lg">Finalizar y Archivar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, serverTimestamp, orderBy, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Mantenemos tu config de Firebase que ya funciona perfectamente
    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let misiones = [];
    let currentId = null;
    let currentFlota = 'CAMION';
    let configLocal = { nombre: "Mi Taller Pro", nit: "000", iva: 19 };

    // --- LOGICA DE VOZ (MEJORADA) ---
    const recognition = window.webkitSpeechRecognition ? new webkitSpeechRecognition() : null;
    if(recognition) {
        recognition.lang = 'es-CO';
        recognition.continuous = false;
        recognition.interimResults = false;
    }

    window.startNexusVoice = (id) => {
        const input = document.getElementById(id);
        recognition.onstart = () => input.classList.add('recording');
        recognition.onresult = (e) => {
            let text = e.results[0][0].transcript.toUpperCase();
            input.value = (id === 'in-placa') ? text.replace(/\s/g, '') : text;
        };
        recognition.onend = () => input.classList.remove('recording');
        recognition.start();
    };

    // --- SESSION & SYNC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loader').style.display = 'none';
            loadLocalConfig();
            initDataSync();
        } else {
            window.location.href = "index.html"; 
        }
    });

    function initDataSync() {
        const q = query(collection(db, "ordenes"), where("tallerId", "==", auth.currentUser.uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            misiones = [];
            let profit = 0;
            snap.forEach(d => {
                const data = {id: d.id, ...d.data()};
                misiones.push(data);
                if(data.status === 'ARCHIVADO') profit += (data.utilidad || 0);
            });
            renderPatio();
            updateDashboard(profit);
            if(currentId) renderModItems();
        });
    }

    // --- ALGORITMOS DE NEGOCIO ---
    window.setFlota = (f, el) => {
        currentFlota = f;
        document.querySelectorAll('.flota-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    };

    window.registrarMision = async () => {
        const p = document.getElementById('in-placa').value;
        if(!p) return alert("Ingrese placa");
        
        await addDoc(collection(db, "ordenes"), {
            tallerId: auth.currentUser.uid,
            placa: p.toUpperCase(),
            flota: currentFlota,
            cliente: document.getElementById('in-cliente').value.toUpperCase(),
            telefono: document.getElementById('in-tel').value,
            fechaIn: document.getElementById('in-fecha-in').value,
            fechaOutEst: document.getElementById('in-fecha-out').value,
            status: 'PATIO',
            items: [],
            timestamp: serverTimestamp()
        });
        alert("MISIÓN INICIALIZADA");
    };

    window.addItem = async () => {
        const desc = document.getElementById('g-desc').value.toUpperCase();
        const venta = parseFloat(document.getElementById('g-venta').value) || 0;
        const costo = parseFloat(document.getElementById('g-costo').value) || 0;
        const actor = document.getElementById('g-actor').value;

        if(!desc || !venta) return;

        await updateDoc(doc(db, "ordenes", currentId), {
            items: arrayUnion({ desc, venta, costo, actor, id: Date.now() })
        });
        document.getElementById('g-desc').value = "";
        document.getElementById('g-venta').value = "";
        document.getElementById('g-costo').value = "";
    };

    function updateCalculosMod(orden) {
        const sub = (orden.items || []).reduce((a, b) => a + b.venta, 0);
        const iva = sub * (configLocal.iva / 100);
        const total = sub + iva;

        document.getElementById('liq-sub').innerText = `$ ${sub.toLocaleString()}`;
        document.getElementById('liq-iva').innerText = `$ ${iva.toLocaleString()}`;
        document.getElementById('liq-total').innerText = `$ ${total.toLocaleString()}`;
    }

    // --- DASHBOARD P&G ---
    function updateDashboard(totalProfit) {
        document.getElementById('total-pg').innerText = `$ ${totalProfit.toLocaleString()}`;
        document.getElementById('dash-utilidad').innerText = `$ ${totalProfit.toLocaleString()}`;
        document.getElementById('dash-activas').innerText = misiones.filter(m => m.status !== 'ARCHIVADO').length;
    }

    // --- PDF & REPORTES ---
    window.generarFacturaPDF = () => {
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        const o = misiones.find(x => x.id === currentId);
        
        docPDF.setFontSize(20);
        docPDF.text(configLocal.nombre, 20, 20);
        docPDF.setFontSize(10);
        docPDF.text(`NIT: ${configLocal.nit}`, 20, 28);
        docPDF.text(`CERTIFICADO DE SERVICIO: ${o.placa}`, 20, 40);
        
        let y = 50;
        o.items.forEach(i => {
            docPDF.text(`${i.desc} - $${i.venta.toLocaleString()}`, 20, y);
            y += 10;
        });
        
        docPDF.save(`TallerPro360_${o.placa}.pdf`);
    };

    // --- UI HELPERS ---
    window.switchSec = (s, el) => {
        document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
        document.getElementById('sec-' + s).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    };

    window.toggleSidebar = () => document.getElementById('sidebar-owner').classList.toggle('open');

    window.abrirOrden = (id) => {
        currentId = id;
        const o = misiones.find(x => x.id === id);
        document.getElementById('mod-placa').innerText = o.placa;
        document.getElementById('mod-cliente').innerText = `${o.cliente} | ${o.flota}`;
        
        const icons = { CAMION: 'fa-truck-moving', AUTO: 'fa-car', MOTO: 'fa-motorcycle', MAQ: 'fa-tractor', VAN: 'fa-shuttle-van' };
        document.getElementById('mod-flota-icon').innerHTML = `<i class="fas ${icons[o.flota]}"></i>`;
        
        renderModItems();
        document.getElementById('modal-orden').classList.remove('hidden');
    };

    function renderModItems() {
        const o = misiones.find(x => x.id === currentId);
        if(!o) return;
        const container = document.getElementById('mod-items');
        container.innerHTML = (o.items || []).map(i => `
            <div class="flex justify-between items-center p-5 bg-white/5 rounded-2xl border border-white/5">
                <div>
                    <p class="text-[11px] font-black uppercase text-white">${i.desc}</p>
                    <p class="text-[8px] text-slate-500 font-bold uppercase">${i.actor}</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="font-nexus text-emerald-400 font-bold">$ ${i.venta.toLocaleString()}</span>
                    <button onclick="removeItem(${i.id})" class="text-danger/50 hover:text-danger"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join("");
        updateCalculosMod(o);
    }

    window.closeModal = () => {
        document.getElementById('modal-orden').classList.add('hidden');
        currentId = null;
    };

    function renderPatio() {
        const container = document.getElementById('lista-misiones');
        container.innerHTML = misiones.filter(m => m.status !== 'ARCHIVADO').map(o => `
            <div onclick="abrirOrden('${o.id}')" class="glass p-6 rounded-[30px] border-l-4 border-gold cursor-pointer hover:scale-105 transition-all">
                <div class="flex justify-between items-center">
                    <h3 class="font-nexus text-2xl text-white italic">${o.placa}</h3>
                    <span class="text-[8px] px-2 py-1 bg-white/5 rounded-lg font-black uppercase">${o.flota}</span>
                </div>
                <p class="text-[9px] text-slate-500 font-bold mt-2 uppercase tracking-widest">${o.cliente}</p>
            </div>
        `).join("");
    }

    window.saveLocalConfig = () => {
        configLocal = {
            nombre: document.getElementById('cfg-nombre').value,
            nit: document.getElementById('cfg-nit').value,
            iva: parseFloat(document.getElementById('cfg-iva').value) || 0,
            nequi: document.getElementById('cfg-nequi').value,
            pse: document.getElementById('cfg-pse').value
        };
        localStorage.setItem('t360_config', JSON.stringify(configLocal));
        document.getElementById('header-name').innerText = configLocal.nombre || "TallerPro360";
    };

    function loadLocalConfig() {
        const saved = localStorage.getItem('t360_config');
        if(saved) {
            configLocal = JSON.parse(saved);
            document.getElementById('cfg-nombre').value = configLocal.nombre;
            document.getElementById('cfg-nit').value = configLocal.nit;
            document.getElementById('cfg-iva').value = configLocal.iva;
            document.getElementById('cfg-nequi').value = configLocal.nequi;
            document.getElementById('cfg-pse').value = configLocal.pse;
            document.getElementById('header-name').innerText = configLocal.nombre || "TallerPro360";
        }
    }

</script>
</body>
</html>
