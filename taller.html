<script type="module">
import { speakOrderStage, initVoiceActivation, listenOrderVoice } from './serviceOrders.voice.js';

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

// ðŸ”¥ ID del taller (SaaS multiempresa)
const TALLER_ID = "demo";

initVoiceActivation();

let userCliente = null;

// ===============================
// ðŸ” OBSERVADOR DE SESIÃ“N
// ===============================
auth.onAuthStateChanged(async (user) => {
  if (user) {
    userCliente = user;

    document.getElementById("loginCliente").style.display = "none";
    document.getElementById("registroCliente").style.display = "none";
    document.getElementById("crearOrden").style.display = "block";

    cargarOrdenes();
  }
});

// ===============================
// ðŸ“ REGISTRO CLIENTE (SaaS)
// ===============================
document.getElementById("formCliente").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const email = clienteEmailReg.value.trim();
  const pass = clientePasswordReg.value;
  const nombre = clienteNombreReg.value.trim();
  const telefono = clienteTelefonoReg.value.trim();

  try {

    const cred = await auth.createUserWithEmailAndPassword(email, pass);

    await db.collection("talleres")
      .doc(TALLER_ID)
      .collection("clientes")
      .doc(cred.user.uid)
      .set({
        nombre,
        telefono,
        email,
        tallerId: TALLER_ID,
        creadoEn: firebase.firestore.Timestamp.now()
      });

    alert("Cliente registrado correctamente. Ahora inicia sesiÃ³n.");
    formCliente.reset();

  } catch(err){
    alert(err.message);
  }
});

// ===============================
// ðŸ”‘ LOGIN CLIENTE
// ===============================
document.getElementById("formLogin").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const email = clienteEmailLogin.value.trim();
  const pass = clientePasswordLogin.value;

  try {
    await auth.signInWithEmailAndPassword(email, pass);
    alert("Ingreso exitoso!");
  } catch(err){
    alert(err.message);
  }
});

// ===============================
// ðŸš— CREAR ORDEN (SaaS)
// ===============================
document.getElementById("formOrden").addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!userCliente) return alert("Debes iniciar sesiÃ³n primero.");

  const codigo = `TP360-${Date.now()}`;
  const ts = firebase.firestore.Timestamp.now();

  const orden = {
    codigo,
    clienteId: userCliente.uid,
    vehiculo: vehiculo.value.trim(),
    placa: placa.value.trim().toUpperCase(),
    estado: "INGRESO",
    timeline: [{estado:"INGRESO", fecha:ts}],
    creadoEn: ts,
    actualizadoEn: ts
  };

  await db.collection("talleres")
    .doc(TALLER_ID)
    .collection("ordenes")
    .doc(codigo)
    .set(orden);

  alert("Orden creada correctamente!");
  formOrden.reset();

  speakOrderStage(orden);
  listenOrderVoice(db, `talleres/${TALLER_ID}/ordenes/${codigo}`);

  cargarOrdenes();
});

// ===============================
// ðŸ“‹ LISTAR Ã“RDENES DEL CLIENTE
// ===============================
async function cargarOrdenes(){

  if(!userCliente) return;

  const snap = await db.collection("talleres")
    .doc(TALLER_ID)
    .collection("ordenes")
    .where("clienteId","==",userCliente.uid)
    .orderBy("actualizadoEn","desc")
    .get();

  const ul = document.getElementById("ordenesUl");
  ul.innerHTML="";

  snap.forEach(doc=>{
    const o = doc.data();

    const li = document.createElement("li");
    li.className="list-group-item";

    li.innerHTML=`
      <strong>${o.codigo}</strong> - ${o.vehiculo} (${o.placa})
      <span class="badge bg-info ms-2">${o.estado}</span>
      <br>
      Timeline: ${o.timeline.map(t=>t.estado).join(" â†’ ")}
    `;

    ul.appendChild(li);

    speakOrderStage(o);
    listenOrderVoice(db, `talleres/${TALLER_ID}/ordenes/${o.codigo}`);
  });

  document.getElementById("ordenesList")
    .classList.toggle("d-none", !ul.children.length);
}
</script>