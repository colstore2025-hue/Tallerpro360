<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NEXUS-X | STARLINK ERP COMMANDER</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #020617; --accent: #3b82f6; --gold: #f59e0b; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--primary); color: #f1f5f9; overflow-x: hidden; }
        .font-nexus { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .neo-input { background: rgba(0,0,0,0.4); border: 1px solid #1e293b; border-radius: 12px; padding: 12px; color: white; width: 100%; outline: none; transition: 0.3s; }
        .neo-input:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }
        .btn-gold { background: linear-gradient(135deg, #f59e0b, #9a3412); color: black; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        .tab-active { color: var(--gold); border-bottom: 3px solid var(--gold); }
        .hidden { display: none !important; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        .recording { animation: pulse-gold 1s infinite; border: 2px solid var(--danger) !important; }
    </style>
</head>
<body class="pb-24">

<header class="p-4 glass sticky top-0 z-[1000] border-b border-white/10 flex justify-between items-center">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gold rounded-lg flex items-center justify-center text-black font-black italic">NX</div>
        <div>
            <h1 class="font-nexus text-[10px] tracking-widest text-white uppercase">Nexus-X Starlink</h1>
            <p id="live-clock" class="text-[9px] text-gold font-black uppercase tracking-tighter">Sincronizando...</p>
        </div>
    </div>
    <div class="flex gap-4">
        <div class="text-right">
            <p class="text-[8px] text-slate-500 font-bold">P&G ESTIMADO (MES)</p>
            <p id="pg-mes" class="text-sm font-nexus text-success font-black">$ 0</p>
        </div>
        <div class="text-right border-l border-white/10 pl-4">
            <p class="text-[8px] text-slate-500 font-bold">NMINA PENDIENTE</p>
            <p id="nomina-mes" class="text-sm font-nexus text-danger font-black">$ 0</p>
        </div>
    </div>
</header>

<main class="p-4 max-w-5xl mx-auto space-y-6">

    <section id="view-patio" class="space-y-4">
        <div class="glass p-6 rounded-[32px] border-l-4 border-accent">
            <h2 class="font-nexus text-[10px] text-accent tracking-[3px] uppercase mb-4">Nueva Misi贸n / Check-In</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <input id="in-placa" placeholder="PLACA" class="neo-input font-nexus text-2xl text-gold uppercase text-center col-span-1">
                <input id="in-km" type="number" placeholder="KM" class="neo-input text-xs">
                <input id="in-cliente" placeholder="CLIENTE" class="neo-input text-xs uppercase col-span-2">
                <input id="in-mecanico" placeholder="MECNICO RESPONSABLE" class="neo-input text-xs uppercase col-span-2">
                <input id="in-tel" type="tel" placeholder="WHATSAPP" class="neo-input text-xs col-span-2">
            </div>
            <div class="relative mt-4">
                <textarea id="in-reporte" rows="3" placeholder="Diga: 'Falla: Ruido en motor. Inventario: Gato, Llantas...'" class="neo-input text-sm"></textarea>
                <button onclick="startVoice()" id="btn-voice" class="absolute right-3 bottom-3 w-12 h-12 bg-accent rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-microphone text-xl text-white"></i>
                </button>
            </div>
            <button onclick="registrarEntrada()" class="w-full mt-4 btn-gold py-4 rounded-2xl text-[11px]">Desplegar Misi贸n a la Red</button>
        </div>

        <div id="feed-ordenes" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>
    </section>

    <section id="view-reportes" class="hidden space-y-4">
        <div class="glass p-6 rounded-[32px]">
            <h2 class="font-nexus text-center text-xs text-gold uppercase tracking-[4px]">Balance General de Operaciones</h2>
            <div id="historial-list" class="mt-6 space-y-2"></div>
        </div>
    </section>

</main>

<div id="modal-master" class="fixed inset-0 bg-black/95 z-[5000] hidden overflow-y-auto p-4 sm:p-10">
    <div class="max-w-4xl mx-auto glass rounded-[40px] p-8 border border-white/10">
        <div class="flex justify-between items-start mb-8">
            <div>
                <span id="mod-status" class="bg-accent text-[9px] px-3 py-1 rounded-full font-black italic">PATIO</span>
                <h3 id="mod-placa" class="font-nexus text-5xl text-white mt-2 tracking-tighter">ABC-123</h3>
                <p id="mod-meta" class="text-[10px] text-slate-500 font-bold uppercase"></p>
            </div>
            <button onclick="closeModal()" class="w-12 h-12 bg-white/5 rounded-full text-3xl">&times;</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div class="bg-white/5 p-5 rounded-3xl border border-white/5">
                    <h4 class="text-[9px] font-black text-gold uppercase mb-4 tracking-widest">Registrar Repuesto / Insumo</h4>
                    <div class="space-y-2">
                        <input id="m-desc" placeholder="Descripci贸n del Item" class="neo-input text-xs uppercase">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[8px] text-slate-500 font-bold ml-1 uppercase">Costo (Lo que pagu茅)</label>
                                <input id="m-costo" type="number" placeholder="$ 0" class="neo-input text-sm text-white">
                            </div>
                            <div>
                                <label class="text-[8px] text-slate-500 font-bold ml-1 uppercase">Venta (Lo que cobro)</label>
                                <input id="m-venta" type="number" placeholder="$ 0" class="neo-input text-sm text-success font-bold">
                            </div>
                        </div>
                        <button onclick="addGasto()" class="w-full bg-white/10 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-white/20">A帽adir a la Cuenta</button>
                    </div>
                </div>
                <div id="mod-lista-gastos" class="max-h-40 overflow-y-auto space-y-2 pr-2"></div>
            </div>

            <div class="space-y-4">
                <div class="bg-black/60 p-6 rounded-[32px] border border-gold/20 relative overflow-hidden">
                    <h4 class="text-[9px] font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Cierre de Misi贸n y N贸mina</h4>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Mano de Obra (Al Cliente)</span>
                            <input id="m-mo-cliente" type="number" class="w-32 bg-transparent text-right font-nexus text-xl outline-none" placeholder="$ 0">
                        </div>
                        <div class="flex justify-between items-center text-gold">
                            <span class="text-[10px] font-bold uppercase">Pago Mec谩nico (Valor Fijo)</span>
                            <input id="m-mo-mecanico" type="number" class="w-32 bg-transparent text-right font-nexus text-xl outline-none border-b border-gold/30" placeholder="$ 0">
                        </div>
                        <hr class="border-white/5">
                        <div class="flex justify-between items-end pt-2">
                            <div>
                                <p class="text-[8px] text-slate-500 font-black">UTILIDAD ESTIMADA</p>
                                <h2 id="mod-utilidad" class="text-3xl font-nexus text-success font-black">$ 0</h2>
                            </div>
                            <div class="text-right">
                                <p class="text-[8px] text-slate-500 font-black uppercase tracking-widest">Total Factura</p>
                                <h3 id="mod-total-venta" class="text-xl font-nexus">$ 0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="shareWA()" class="bg-emerald-600 py-4 rounded-2xl text-[10px] font-black uppercase"><i class="fab fa-whatsapp text-lg mr-2"></i> Reportar</button>
                    <button onclick="finalizarMision()" class="bg-white text-black py-4 rounded-2xl text-[10px] font-black uppercase">Finalizar Obra</button>
                </div>
            </div>
        </div>
    </div>
</div>

<nav class="fixed bottom-4 left-4 right-4 h-20 glass rounded-[24px] border border-white/10 flex justify-around items-center z-[4000]">
    <div onclick="switchTab('patio')" class="flex flex-col items-center gap-1 tab-active cursor-pointer">
        <i class="fas fa-garage text-xl"></i>
        <span class="text-[9px] font-black uppercase">Patio Activo</span>
    </div>
    <div onclick="switchTab('reportes')" class="flex flex-col items-center gap-1 text-slate-500 cursor-pointer">
        <i class="fas fa-chart-line text-xl"></i>
        <span class="text-[9px] font-black uppercase">P&G General</span>
    </div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, serverTimestamp, getDoc, orderBy, deleteDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
        authDomain: "tallerpro360.firebaseapp.com",
        projectId: "tallerpro360",
        storageBucket: "tallerpro360.appspot.com",
        messagingSenderId: "636224778184",
        appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let misiones = [];
    let currentId = null;
    let recognition;

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        startSync();
    });

    // --- MOTOR DE SINCRONIZACIN (EL CEREBRO ERP) ---
    function startSync() {
        const q = query(collection(db, "ordenes"), where("tallerId", "==", auth.currentUser.uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            misiones = [];
            let utilidadMes = 0;
            let nominaMes = 0;
            const feed = document.getElementById('feed-ordenes');
            feed.innerHTML = "";

            snap.forEach(d => {
                const o = {id: d.id, ...d.data()};
                misiones.push(o);

                if (o.status !== 'ARCHIVADO') {
                    feed.innerHTML += `
                        <div class="glass p-5 rounded-[28px] border-b-4 border-accent flex justify-between items-center shadow-2xl">
                            <div onclick="openModal('${o.id}')" class="cursor-pointer">
                                <h3 class="font-nexus text-2xl text-white tracking-tighter">${o.placa}</h3>
                                <p class="text-[9px] text-slate-500 font-black uppercase">${o.mecanico} | ${o.cliente}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] text-slate-500 font-bold">TOTAL CUENTA</p>
                                <p class="font-nexus text-gold">$ ${calcVenta(o).toLocaleString()}</p>
                            </div>
                        </div>`;
                } else {
                    utilidadMes += (o.utilidad || 0);
                    nominaMes += (o.pagoMecanico || 0);
                }
            });
            document.getElementById('pg-mes').innerText = `$ ${utilidadMes.toLocaleString()}`;
            document.getElementById('nomina-mes').innerText = `$ ${nominaMes.toLocaleString()}`;
        });
    }

    // --- OPERACIONES ---
    window.registrarEntrada = async () => {
        const placa = document.getElementById('in-placa').value.toUpperCase();
        if(!placa) return alert("SISTEMA REQUIERE PLACA");

        await addDoc(collection(db, "ordenes"), {
            tallerId: auth.currentUser.uid,
            placa,
            km: document.getElementById('in-km').value,
            cliente: document.getElementById('in-cliente').value.toUpperCase(),
            mecanico: document.getElementById('in-mecanico').value.toUpperCase(),
            telefono: document.getElementById('in-tel').value,
            reporte: document.getElementById('in-reporte').value,
            status: 'PATIO',
            gastos: [],
            timestamp: serverTimestamp()
        });
        document.querySelectorAll('.neo-input').forEach(i => i.value = "");
    };

    window.openModal = (id) => {
        currentId = id;
        const o = misiones.find(x => x.id === id);
        document.getElementById('mod-placa').innerText = o.placa;
        document.getElementById('mod-meta').innerText = `${o.cliente} | RESPONSABLE: ${o.mecanico}`;
        renderGastos(o);
        document.getElementById('modal-master').classList.remove('hidden');
    };

    function renderGastos(o) {
        const lista = document.getElementById('mod-lista-gastos');
        lista.innerHTML = "";
        let costoTotal = 0;
        let ventaTotal = 0;

        o.gastos.forEach(g => {
            costoTotal += g.costo;
            ventaTotal += g.venta;
            lista.innerHTML += `
                <div class="flex justify-between text-[10px] bg-white/5 p-2 rounded-lg">
                    <span class="uppercase">${g.desc}</span>
                    <span class="font-nexus text-success">$ ${g.venta.toLocaleString()}</span>
                </div>`;
        });

        const moCliente = parseFloat(document.getElementById('m-mo-cliente').value) || 0;
        const moMeca = parseFloat(document.getElementById('m-mo-mecanico').value) || 0;
        
        const totalFactura = ventaTotal + moCliente;
        const utilidad = (ventaTotal - costoTotal) + (moCliente - moMeca);

        document.getElementById('mod-total-venta').innerText = `$ ${totalFactura.toLocaleString()}`;
        document.getElementById('mod-utilidad').innerText = `$ ${utilidad.toLocaleString()}`;
    }

    window.addGasto = async () => {
        const desc = document.getElementById('m-desc').value.toUpperCase();
        const costo = parseFloat(document.getElementById('m-costo').value) || 0;
        const venta = parseFloat(document.getElementById('m-venta').value) || 0;

        await updateDoc(doc(db, "ordenes", currentId), {
            gastos: arrayUnion({ desc, costo, venta, fecha: new Date().toISOString() })
        });
        
        document.getElementById('m-desc').value = "";
        document.getElementById('m-costo').value = "";
        document.getElementById('m-venta').value = "";
        const o = misiones.find(x => x.id === currentId);
        renderGastos(o);
    };

    window.finalizarMision = async () => {
        const o = misiones.find(x => x.id === currentId);
        const moCliente = parseFloat(document.getElementById('m-mo-cliente').value) || 0;
        const moMeca = parseFloat(document.getElementById('m-mo-mecanico').value) || 0;
        
        let costoRep = o.gastos.reduce((acc, g) => acc + g.costo, 0);
        let ventaRep = o.gastos.reduce((acc, g) => acc + g.venta, 0);
        let utilidadFinal = (ventaRep - costoRep) + (moCliente - moMeca);

        if(confirm(`驴Cerrar Misi贸n? Utilidad: $${utilidadFinal.toLocaleString()}`)){
            await updateDoc(doc(db, "ordenes", currentId), {
                status: 'ARCHIVADO',
                pagoMecanico: moMeca,
                cobroMO: moCliente,
                utilidad: utilidadFinal,
                fechaCierre: serverTimestamp()
            });
            closeModal();
        }
    };

    // --- RECONOCIMIENTO DE VOZ ---
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'es-CO';
        recognition.onresult = (e) => {
            document.getElementById('in-reporte').value += e.results[0][0].transcript;
            document.getElementById('btn-voice').classList.remove('recording');
        };
    }

    window.startVoice = () => {
        recognition.start();
        document.getElementById('btn-voice').classList.add('recording');
    };

    // --- HELPERS ---
    function calcVenta(o) { return o.gastos.reduce((acc, g) => acc + g.venta, 0); }
    window.closeModal = () => document.getElementById('modal-master').classList.add('hidden');
    window.switchTab = (tab) => {
        document.getElementById('view-patio').classList.toggle('hidden', tab !== 'patio');
        document.getElementById('view-reportes').classList.toggle('hidden', tab !== 'reportes');
    };
    window.shareWA = () => {
        const o = misiones.find(x => x.id === currentId);
        const msg = `* NEXUS-X STARLINK REPORT*%0A*UNIDAD:* ${o.placa}%0A*ESTADO:* FINALIZADO%0A*TOTAL A PAGAR:* ${document.getElementById('mod-total-venta').innerText}`;
        window.open(`https://wa.me/${o.telefono}?text=${msg}`);
    };
    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString(); }, 1000);

</script>
</body>
</html>
