<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TallerPRO360 - Reportes Avanzados</title>
<link rel="icon" href="logo-tallerpro360.png">

<!-- Tailwind + Icons + Charts + XLSX + jsPDF -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
body{background:#0f172a;color:#f1f5f9;font-family:'Inter',sans-serif;}
.font-nexus{font-family:'Orbitron',sans-serif;}
.glass{background:rgba(15,23,42,.7);backdrop-filter:blur(20px);border-radius:1.5rem;border:1px solid rgba(255,255,255,.05);padding:1rem;}
.status-activo{color:#10b981;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;}
button.excel-btn, button.pdf-btn{background:#3b82f6;color:white;font-weight:bold;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;margin-left:5px;}
</style>
</head>

<body class="p-6">

<header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
  <h1 class="text-3xl font-nexus font-black text-amber-500">
    TallerPRO360 <span class="text-white text-lg md:text-2xl">Reportes Avanzados</span>
  </h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded font-bold hover:bg-red-700 transition">
    <i class="fas fa-power-off"></i> Salir
  </button>
</header>

<!-- Selector de fechas -->
<section class="glass mb-8 flex gap-4 flex-wrap">
  <div>
    <label class="text-gray-400">Fecha inicio</label>
    <input type="date" id="fechaInicio" class="p-2 rounded text-black">
  </div>
  <div>
    <label class="text-gray-400">Fecha fin</label>
    <input type="date" id="fechaFin" class="p-2 rounded text-black">
  </div>
  <button class="excel-btn" onclick="filtrarReporte()">Filtrar</button>
</section>

<!-- KPIs -->
<section class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8" id="kpiContainer"></section>

<!-- Gráficos -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
  <div class="glass p-6">
    <canvas id="chartIngresos"></canvas>
  </div>
  <div class="glass p-6">
    <canvas id="chartClientes"></canvas>
  </div>
</section>

<!-- Tabla de órdenes -->
<section class="glass p-6 mb-8">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-lg font-bold">Órdenes</h2>
    <div>
      <button class="excel-btn" onclick="exportExcel('tablaOrdenes','Ordenes.xlsx')">Exportar Excel</button>
      <button class="pdf-btn" onclick="exportPDF('tablaOrdenes','Ordenes.pdf')">Exportar PDF</button>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="tablaOrdenes">
      <thead class="text-gray-400 uppercase text-xs">
        <tr>
          <th class="p-2 text-left">Código</th>
          <th class="p-2 text-left">Cliente</th>
          <th class="p-2 text-left">Vehículo</th>
          <th class="p-2 text-left">Estado</th>
          <th class="p-2 text-left">Fecha</th>
          <th class="p-2 text-left">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<footer class="text-center text-xs text-gray-500 mt-8">
© 2026 TallerPRO360 · Reportes Avanzados
</footer>

<!-- Firebase + Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

const firebaseConfig = {
  apiKey: "AIzaSyAdk-s-OXu57MiobzRGBRu-TlF2KYeicWQ",
  authDomain: "tallerpro360.firebaseapp.com",
  projectId: "tallerpro360",
  storageBucket: "tallerpro360.appspot.com",
  messagingSenderId: "636224778184",
  appId: "1:636224778184:web:9bd7351b6458a1ef625afd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let chartIngresos, chartClientes;

onAuthStateChanged(auth,user=>{
  if(!user) location.href="index.html";
  filtrarReporte(); // Carga inicial
});

function filtrarReporte(){
  const inicio = document.getElementById("fechaInicio").value;
  const fin = document.getElementById("fechaFin").value;
  if(!inicio || !fin) return alert("Selecciona rango de fechas");

  const fechaInicio = new Date(inicio+"T00:00:00");
  const fechaFin = new Date(fin+"T23:59:59");

  const q = query(collection(db,"ordenes"),
    where("actualizadoEn",">=",fechaInicio),
    where("actualizadoEn","<=",fechaFin),
    orderBy("actualizadoEn","desc")
  );

  onSnapshot(q,snap=>{
    actualizarKPIs(snap);
    renderTabla(snap);
    renderGraficos(snap);
  });
}

// KPIs
function actualizarKPIs(snap){
  const total = snap.size;
  let activas=0, clientesSet=new Set(), ingresos=0, egresos=0;
  snap.forEach(doc=>{
    const o=doc.data();
    if(o.estado!=="ENTREGADO") activas++;
    clientesSet.add(o.cliente?.nombre||"");
    ingresos += o.total||0;
    egresos += o.costoRepuestos||0;
  });

  const kpiHTML = `
    <div class="glass text-center"><p class="text-xs uppercase text-gray-400">Órdenes Totales</p><h2 class="text-3xl font-nexus text-amber-500">${total}</h2></div>
    <div class="glass text-center"><p class="text-xs uppercase text-gray-400">Órdenes Activas</p><h2 class="text-3xl font-nexus text-green-500">${activas}</h2></div>
    <div class="glass text-center"><p class="text-xs uppercase text-gray-400">Clientes Únicos</p><h2 class="text-3xl font-nexus text-blue-500">${clientesSet.size}</h2></div>
    <div class="glass text-center"><p class="text-xs uppercase text-gray-400">Ingresos</p><h2 class="text-3xl font-nexus text-green-400">${ingresos.toLocaleString()}</h2></div>
    <div class="glass text-center"><p class="text-xs uppercase text-gray-400">Utilidad</p><h2 class="text-3xl font-nexus text-yellow-400">${(ingresos-egresos).toLocaleString()}</h2></div>
  `;
  document.getElementById("kpiContainer").innerHTML = kpiHTML;
}

// Tabla
function renderTabla(snap){
  const tbody = document.querySelector("#tablaOrdenes tbody");
  tbody.innerHTML="";
  snap.forEach(doc=>{
    const o = doc.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="p-2">${o.codigo}</td>
      <td class="p-2">${o.cliente?.nombre||"N/A"}</td>
      <td class="p-2">${o.vehiculo||"N/A"}</td>
      <td class="p-2"><span class="status-${o.estado==="ENTREGADO"?"activo":"activo"}">${o.estado}</span></td>
      <td class="p-2">${o.actualizadoEn?.toDate().toLocaleString()||"-"}</td>
      <td class="p-2">${o.total?.toLocaleString()||0}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Gráficos
function renderGraficos(snap){
  const ingresosData=[], clientesData={};
  snap.forEach(doc=>{
    const o = doc.data();
    ingresosData.push({x:o.actualizadoEn?.toDate(),y:o.total||0});
    const cliente = o.cliente?.nombre||"N/A";
    clientesData[cliente] = (clientesData[cliente]||0)+1;
  });

  const ctxI = document.getElementById("chartIngresos");
  if(chartIngresos) chartIngresos.destroy();
  chartIngresos=new Chart(ctxI,{type:"line",
    data:{
      datasets:[{label:"Ingresos",data:ingresosData,backgroundColor:"rgba(16,185,129,0.2)",borderColor:"#10b981",fill:true}]
    },
    options:{scales:{x:{type:"time",time:{unit:"day"}},y:{beginAtZero:true}}}
  });

  const ctxC = document.getElementById("chartClientes");
  if(chartClientes) chartClientes.destroy();
  chartClientes=new Chart(ctxC,{type:"bar",
    data:{
      labels:Object.keys(clientesData),
      datasets:[{label:"Órdenes por Cliente",data:Object.values(clientesData),backgroundColor:"#3b82f6"}]
    },
    options:{indexAxis:'y',scales:{x:{beginAtZero:true}}}
  });
}

// Exportar Excel
function exportExcel(tableId,fileName){
  const wb = XLSX.utils.table_to_book(document.getElementById(tableId));
  XLSX.writeFile(wb,fileName);
}

// Exportar PDF
async function exportPDF(tableId,fileName){
  const table = document.getElementById(tableId);
  const canvas = await html2canvas(table);
  const imgData = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("l","pt","a4");
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight);
  pdf.save(fileName);
}

// Logout
function logout(){ signOut(auth).then(()=>location.href="index.html"); }
</script>

</body>
</html>